import{getEl,button,input,newEl,isObj,span}from"./ui/common.js";import{showQuestion}from"./showQuestions.js";import{popup}from"./ui/popup.js";import{marked}from"https://cdn.jsdelivr.net/npm/marked/lib/marked.esm.js";import{toast,toastError,toastWarn}from"./ui/toast.js";import styles from"./quizbuilder.css"with{type:"css"};document.adoptedStyleSheets.push(styles);const EDITOR_LANGUAGES=["text/plain","python","javascript","java","clike","application/json","markdown"],ALLOWED_NUMBER_EDITING_KEYS=new Set(["1","2","3","4","5","6","7","8","9","0","ArrowLeft","ArrowRight","Backspace","Delete","Home","End","Enter"]);function codeEditor(e,t,n){return new Promise((i=>{const o={mode:"python",lineNumbers:!0,theme:"default",tabSize:4,smartIndent:!0,insertSoftTab:!0};e.lang&&(o.mode=e.lang,delete e.lang),void 0!==e.lineNumbers&&(o.lineNumbers=e.lineNumbers,delete e.lineNumbers);var s=newEl(Object.assign(e,{tag:"textarea"}),t,n);setTimeout((e=>{s._editor=CodeMirror.fromTextArea(s,o),s._editor.setSize("100%","100%"),i(s)}),100)}))}export function quizBuilder(e,t,n,i,o){console.log(t),e.innerHTML="",n||(n={});const s=e;input({id:"qtitle",htmlBefore:"Exam Title:",class:"bigger",value:t?.title||""},s),input({id:"category",htmlBefore:"Randomize Questions:",type:"checkbox",checked:"ORD"==t?.category?"":"checked"},s),input({id:"select",htmlBefore:"Number of Quiz Questions To Show:",value:t?.select||""},s),newEl({innerText:"Exam Description (markdown; shown prior to exam):"},s);let l=newEl({style:{width:"25em",height:"3.5em",resize:"both",overflow:"auto"}},s);codeEditor({id:"description",value:t?.description||"",lang:"markdown",lineNumbers:!1},l),newEl({innerText:"Exam Instructions (markdown; shown during exam):"},s),l=newEl({style:{width:"25em",height:"6.25em",resize:"both",overflow:"auto"}},s),codeEditor({id:"instructions",value:t?.instructions||"",lang:"markdown",lineNumbers:!1},l),input({id:"R",htmlBefore:"EXAM IS READ ONLY:",type:"checkbox",checked:t?.R?"checked":"",events:{input:n=>{e.className=n.target.checked?"readonly":"qouter",t.R=n.target.checked}}},s),e.className=t?.R?"readonly":"qouter",newEl({tag:"span",style:{display:"block",marginBottom:"2em"}},s);const a=newEl({class:"builder-control-row"},s);function c(e,n,i,o){if(i>=t.questions.length&&(i=t.questions.length-1),i<0&&(i=0),n===i)return;const l=n<i;if(i===t.questions.length-1)s.appendChild(e);else{const n=s.querySelector(`#q${t.questions[i+l].id}`);s.insertBefore(e,n)}t.questions.splice(n,1),t.questions.splice(i,0,o);for(let e=Math.min(n,i);e<=Math.max(n,i);e++){const n=s.querySelector(`#q${t.questions[e].id}`),o=n.querySelector(".builderQuestionNumberInput");o.value=e+1,o.style.width=(e+1).toString().length+1+"ch",e===i&&o.focus(),0===e?n.querySelector(".fa-angle-up").classList.add("transparent"):n.querySelector(".fa-angle-up").classList.remove("transparent"),e===t.questions.length-1?n.querySelector(".fa-angle-down").classList.add("transparent"):n.querySelector(".fa-angle-down").classList.remove("transparent")}e.scrollIntoView({behavior:"smooth",block:"start"})}button({innerHTML:'<i class="icon-btn fa-solid fa-plus"></i> Add Question',onclick:()=>{if(t.R)return void toastWarn("Cannot add question. This exam is marked as read-only.");const e={};let n;const i=new Set(t.questions.map((e=>e.id)));do{n=(1e7*Math.random()).toFixed()}while(i.has(n));e.id=n;const o=popup("New Question","",button({textContent:"Save Question",onclick:()=>{t.R?toastWarn("Cannot save question. This exam is read-only."):getEl("my-form").reportValidity()&&d(e.id)&&o.close()}}),"Cancel",null,{class:"large"});u(e,o.main)}},a),button({innerHTML:'<i class="icon-btn fa-solid fa-save"></i> Save',onclick:()=>{!function(){t.category=getEl("category").checked?"RAND":"ORD",t.select=getEl("select").value,t.title=getEl("qtitle").value,t.questions=t.questions,t.R=getEl("R").checked,t.instructions=getEl("instructions")._editor.getValue(),t.description=getEl("description")._editor.getValue(),i&&i(t,n);localStorage[t.title]=JSON.stringify(t),localStorage[t.title+"answers"]=JSON.stringify(n),console.log("save quiz",t,n)}()}},a),button({innerHTML:'<i class="icon-btn fa-solid fa-door-closed"></i> Exit',onclick:()=>{o&&o()}},a),isObj(t.questions)&&(t.questions=Object.values(t.questions||[]));const r={};function d(s){try{const l={},a=getEl("all-options"),c=t.questions.findIndex((e=>e.id==s));n[s]=[],l.id=s;let r=getEl("categories");return l.category=r.value,l.choices=[],a.querySelectorAll('input[type="number"]').forEach((e=>{l[e.id]=Number(e.value)})),a.querySelectorAll('input:not([type="number"], [type="checkbox"], [type="radio"])').forEach((e=>{e.id&&(l[e.id]=e.value)})),a.querySelectorAll('input[type="text"]').forEach((e=>{l.choices.push(e.value)})),a.querySelectorAll("input.answerChoice").forEach((e=>{console.log(e,e.checked,e.getAttribute("choice")),e.checked&&("MRQ"===r.value?(n[s][0]||(n[s][0]={A:[]}),n[s][0].A.push(e.getAttribute("choice"))):"object"==typeof t.questions[c]?.choices[0]?n[s].push({id:e.getAttribute("_id"),content:e.getAttribute("choice")}):n[s].push(e.getAttribute("choice")))})),a.querySelectorAll("select").forEach((e=>{l[e.id]=e.value})),a.querySelectorAll("textarea").forEach((e=>{let i=e._editor?e._editor.getValue():e.value;if("prompt"==e.id)l[e.id]=i;else if("choice"==e.id)"object"==typeof t.questions[c]?.choices[0]?l.choices.push({id:e.getAttribute("_id"),content:e.value}):l.choices.push(e.value);else if(i&&e.classList.contains("answer-editor"))if("CODE"===r.value)n[s]=JSON.parse(i);else{try{i=JSON.parse(i)}catch(e){}n[s].push(i)}})),a.querySelectorAll('input[type="checkbox"]:not(.answerChoice)').forEach((e=>{l[e.id]=e.checked,"false_check"==e.id&&e.checked&&!n[s].includes(!1)&&n[s].push(!1)})),console.log(n),console.log(l),-1!==c?t.questions[c]=l:t.questions.push(l),t.category=getEl("category").checked?"RAND":"ORD",t.R=getEl("R").checked,t.select=getEl("select").value,t.title=getEl("qtitle").value,t.instructions=getEl("instructions")._editor.getValue(),t.description=getEl("description")._editor.getValue(),quizBuilder(e,t,n,i,o),!0}catch(e){toastError("Error saving question.\n"+e.toString())}}function u(e,t){const n=e?.category||"Choose Category",i=newEl({tag:"form",id:"my-form",className:"container",style:{display:"flex",flexDirection:"column",gap:"8px"}},t);i.classList.add("back","qbuilder"),function(e,t){const n=newEl({tag:"select",id:"categories",events:{change:e=>{p(e.target.value,t,getEl("all-options"))}}},e);["Choose Category","MCQ","MRQ","OEQ","NRQ","CODE","MATCH","PARSONS"].forEach((e=>{newEl({tag:"option",value:e,textContent:e},n)}))}(i,e),getEl("categories").value=n;p(n,e,newEl({innerHTML:"",id:"all-options",style:{display:"flex",flexDirection:"row",gap:"2px",justifyContent:"center"}},i))}function p(e,t,i){if(console.log("q",t),e!=t.category&&(i.innerHTML="",t.category=e),!t.id)return void console.error("No ID found for question.");const o=newEl({className:"qbuilder",style:{display:"flex",flexDirection:"column",gap:"6px",flex:.3}},i),s=newEl({className:"qbuilder",style:{display:"flex",flexDirection:"column",flex:1}},i);if("Choose Category"!==e){const r=newEl({className:"qbuilder gen-div"},o);input({id:"title",htmlBefore:"Title:",value:t?.title||"",placeholder:"Enter your title (Required)",style:{flexGrow:1},required:!0},r);const d=newEl({tag:"span",innerHTML:"Prompt:",style:{display:"flex"}},r);newEl({tag:"textarea",id:"prompt",value:t?.prompt||"",rows:6,placeholder:"Enter your prompt (Required)",style:{flexGrow:1},required:!0},d),input({id:"points",htmlBefore:"Points:",type:"number",value:t?.points||1,style:{flexGrow:1},required:!0},r);const u=newEl({className:"qbuilder options-div"},o);if("MCQ"!=e&&"MRQ"!=e||input({id:"ordered",htmlAfter:"Order Choices",type:"checkbox",checked:t.ordered},u),"PARSONS"==e){var l=newEl({tag:"select",id:"language"},u);input({id:"choice_reuse",htmlAfter:"Reuse Choices",type:"checkbox",checked:t.choice_reuse},u),input({id:"max_levels",htmlBefore:"Max Levels:",type:"number",value:t?.max_levels},u)}if("OEQ"==e||"CODE"==e){if(input({id:"max_lines",htmlBefore:"Max Lines:",min:0,type:"number",value:t?.max_lines||"",placeholder:"No limit",oninput:e=>{"0"===e.target.value&&(e.target.value="")}},u),input({id:"max_length",htmlBefore:"Max Chars:",min:0,type:"number",value:t?.max_length||"",placeholder:"No limit",oninput:e=>{"0"===e.target.value&&(e.target.value="")}},u),"CODE"===e){l=newEl({tag:"select",id:"language"},u);input({id:"run",htmlAfter:"Display Run Button",type:"checkbox",checked:t.run},u),input({id:"await_input",htmlAfter:"Convert `input()` to `await input()`",type:"checkbox",checked:t.await_input??!0},u)}input({id:"case_sensitive",htmlAfter:"Case Sensitive",type:"checkbox",checked:t.case_sensitive},u),input({id:"space_sensitive",htmlAfter:"Space Sensitive",type:"checkbox",checked:t.space_sensitive},u),input({id:"false_check",htmlAfter:"Manual Check If Incorrect",type:"checkbox",checked:t.false_check},u)}newEl({innerText:"Answers"},s);const p=newEl({className:"qbuilder answers-div",style:{display:"flex",flexDirection:"column",gap:".5em"}},s);if("OEQ"==e){function a(e){e.target.value||e.target.remove();p.querySelector("textarea:last-child").value&&c()}function c(e=""){newEl({tag:"textarea",class:"answer-editor",rows:4,cols:50,style:{flexGrow:1},onchange:a,value:e},p)}for(let g of n[t.id]||[])"object"==typeof g&&(g=JSON.stringify(g,null,2)),c(g);c()}if("NRQ"==e&&input({htmlBefore:"Answer:",type:"number",value:n[t.id]||0,style:{flexGrow:1}},p),"MCQ"!=e&&"MRQ"!=e||(p.classList.add("mcq"),newEl({tag:"button",id:"add-option-btn",textContent:"Add Option",events:{click:e=>{localStorage.x="hello",h(null,p,t?.id||""),e.preventDefault()}}},p),t.choices?t.choices?.forEach((e=>{h(e,p,t.id)})):(h(null,p,t?.id),h(null,p,t?.id))),"PARSONS"!=e&&"CODE"!=e||(EDITOR_LANGUAGES.forEach((e=>{newEl({tag:"option",value:e,textContent:e},l)})),l.value=t?.language||"python"),"CODE"==e){codeEditor({class:"answer-editor",lang:"application/json"},newEl({style:{flexDirection:"column",flexGrow:1}},p)).then((e=>{t?.id&&n[t.id]&&e._editor.setValue(JSON.stringify(n[t.id],null,2))}))}if("PARSONS"==e){const m=newEl({style:{display:"flex",flexDirection:"column",flexGrow:.2,alignItems:"center",gap:".5em"}},p),f=[];newEl({tag:"button",id:"add-option-btn",textContent:"Add Distractor",onclick:e=>{h(null,m,t?.id||""),e.preventDefault()}},m);const y=newEl({style:{flexDirection:"column",flexGrow:1}},p);codeEditor({class:"answer-editor",lang:l.value},y).then((e=>{l.addEventListener("change",(()=>{e._editor.setOption("mode",l.value)})),n[t?.id]&&n[t.id][0]?.A&&e._editor.setValue(n[t.id][0].A.join("\n")),e._editor.on("change",(()=>{let n=e._editor.getValue();if(n){let e=n.split("\n").filter((e=>""!==e));f.forEach((e=>e.remove())),e.forEach((e=>f.push(h(e,m,t?.id||""))))}}))}))}}}function h(e,i,o){let s=n[o]||[];const l=t.questions.findIndex((e=>e.id==o));console.log("qanswers",s,n,e),console.log(o,t.questions[l]);let a=null;a=e&&"object"==typeof e?s.some((t=>t.id==e.id)):s?.[0]?.A?.includes(e)||s?.includes(e);let c=newEl({style:{display:"flex",alignItems:"center",justifyContent:"center",gap:"1em"}});i.append(c);let r="";e&&(r=e?.content?e.content:e);const d=getEl("categories").value;let u;"MCQ"===d?u=newEl({tag:"input",type:"radio",name:o,class:"answerChoice",_id:e?.id||"",choice:r},c):"MRQ"===d&&(u=newEl({tag:"input",type:"checkbox",class:"answerChoice",_id:e?.id||"",choice:r},c)),u&&a&&u.setAttribute("checked",!0),newEl({tag:"textarea",id:"choice",_id:e?.id||"",innerHTML:r,rows:3,cols:50,onchange:e=>{u&&u.setAttribute("choice",e.target.value)}},c),newEl({tag:"i",className:"icon-btn fa-solid fa-xmark choicecolor",onclick:e=>c.remove()},c);var p=newEl({tag:"i",className:"icon-btn fa-solid fa-angle-up",events:{click:n=>{const o=t.questions[l].choices.findIndex((t=>t==e));if(o>0){const e=i.children[o+1],n=i.children[o];i.insertBefore(e,n);const s=t.questions[l].choices[o];t.questions[l].choices[o]=t.questions[l].choices[o-1],t.questions[l].choices[o-1]=s,console.log(t.questions[l].choices),n.children[4].classList.add("transparent"),o==t.questions[l].choices.length-2&&p.classList.remove("transparent"),0==o&&h.classList.add("transparent")}}}},c),h=newEl({tag:"i",className:"icon-btn fa-solid fa-angle-down",events:{click:n=>{const o=t.questions[l].choices.findIndex((t=>t==e));if(o<t.questions[l].choices.length-1){const e=i.children[o+1],n=i.children[o+2];i.insertBefore(n,e);const s=t.questions[l].choices[o];t.questions[l].choices[o]=t.questions[l].choices[o+1],t.questions[l].choices[o+1]=s,console.log(t.questions[l].choices),console.log(n),n.children[3].classList.add("transparent"),o==t.questions[l].choices.length-2&&h.classList.add("transparent"),0==o&&p.classList.remove("transparent")}}}},c);return c}newEl({tag:"span",style:{display:"block",marginBottom:"2em"}},s),(t.questions||[]).forEach(((l,a)=>{const p=newEl({id:"q"+l.id,style:{display:"flex",alignItems:"center",justifyContent:"center",scrollMarginTop:"7em",gap:"1em"}},s),h=newEl({},p);console.log("a",n[l.id]);let g=n[l.id]?.[0];g&&"MRQ"===l.category&&(g=g.A),"object"==typeof g&&(g=JSON.stringify(g,null,2));const m=showQuestion(h,structuredClone(l),a,r,g,((e,t)=>{if("MRQ"==l.category)n[e][0]=t.a?.length?{A:t.a}:void 0,toast("Answer updated. Don't forget to save the exam.");else if("MCQ"==l.category)n[e][0]=t.a,toast("Answer updated. Don't forget to save the exam.");else if("OEQ"==l.category||"CODE"==l.category){if(t.a.trim().startsWith("{")&&t.a.trim().endsWith("}")){let e=m.querySelector(".editor-controls");e||(e=m.appendChild(document.createElement("div")),e.classList.add("editor-controls"));let n=e.querySelector("span");n||(n=e.appendChild(document.createElement("span")));try{t.a=JSON.parse(t.a),n.innerHTML=""}catch(e){return void(n.innerHTML='<span style="color:red;font-weight:bold;">Invalid JSON.<span>')}}n[e][0]=t.a,toast("Answer updated. Don't forget to save the exam.")}})),f=newEl({class:"top-right small flex-row"},m);button({innerHTML:'<i class="icon-btn fa-solid fa-pen-to-square"></i> Edit',onclick:()=>function(e){const n=popup("QID:"+e.id,"",button({textContent:"Update",onclick:()=>{t.R?toastWarn("Cannot save question. This exam is read-only."):getEl("my-form").reportValidity()&&d(e.id)&&n.close()}}),"Cancel",null,{class:"large"});u(e,n.main)}(l),class:"small"},f);const y=newEl({style:{display:"flex",className:"icon-container",flexDirection:"column",gap:"0.5em",alignItems:"center"}},p);newEl({tag:"i",class:"icon-btn fa-solid fa-copy",style:{marginBottom:"1em"},onclick:s=>{const a=structuredClone(l);do{a.id=(1e7*Math.random()).toFixed()}while(t.questions.some((e=>e.id===a.id)));t.questions.push(a),quizBuilder(e,t,n,i,o),e.scrollIntoView({block:"end",behavior:"smooth"})}},y);var E=newEl({tag:"i",className:"icon-btn fa-solid fa-angle-up",onclick:e=>{const n=t.questions.findIndex((e=>e.id==l.id));c(p,n,n-1,l)}},y);0===a&&E.classList.add("transparent"),input({pattern:"[0-9]*",class:"builderQuestionNumberInput",style:{minWidth:"2ch",width:(a+1).toString().length+1+"ch",fontFamily:"fixed",textAlign:"center"},value:a+1,min:1,max:t.questions.length,step:1,oninput:e=>{e.target.style.width=e.target.value.length+1+"ch"},onchange:e=>{let n=Number(e.target.value);const i=t.questions.findIndex((e=>e.id==l.id));""===e.target.value.trim()||isNaN(n)||!Number.isInteger(n)||n<1?e.target.value=i+1:(n>t.questions.length&&(n=t.questions.length),c(p,i,n-1,l))},onkeydown:e=>{if(ALLOWED_NUMBER_EDITING_KEYS.has(e.key)||e.preventDefault(),"ArrowDown"===e.key){const e=t.questions.findIndex((e=>e.id==l.id));c(p,e,e+1,l)}else if("ArrowUp"===e.key){const e=t.questions.findIndex((e=>e.id==l.id));c(p,e,e-1,l)}}},y);var w=newEl({tag:"i",className:"icon-btn fa-solid fa-angle-down",onclick:e=>{const n=t.questions.findIndex((e=>e.id==l.id));c(p,n,n+1,l)}},y);a===t.questions.length-1&&w.classList.add("transparent"),newEl({tag:"i",class:"icon-btn fa-solid fa-trash-can",style:{marginTop:"1em"},onclick:s=>{const a=popup("","Are you sure you want to DELETE this question? This can NOT be undone!",button({textContent:"Delete question",onclick:()=>{t.questions=t.questions.filter((e=>e.id!==l.id)),delete n[l.id],quizBuilder(e,t,n,i,o),a.close()}}),"Cancel")}},y)}))}