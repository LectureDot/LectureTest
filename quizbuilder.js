import{getEl,button,input,newEl,isObj,span,isArr,isStr}from"./ui/common.js";import{showQuestion}from"./showQuestions.js";import{confirmPopup,popup}from"./ui/popup.js";import{toast,toastError,toastSuccess,toastWarn}from"./ui/toast.js";import{codeEditor,EDITOR_LANGUAGES}from"./ui/editor/editor.js";import{marked}from"https://cdn.jsdelivr.net/npm/marked/lib/marked.esm.js";import styles from"./quizbuilder.css"with{type:"css"};import{runUnitTest}from"./util/unitTest.js";document.adoptedStyleSheets.push(styles);const ALLOWED_POSITION_EDITING_KEYS=new Set(["1","2","3","4","5","6","7","8","9","0","ArrowLeft","ArrowRight","Backspace","Delete","Home","End","Enter"]);export function quizBuilder(e,t,n,o,i){console.log(t),e.innerHTML="",n||(n={});const s=e,l=t?.i?.[0]===localStorage.email;input({id:"qtitle",htmlBefore:"Exam Title:",class:"bigger",value:t?.title||""},s),input({id:"category",htmlBefore:"Randomize Questions:",type:"checkbox",checked:"ORD"==t?.category?"":"checked"},s),input({id:"select",htmlBefore:"Number of Quiz Questions To Show:",value:t?.select||""},s),newEl({innerText:"Exam Description (markdown; shown prior to exam):"},s);let a=newEl({style:{width:"25em",height:"3.5em",resize:"both",overflow:"auto"}},s);codeEditor({id:"description",value:t?.description||"",lang:"markdown",lineNumbers:!0,lineWrapping:!0},a),newEl({innerText:"Exam Instructions (markdown; shown during exam):"},s),codeEditor({id:"instructions",value:t?.instructions||"",lang:"markdown",lineNumbers:!0,lineWrapping:!0,style:{width:"25em",height:"6.25em"}},s),input({id:"R",htmlBefore:"EXAM IS READ ONLY:",type:"checkbox",checked:t?.R?"checked":"",events:{input:n=>{e.className=n.target.checked?"readonly":"qouter",t.R=n.target.checked}}},s),e.className=t?.R?"readonly":"qouter",newEl({tag:"span",style:{display:"block",marginBottom:"2em"}},s);const r=newEl({class:"builder-control-row"},s);function c(e,n,o,i){if(o>=t.questions.length&&(o=t.questions.length-1),o<0&&(o=0),n===o)return;const l=n<o;if(o===t.questions.length-1)s.appendChild(e);else{const n=s.querySelector(`#q${t.questions[o+l].id}`);s.insertBefore(e,n)}t.questions.splice(n,1),t.questions.splice(o,0,i);for(let e=Math.min(n,o);e<=Math.max(n,o);e++){const n=s.querySelector(`#q${t.questions[e].id}`),i=n.querySelector(".builderQuestionNumberInput");i.value=e+1,i.style.width=(e+1).toString().length+1+"ch",e===o&&i.focus(),0===e?n.querySelector(".fa-angle-up").classList.add("transparent"):n.querySelector(".fa-angle-up").classList.remove("transparent"),e===t.questions.length-1?n.querySelector(".fa-angle-down").classList.add("transparent"):n.querySelector(".fa-angle-down").classList.remove("transparent")}e.scrollIntoView({behavior:"smooth",block:"start"})}button({innerHTML:'<i class="icon-btn fa-solid fa-plus"></i> Add Question',onclick:()=>{if(t.R)return void toastWarn("Cannot add question. This exam is marked as read-only.");const e={};let n;const o=new Set(t.questions.map((e=>e.id)));do{n=(1e7*Math.random()).toFixed()}while(o.has(n));e.id=n;const i=popup("New Question","",button({textContent:"Save Question",onclick:()=>{t.R?toastWarn("Cannot save question. This exam is read-only."):getEl("my-form").reportValidity()&&d(e.id)&&i.close()}}),"Cancel",null,{class:"large"});p(e,i.main)}},r),button({innerHTML:'<i class="icon-btn fa-solid fa-user-plus"></i> Share',onclick:()=>{var e=t.i||[localStorage.email];const n=newEl();function o(t,i){const s=newEl({class:"small flex-row"},n);0===i?span({innerText:"Owner:",style:{fontWeight:"bold"}},s):(span({innerHTML:'<i class="icon-btn fa-solid fa-user-times" title="Remove instructor."></i>',onclick:()=>{if(t===localStorage.email){confirmPopup("","Are you sure you want to remove yourself from this exam?","Remove",(()=>{s.remove(),e=e.filter((e=>e!==t))}),"Cancel")}else s.remove(),e=e.filter((e=>e!==t))}},s),l&&span({innerHTML:'<i class="icon-btn fa-solid fa-arrow-circle-up" title="Make this instructor the new owner."></i>',onclick:()=>{confirmPopup("Changing Exam Owner",["Are you sure you want change the owner for this exam?",`If you proceed, ${t} will become the new owner for this exam.`],"Change Owner",(()=>{e=[t].concat(e.filter((e=>e!==t))),n.innerHTML="",e.forEach(o)}),"Cancel")}},s)),span({innerText:t,style:{fontWeight:"bold"}},s),t===localStorage.email&&span({innerText:"(myself)"},s)}e.forEach(o);const i=popup("Exam Instructors",n,[button({innerText:"Add Instructor",onclick:()=>{const t=input({type:"email",placeholder:"Email address",required:!0}),n=popup("Add Instructor",["Enter email address for new instructor:",t],button({innerText:"OK",onclick:()=>{if(t.input.reportValidity()){if(e.includes(t.input.value))return void toast("This email is already in the list of instructors for this exam.");e.push(t.input.value),o(t.input.value,e.length-1),n.close()}}}),"Cancel")}}),button({innerText:"OK",onclick:()=>{t.i=e,toast("Instructor list updated. Don't forget to save the exam for changes to take effect."),i.close()}})],"Cancel")}},r),button({innerHTML:'<i class="icon-btn fa-solid fa-save"></i> Save',onclick:()=>{!function(){t.category=getEl("category").checked?"RAND":"ORD",t.select=getEl("select").value,t.title=getEl("qtitle").value,t.questions=t.questions,t.R=getEl("R").checked,t.instructions=getEl("instructions").value,t.description=getEl("description").value;const e=t.questions.map((e=>e.id));Object.keys(n).forEach((t=>{"_"===t||e.includes(t)||(n[t]=void 0)})),o&&o(t,n);console.log("save quiz",t,n)}()}},r),button({innerHTML:'<i class="icon-btn fa-solid fa-door-closed"></i> Exit',onclick:()=>{i&&i()}},r),t.questions||(t.questions=[]),isObj(t.questions)&&(t.questions=Object.values(t.questions));const u={};function d(e){try{const o={},i=getEl("all-options"),s=t.questions.findIndex((t=>t.id==e));n[e]=[],o.id=e;let l=getEl("categories");return o.category=l.value,o.choices=[],i.querySelectorAll('input[type="number"]').forEach((e=>{e.reportValidity()&&(o[e.id]=Number(e.value))})),i.querySelectorAll('input:not([type="number"], [type="checkbox"], [type="radio"])').forEach((e=>{e.reportValidity()&&e.id&&(o[e.id]=e.value)})),i.querySelectorAll('input[type="checkbox"]:not(.answerChoice)').forEach((e=>{o[e.id]=e.checked})),i.querySelectorAll("textarea.answerChoiceText").forEach((e=>{"object"==typeof t.questions[s]?.choices[0]?o.choices.push({id:e.getAttribute("_id"),content:e.value}):o.choices.push(e.value)})),i.querySelectorAll("input.answerChoice").forEach((o=>{console.log(o,o.checked,o.getAttribute("choice")),o.checked&&("MRQ"===l.value?(n[e][0]||(n[e][0]={A:[]}),n[e][0].A.push(o.getAttribute("choice"))):"object"==typeof t.questions[s]?.choices[0]?n[e].push({id:o.getAttribute("_id"),content:o.getAttribute("choice")}):n[e].push(o.getAttribute("choice")))})),i.querySelectorAll("select").forEach((e=>{o[e.id]=e.value})),i.querySelectorAll(".CodeMirror").forEach((t=>{let i=t.value.trim();if("prompt"==t.id)o[t.id]=i;else if("unit_tests"==t.id)if(i)try{i=JSON.parse(i),isArr(i)||(i=[i]),o.unit_tests=i}catch(e){return void toastError("Error parsing unit tests.\n"+e.toString())}else o.unit_tests=[];else if(i&&t.classList.contains("answer-editor"))if("CODE"===l.value)n[e]=JSON.parse(i);else{try{i=JSON.parse(i)}catch(e){}n[e].push(i)}})),n[e]=n[e].filter((e=>e)),i.querySelector("#false_check")?.checked&&n[e].push(!1),console.log("question",e),console.log(o),void console.log("answer",n[e])}catch(e){toastError("Error saving question.\n"+e.toString())}}function p(e,t){const n=e?.category||"Choose Category",o=newEl({tag:"form",id:"my-form",className:"container",style:{display:"flex",flexDirection:"column",gap:"8px"}},t);o.classList.add("back","qbuilder"),function(e,t){const n=newEl({tag:"select",id:"categories",events:{change:e=>{h(e.target.value,t,getEl("all-options"))}}},e);["Choose Category","MCQ","MRQ","OEQ","NRQ","CODE","MATCH","PARSONS"].forEach((e=>{newEl({tag:"option",value:e,textContent:e},n)}))}(o,e),getEl("categories").value=n;h(n,e,newEl({innerHTML:"",id:"all-options",style:{display:"flex",flexDirection:"row",gap:"2px",justifyContent:"center"}},o))}function h(e,t,o){if(console.log("q",t),e!=t.category&&(o.innerHTML="",t.category=e),!t.id)return void console.error("No ID found for question.");const i=n[t.id]||[],s=newEl({className:"qbuilder",style:{display:"flex",flexDirection:"column",gap:"6px",flex:.3}},o),l=newEl({className:"qbuilder",style:{display:"flex",flexDirection:"column",flex:1}},o);if("Choose Category"!==e){const n=newEl({className:"qbuilder gen-div"},s);input({id:"title",htmlBefore:"Title:",value:t?.title||"",placeholder:"Enter your title (Required)",style:{flexGrow:1},required:!0},n),newEl({tag:"span",innerHTML:"Prompt:",style:{display:"flex"}},n),codeEditor({id:"prompt",value:t?.prompt||"",lang:"markdown",lineNumbers:!0,lineWrapping:!0,style:{height:"10em",width:"30em"}},n),input({id:"points",htmlBefore:"Points:",type:"number",value:t?.points||1,style:{flexGrow:1},required:!0},n);const o=newEl({className:"qbuilder options-div"},s);if("MCQ"!=e&&"MRQ"!=e||input({id:"ordered",htmlAfter:"Order Choices",type:"checkbox",checked:t.ordered},o),"PARSONS"==e&&(input({id:"choice_reuse",htmlAfter:"Reuse Choices",type:"checkbox",checked:t.choice_reuse},o),input({id:"max_levels",htmlBefore:"Max Levels:",type:"number",value:t?.max_levels},o),input({id:"false_check",htmlAfter:"Manual Check If Incorrect",type:"checkbox",checked:t.false_check},o)),"OEQ"!=e&&"CODE"!=e||(input({id:"max_lines",htmlBefore:"Max Lines:",min:0,type:"number",value:t?.max_lines||"",placeholder:"No limit",oninput:e=>{"0"===e.target.value&&(e.target.value="")}},o),input({id:"max_length",htmlBefore:"Max Chars:",min:0,type:"number",value:t?.max_length||"",placeholder:"No limit",oninput:e=>{"0"===e.target.value&&(e.target.value="")}},o),input({id:"case_sensitive",htmlAfter:"Case Sensitive",type:"checkbox",checked:t.case_sensitive},o),input({id:"space_sensitive",htmlAfter:"Space Sensitive",type:"checkbox",checked:t.space_sensitive},o),input({id:"false_check",htmlAfter:"Manual Check If Incorrect",type:"checkbox",checked:t.false_check},o)),"PARSONS"==e||"CODE"==e){var a=newEl({tag:"select",id:"language"},o);Object.keys(EDITOR_LANGUAGES).forEach((e=>{newEl({tag:"option",value:e,textContent:e},a)})),a.value=t?.language||"python",input({id:"run",htmlAfter:"Display Run Button",type:"checkbox",checked:t.run},o),input({id:"await_input",htmlAfter:"Convert `input()` to `await input()`",type:"checkbox",checked:t.await_input??!0},o),input({id:"max_output",htmlBefore:"Max output size:<br>(including newline characters)",min:1,max:1e5,step:1,type:"number",value:t?.max_output||"1000",oninput:e=>{e.target.reportValidity()},onchange:e=>{e.target.value||(e.target.value=1e3)},labelStyle:{alignItems:"flex-start"}},o),input({id:"runtime_limit",htmlBefore:"Max runtime default:",htmlAfter:"s",min:0,type:"number",value:t?.runtime_limit||10,placeholder:"No limit",oninput:e=>{"0"===e.target.value?e.target.value="":e.target.reportValidity()}},o),newEl({innerText:"Unit Tests:"},o);let e="[]";if(t?.unit_tests)try{e=JSON.stringify(t.unit_tests,null,2)}catch(e){console.error(e)}codeEditor({id:"unit_tests",value:e,lang:"json",lineNumbers:!0,lineWrapping:!0,style:{height:"10em",width:"30em"}},o)}m(t,i,l)}}function m(e,t,n){n.innerHTML="",newEl({innerText:"Answers"},n);const o=newEl({className:"qbuilder answers-div"},n);if(t=t.filter((e=>e)),"OEQ"==e.category){function i(e){e.target.value||e.target.remove();o.querySelector("textarea:last-child").value&&s()}function s(e=""){newEl({tag:"textarea",class:"answer-editor",rows:4,cols:50,style:{flexGrow:1},onchange:i,value:e},o)}for(let a of t)"object"==typeof a&&(a=JSON.stringify(a,null,2)),s(a);s()}if("NRQ"==e.category&&input({htmlBefore:"Answer:",type:"number",value:t[0]||0,style:{flexGrow:1}},o),"MCQ"!=e.category&&"MRQ"!=e.category||(o.classList.add("mcq"),newEl({tag:"button",id:"add-option-btn",textContent:"Add Option",events:{click:t=>{localStorage.x="hello",f(null,o,e.id),t.preventDefault()}}},o),e.choices?e.choices?.forEach((t=>{f(t,o,e.id)})):(f(null,o,e.id),f(null,o,e.id))),"CODE"==e.category){function l(t,o,i){const s=t[o]?t[o].A||t[o]:[];for(let l=0;l<s.length;l++){let a=s[l];isObj(a)&&(a=JSON.stringify(a,null,2)),newEl({innerHTML:a,style:{whiteSpace:"pre-wrap",backgroundColor:"#333"},onclick:()=>g(n,e,t,o,l)},i)}const l=newEl({class:"row"},i);button({textContent:"Add valid code (or pattern)...",class:"small",onclick:()=>{g(n,e,t,o)}},l),button({textContent:"Add python unit test...",class:"small",onclick:()=>{g(n,e,t,o)}},l)}l(t,0,o);for(let r=1;r<t.length;r++)l(t,r,newEl({className:"qbuilder answers-div"},n));button({textContent:"Add answer...",class:"small",onclick:()=>{t.push({A:[]}),m(e,t,n)}},n)}if("PARSONS"==e.category){const c=getEl("language"),u=newEl({style:{display:"flex",flexDirection:"column",flexGrow:.2,alignItems:"center",gap:".5em"}},o),d=[];newEl({tag:"button",id:"add-option-btn",textContent:"Add Distractor",onclick:t=>{f(null,u,e.id),t.preventDefault()}},u);const p=newEl({style:{flexDirection:"column",flexGrow:1}},o),h=codeEditor({class:"answer-editor",lang:c.value},p);c.addEventListener("change",(()=>{h.setOption("mode",c.value)})),t[0]?.A&&(h.value=t[0].A.join("\n")),h.on("change",(()=>{if(h.value){let t=h.value.split("\n").filter((e=>""!==e));d.forEach((e=>e.remove())),t.forEach((t=>d.push(f(t,u,e.id))))}}))}}function f(e,o,i){let s=n[i]||[];const l=t.questions.findIndex((e=>e.id==i));console.log("qanswers",s,n,e),console.log(i,t.questions[l]);let a=null;a=e&&"object"==typeof e?s.some((t=>t.id==e.id)):s?.[0]?.A?.includes(e)||s?.includes(e);let r=newEl({style:{display:"flex",alignItems:"center",justifyContent:"center",gap:"1em"}});o.append(r);let c="";e&&(c=e?.content?e.content:e);const u=getEl("categories").value;let d;"MCQ"===u?d=newEl({tag:"input",type:"radio",name:i,class:"answerChoice",_id:e?.id||"",choice:c},r):"MRQ"===u&&(d=newEl({tag:"input",type:"checkbox",class:"answerChoice",_id:e?.id||"",choice:c},r)),d&&a&&d.setAttribute("checked",!0),newEl({tag:"textarea",class:"answerChoiceText",_id:e?.id||"",innerHTML:c,rows:3,cols:50,onchange:e=>{d&&d.setAttribute("choice",e.target.value)}},r),newEl({tag:"i",className:"icon-btn fa-solid fa-xmark choicecolor",onclick:e=>r.remove()},r);var p=newEl({tag:"i",className:"icon-btn fa-solid fa-angle-up",onclick:n=>{const i=t.questions[l].choices.findIndex((t=>t==e));if(i>0){const e=o.children[i+1],n=o.children[i];o.insertBefore(e,n);const s=t.questions[l].choices[i];t.questions[l].choices[i]=t.questions[l].choices[i-1],t.questions[l].choices[i-1]=s,console.log(t.questions[l].choices),n.children[4].classList.add("transparent"),i==t.questions[l].choices.length-2&&p.classList.remove("transparent"),0==i&&h.classList.add("transparent")}}},r),h=newEl({tag:"i",className:"icon-btn fa-solid fa-angle-down",onclick:n=>{const i=t.questions[l].choices.findIndex((t=>t==e));if(i<t.questions[l].choices.length-1){const e=o.children[i+1],n=o.children[i+2];o.insertBefore(n,e);const s=t.questions[l].choices[i];t.questions[l].choices[i]=t.questions[l].choices[i+1],t.questions[l].choices[i+1]=s,console.log(t.questions[l].choices),console.log(n),n.children[3].classList.add("transparent"),i==t.questions[l].choices.length-2&&h.classList.add("transparent"),0==i&&p.classList.remove("transparent")}}},r);return r}function g(e,t,n,o,i){let s=n[o]||{A:[]};s&&!s.A&&(isStr(s)||isObj(s)?s={A:[s]}:s.A=[]);const l=s.A[i]||{},a=codeEditor({lang:"python",value:l.exec||""}),r=codeEditor({lang:"text",value:l.in||""}),c=codeEditor({lang:"text",value:l.out?l.out.re?l.out.re:l.out:""}),u=input({type:"checkbox",htmlAfter:"Output is case sensitive",checked:l.case}),d=input({type:"checkbox",htmlAfter:"Output is a regular expression",checked:l.out?.re}),p=input({type:"number",htmlBefore:"Max Runtime (sec):",value:l.maxTime||.1,min:.001}),h=input({type:"number",htmlBefore:"Max Output Size:",value:l.maxOut||1e3,min:1,max:1e5,step:1}),f=codeEditor({lang:"python"}),g=codeEditor({lang:"text"});function y(){l.run="py",l.out=d.input.checked?{re:c.value}:c.value,u.input.checked?l.case=!0:delete l.case,a.value.trim()?l.exec=a.value:delete l.exec,r.value.trim()?l.in=r.value:delete l.in,p.input.value&&(l.maxTime=Number(p.input.value)),h.input.value&&(l.maxOut=Number(h.input.value))}const v=popup("Unit Test",["Execute after user code:",a,"Input:",r,"Output:",c,u,d,p,h,"Try some code:",f,g],[button({textContent:"✔️ Test",onclick:async()=>{y();const e=await runUnitTest(f.value,l,!u.input.checked);g.value=e.output,e.passed?toast("✔️ Unit test passed.","",1):toast("❌ Unit test failed.","",-.5)}}),button({textContent:void 0===o?"Add Unit Test":"Update Unit Test",onclick:()=>{y(),console.log(l),void 0===i?s.A.push(l):s.A[i]=l,void 0===o?n.push(s):n[o]=s,console.log(n),m(t,n,e),v.close()}})],"Cancel",null,{class:"large"})}newEl({tag:"span",style:{display:"block",marginBottom:"2em"}},s),(t.questions||[]).forEach(((l,a)=>{const r=newEl({id:"q"+l.id,style:{display:"flex",alignItems:"center",justifyContent:"center",scrollMarginTop:"7em",gap:"1em"}},s),h=newEl({},r);console.log("a",n[l.id]);let m=n[l.id]?.[0];m&&"MRQ"===l.category&&(m=m.A),"object"==typeof m&&(m=JSON.stringify(m,null,2));const f=showQuestion(h,structuredClone(l),a,u,m,((e,t)=>{if("MRQ"==l.category)n[e][0]=t.a?.length?{A:t.a}:void 0,toast("Answer updated. Don't forget to save the exam.");else if("MCQ"==l.category)n[e][0]=t.a,toast("Answer updated. Don't forget to save the exam.");else if("OEQ"==l.category||"CODE"==l.category){if(t.a.trim().startsWith("{")&&t.a.trim().endsWith("}")){let e=f.querySelector(".editor-controls");e||(e=f.appendChild(document.createElement("div")),e.classList.add("editor-controls"));let n=e.querySelector("span");n||(n=e.appendChild(document.createElement("span")));try{t.a=JSON.parse(t.a),n.innerHTML=""}catch(e){return void(n.innerHTML='<span style="color:red;font-weight:bold;">Invalid JSON.<span>')}}n[e][0]=t.a,toast("Answer updated. Don't forget to save the exam.")}})),g=newEl({class:"top-right small flex-row"},f);button({innerHTML:'<i class="icon-btn fa-solid fa-pen-to-square"></i> Edit',onclick:()=>function(e){const n=popup("QID:"+e.id,"",button({textContent:"Update",onclick:()=>{t.R?toastWarn("Cannot save question. This exam is read-only."):getEl("my-form").reportValidity()&&d(e.id)&&n.close()}}),"Cancel",null,{class:"large"});p(e,n.main)}(l),class:"small"},g);const y=newEl({style:{display:"flex",className:"icon-container",flexDirection:"column",gap:"0.5em",alignItems:"center"}},r);newEl({tag:"i",class:"icon-btn fa-solid fa-copy",style:{marginBottom:"1em"},onclick:s=>{const a=structuredClone(l);do{a.id=(1e7*Math.random()).toFixed()}while(t.questions.some((e=>e.id===a.id)));t.questions.push(a),quizBuilder(e,t,n,o,i),e.scrollIntoView({block:"end",behavior:"smooth"})}},y);var v=newEl({tag:"i",className:"icon-btn fa-solid fa-angle-up",onclick:e=>{const n=t.questions.findIndex((e=>e.id==l.id));c(r,n,n-1,l)}},y);0===a&&v.classList.add("transparent"),input({pattern:"[0-9]*",class:"builderQuestionNumberInput",style:{minWidth:"2ch",width:(a+1).toString().length+1+"ch",fontFamily:"fixed",textAlign:"center"},value:a+1,min:1,max:t.questions.length,step:1,oninput:e=>{e.target.style.width=e.target.value.length+1+"ch"},onchange:e=>{let n=Number(e.target.value);const o=t.questions.findIndex((e=>e.id==l.id));""===e.target.value.trim()||isNaN(n)||!Number.isInteger(n)||n<1?e.target.value=o+1:(n>t.questions.length&&(n=t.questions.length),c(r,o,n-1,l))},onkeydown:e=>{if(ALLOWED_POSITION_EDITING_KEYS.has(e.key)||e.preventDefault(),"ArrowDown"===e.key){const e=t.questions.findIndex((e=>e.id==l.id));c(r,e,e+1,l)}else if("ArrowUp"===e.key){const e=t.questions.findIndex((e=>e.id==l.id));c(r,e,e-1,l)}}},y);var x=newEl({tag:"i",className:"icon-btn fa-solid fa-angle-down",onclick:e=>{const n=t.questions.findIndex((e=>e.id==l.id));c(r,n,n+1,l)}},y);a===t.questions.length-1&&x.classList.add("transparent"),newEl({tag:"i",class:"icon-btn fa-solid fa-trash-can",style:{marginTop:"1em"},onclick:s=>{const a=popup("","Are you sure you want to DELETE this question? This can NOT be undone!",button({textContent:"Delete question",onclick:()=>{t.questions=t.questions.filter((e=>e.id!==l.id)),delete n[l.id],quizBuilder(e,t,n,o,i),a.close()}}),"Cancel")}},y)}))}