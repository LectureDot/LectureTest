import{el,addElementTo,button,importStyleSheet,input,download,newEl}from"./ui/common.js";import{showQuestion}from"./showQuestions.js";import{popup}from"./ui/popup.js";import{toast}from"./ui/toast.js";import{marked}from"https://cdn.jsdelivr.net/npm/marked/lib/marked.esm.js";export function quizBuilder(e,t,o,i,n){e.innerHTML="",o||(o={}),input({id:"qtitle",htmlBefore:"Enter Quiz Title:",value:t?.title||""},e),input({id:"category",htmlBefore:"Randomize Questions:",type:"checkbox",checked:"ORD"==t?.category?"":"checked"},e),input({id:"select",htmlBefore:"Number of Quiz Questions To Show:",value:t?.select||""},e),input({id:"instructions",htmlBefore:"Specify Instructrions To Show:",value:t?.instructions||""},e),input({id:"R",htmlBefore:"EXAM IS READ ONLY:",type:"checkbox",checked:t?.R?"checked":""},e),e.className=t?.R?"readonly":"qouter",addElementTo(e,{tag:"span",style:{display:"block",marginBottom:"2em"}});const l=addElementTo(e,{style:{display:"flex",alignItems:"center",gap:"1em"}}),s=addElementTo(l,{className:"tooltip-container"});addElementTo(s,{tag:"i",className:"icon-btn fa-solid fa-plus",events:{click:e=>{const o=popup("New Question","",button({textContent:"Save Question",style:{minWidth:"700px"},events:{click:()=>{el("my-form").reportValidity()&&(console.log("new question",t.R),t.R||r(),o.close())}}}),"Cancel");u([],o.main)}}}),addElementTo(s,{className:"tooltip-text",innerHTML:"Add Question"});const a=addElementTo(l,{className:"tooltip-container"});addElementTo(a,{tag:"i",className:"icon-btn fa-solid fa-file-export",events:{click:e=>{!function(){t.category="on"===el("category").value?"RAND":"ORD",t.select=el("select").value,t.title=el("qtitle").value,t.questions=t.questions,t.R=el("R").checked,t.instructions=el("instructions").value,i&&i(t,o);localStorage[t.title]=JSON.stringify(t),localStorage[t.title+"answers"]=JSON.stringify(o),console.log("save quiz",t,o)}()}}}),addElementTo(a,{className:"tooltip-text",innerHTML:"Save Quiz"});const c=addElementTo(l,{className:"tooltip-container"});addElementTo(c,{tag:"i",className:"icon-btn fa-solid fa-door-closed",events:{click:e=>{n&&n()}}}),addElementTo(c,{className:"tooltip-text",innerHTML:"Exit QuizBuilder"}),Array.isArray(t.questions)||(t.questions=Object.values(t.questions||[]));const d={};function r(l){console.log("saveq",d);const s={},a=el("all-options"),c=t.questions.findIndex((e=>e.id==l));o[l]=[],s.id=l;let r=el("categories");s.category=r.value,s.choices=[],a.querySelectorAll('input[type="checkbox"]:not(.answerChoice)').forEach((e=>{s[e.id]=e.checked,"false_check"==e.id&&o[l].push(!1)})),a.querySelectorAll('input[type="number"]').forEach((e=>{s[e.id]=Number(e.value)})),a.querySelectorAll('input:not([type="number"], [type="checkbox"], [type="radio"])').forEach((e=>{e.id&&(s[e.id]=e.value)})),a.querySelectorAll('input[type="text"]').forEach((e=>{s.choices.push(e.value)})),a.querySelectorAll("input.answerChoice").forEach((e=>{e.checked&&("object"==typeof t.questions[c].choices[0]?o[l].push({id:e.getAttribute("_id"),content:e.getAttribute("choice")}):o[l].push(e.getAttribute("choice")))})),a.querySelectorAll("select").forEach((e=>{s[e.id]=e.value})),a.querySelectorAll("textarea").forEach((e=>{let i=e._editor?.getValue();if(i){const e=i.split("\n").filter((e=>""!==e));o[l]=[{A:e}];let t=s.max_levels;i=i.split("\n").map((e=>t?e.trim():e)).filter((e=>e)),s.choices.push(...i)}else""!=e.value&&e.id&&("prompt"==e.id||"stimulus"==e.id?s[e.id]=e.value:"choice"==e.id?"object"==typeof t.questions[c]?.choices[0]?s.choices.push({id:e.getAttribute("_id"),content:e.value}):s.choices.push(e.value):o[l].push(e.value))})),console.log(o),console.log(s),-1!==c?t.questions[c]=s:t.questions.push(s),t.category=el("category").checked?"RAND":"ORD",t.R=el("R").checked,t.select=el("select").value,t.title=el("qtitle").value,t.instructions=el("instructions").value,quizBuilder(e,t,o,i,n)}function u(e,t){const o=e?.category||"Choose Category",i=addElementTo(t,{tag:"form",id:"my-form",className:"container",style:{display:"flex",flexDirection:"column",gap:"8px"}});i.classList.add("back","qbuilder"),function(e,t){const o=addElementTo(e,{tag:"select",id:"categories",events:{change:e=>{p(e.target.value,t,el("all-options"))}}});["Choose Category","MCQ","MRQ","OEQ","NRQ","CODE","MATCH","PARSONS"].forEach((e=>{addElementTo(o,{tag:"option",value:e,textContent:e})}))}(i,e),el("categories").value=o;p(o,e,addElementTo(i,{innerHTML:"",id:"all-options",style:{display:"flex",flexDirection:"row",gap:"2px",justifyContent:"center"}}))}function p(e,i,n){var l=0;if(e!=i.category&&(n.innerHTML="",i.category=e),!i.id){do{l=(1e7*Math.random()).toFixed()}while(new Set(t.questions.map((e=>e.id))).has(l));i.id=l}const s=addElementTo(n,{className:"qbuilder",style:{display:"flex",flexDirection:"column",gap:"6px",flex:.3}}),a=addElementTo(n,{className:"qbuilder",style:{display:"flex",flexDirection:"column",flex:1}});if("Choose Category"!==e){const t=addElementTo(s,{className:"qbuilder gen-div"});input({id:"title",htmlBefore:"Title:",value:i?.title||"",placeholder:"Enter your title (Required)",style:{flexGrow:1},required:!0},t);const n=addElementTo(t,{tag:"span",innerHTML:"Stimulus:",style:{display:"flex"}});addElementTo(n,{tag:"textarea",id:"stimulus",value:marked.parse(i?.stimulus||""),rows:6,placeholder:"Enter your stimulus",style:{flexGrow:1}});const l=addElementTo(t,{tag:"span",innerHTML:"Prompt:",style:{display:"flex"}});addElementTo(l,{tag:"textarea",id:"prompt",value:marked.parse(i?.prompt||""),rows:6,placeholder:"Enter your prompt (Required)",style:{flexGrow:1},required:!0}),input({id:"points",htmlBefore:"Points:",type:"number",value:i?.points||1,style:{flexGrow:1},required:!0},t);const r=addElementTo(s,{className:"qbuilder options-div"});"MCQ"!=e&&"MRQ"!=e||input({id:"ordered",htmlAfter:"Order Choices",type:"checkbox",checked:i.ordered},r),"PARSONS"==e&&(input({id:"choice_reuse",htmlAfter:"Reuse Choices",type:"checkbox",checked:i.choice_reuse},r),input({id:"max_levels",htmlBefore:"Max Levels:",type:"number",value:i?.max_levels},r)),"OEQ"!=e&&"CODE"!=e||(input({id:"case_sensitive",htmlAfter:"Case Sensitive",type:"checkbox",checked:i.case_sensitive},r),input({id:"space_sensitive",htmlAfter:"Space Sensitive",type:"checkbox",checked:i.space_sensitive},r),input({id:"regex",htmlAfter:"Regex",type:"checkbox",checked:i.regex},r),input({id:"false_check",htmlAfter:"Manual Check If Incorrect",type:"checkbox",checked:i.false_check},r),input({id:"max_lines",htmlBefore:"Max Lines:",type:"number",value:i?.max_lines,style:{flexGrow:1},placeholder:"Enter number of Maximum Lines"},r),input({id:"max_length",htmlBefore:"Max Length (chars):",type:"number",value:i?.max_length,style:{flexGrow:1},placeholder:"Enter Maximum Length (chars)"},r));const u=addElementTo(a,{className:"qbuilder answers-div",style:{display:"flex",gap:".5em"}});if("OEQ"==e&&addElementTo(u,{tag:"textarea",id:"oeq",rows:10,value:o[i.id]?.join("\n")||"",style:{flexGrow:1}}),"NRQ"==e&&input({id:"oeq2",htmlBefore:"Answer:",type:"number",value:o[i.id]||0,style:{flexGrow:1}},u),"MCQ"!=e&&"MRQ"!=e||(u.classList.add("mcq"),addElementTo(u,{tag:"button",id:"add-option-btn",textContent:"Add Option",events:{click:e=>{localStorage.x="hello",m(null,u,i?.id||""),e.preventDefault()}}}),i.choices?i.choices?.forEach((e=>{m(e,u,i.id)})):(console.log("here"),m(null,u,i?.id),m(null,u,i?.id))),"PARSONS"==e||"CODE"==e){const t=addElementTo(u,{style:{display:"flex",flexDirection:"column",flexGrow:.2,alignItems:"center",gap:".5em"}}),n=[];"PARSONS"==e&&addElementTo(t,{tag:"button",id:"add-option-btn",textContent:"Add Distractor",events:{click:e=>{m(null,t,i?.id||""),e.preventDefault()}}});const l=addElementTo(u,{style:{flexDirection:"column",flexGrow:1}});var c=addElementTo(l,{tag:"select",id:"language"}),d=addElementTo(l,{tag:"textarea",id:"parsons",_id:i?.id});["text/plain","python","javascript","java","c_cpp","application/json","markdown"].forEach((e=>{addElementTo(c,{tag:"option",value:e,textContent:e.charAt(0).toUpperCase()+e.slice(1)})})),c.value=i?.language||"text/plain",setTimeout((e=>{d._editor=CodeMirror.fromTextArea(d,{lineNumbers:!0,mode:"python",theme:"default",tabSize:4,smartIndent:!0,insertSoftTab:!0}),c.addEventListener("change",(()=>{const e=c.value;d._editor.setOption("mode",e)})),o[i?.id]?d._editor.setValue(o[i.id][0].A.join("\n")):d._editor.setValue(""),d._editor.on("change",(()=>{let e=d._editor.getValue();if(console.log(t),e){let o=e.split("\n").filter((e=>""!==e));console.log("Lines:",o),n.forEach((e=>e.remove())),o.forEach((e=>n.push(m(e,t,i?.id||""))))}}))}),100)}}}function m(e,t,i){let n=o[i]||[],l=null;l="object"==typeof e?n.some((t=>t.id==e.id)):n?.includes(e);let s=newEl({style:{display:"flex",alignItems:"center",justifyContent:"center",gap:"1em"}});t.prepend(s);let a="";e&&(a=e?.content?e.content:e);let c="MCQ"==el("categories").value?`<input type="radio" name="${i}" class="answerChoice" _id="${e?.id||""}" choice="${e?.id||a}" ${l?"checked":""}></input>`:`<input type="checkbox" class="answerChoice" _id="${e?.id||""}" choice="${a}" ${l?"checked":""}>`;return"PARSONS"==el("categories").value&&(c=""),addElementTo(s,{innerHTML:`${c}`}).scrollIntoView({behavior:"smooth"}),addElementTo(s,{tag:"textarea",id:"choice",_id:e?.id||"",innerHTML:a}),addElementTo(s,{tag:"i",className:"icon-btn fa-solid fa-xmark choicecolor",events:{click:e=>{s.remove()}}}),s}addElementTo(e,{tag:"span",style:{display:"block",marginBottom:"2em"}}),Object.keys(t.questions||[]).forEach((l=>{let s=t.questions[l];const a=addElementTo(e,{style:{display:"flex",alignItems:"center",justifyContent:"center",gap:"1em"}}),c=addElementTo(a,{}),p=(showQuestion(c,structuredClone(s),l,d,o[s.id]),addElementTo(a,{style:{display:"flex",className:"icon-container",flexDirection:"column",gap:"20px"}}));var m=addElementTo(p,{tag:"i",className:"icon-btn fa-solid fa-angle-up",events:{click:l=>{const a=t.questions.findIndex((e=>e.id==s.id));if(a>0){const l=t.questions[a];t.questions[a]=t.questions[a-1],t.questions[a-1]=l,quizBuilder(e,t,o,i,n)}}}});0==t.questions.findIndex((e=>e.id==s.id))&&m.classList.add("transparent");var h=addElementTo(p,{tag:"i",className:"icon-btn fa-solid fa-angle-down",events:{click:l=>{const a=t.questions.findIndex((e=>e.id==s.id));if(a<t.questions.length-1){const l=t.questions[a];t.questions[a]=t.questions[a+1],t.questions[a+1]=l,quizBuilder(e,t,o,i,n)}}}});t.questions.findIndex((e=>e.id==s.id))==t.questions.length-1&&h.classList.add("transparent"),addElementTo(p,{tag:"i",className:"icon-btn fa-solid fa-pen-to-square",events:{click:e=>{const o=popup("QID:"+s.id,"",button({textContent:"Update",style:{minWidth:"700px"},events:{click:()=>{if(el("my-form").reportValidity()){const e=popup("","Are you sure you want to UPDATE this question?",button({textContent:"YES",events:{click:()=>{console.log("update question",t.R),t.R||r(s.id),e.close(),o.close()}}}),"No")}}}}),"Cancel");u(s,o.main)}}}),addElementTo(p,{tag:"i",className:"icon-btn fa-solid fa-trash-can",events:{click:l=>{const a=popup("","Are you sure you want to DELETE this question? This can NOT be undone!",button({textContent:"YES",events:{click:()=>{t.questions=t.questions.filter((e=>e.id!==s.id)),delete o[s.id],quizBuilder(e,t,o,i,n),a.close()}}}),"No")}}})}))}