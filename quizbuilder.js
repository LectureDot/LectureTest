import{getEl,button,input,newEl}from"./ui/common.js";import{showQuestion}from"./showQuestions.js";import{popup}from"./ui/popup.js";import{marked}from"https://cdn.jsdelivr.net/npm/marked/lib/marked.esm.js";import styles from"./quizbuilder.css"with{type:"css"};document.adoptedStyleSheets.push(styles);export function quizBuilder(e,t,i,n,o){e.innerHTML="",i||(i={});const l=e;input({id:"qtitle",htmlBefore:"Exam Title:",class:"bigger",value:t?.title||""},l),input({id:"category",htmlBefore:"Randomize Questions:",type:"checkbox",checked:"ORD"==t?.category?"":"checked"},l),input({id:"select",htmlBefore:"Number of Quiz Questions To Show:",value:t?.select||""},l),input({id:"instructions",htmlBefore:"Specify Instructrions To Show:",value:t?.instructions||""},l),input({id:"R",htmlBefore:"EXAM IS READ ONLY:",type:"checkbox",checked:t?.R?"checked":""},l),e.className=t?.R?"readonly":"qouter",newEl({tag:"span",style:{display:"block",marginBottom:"2em"}},l);const s=newEl({class:"builder-control-row"},l);button({innerHTML:'<i class="icon-btn fa-solid fa-plus"></i> Add Question',onclick:()=>{const e=popup("New Question","",button({textContent:"Save Question",events:{click:()=>{getEl("my-form").reportValidity()&&(console.log("new question",t.R),t.R||a(),e.close())}}}),"Cancel");r([],e.main)}},s),button({innerHTML:'<i class="icon-btn fa-solid fa-save"></i> Save',onclick:()=>{!function(){t.category="on"===getEl("category").value?"RAND":"ORD",t.select=getEl("select").value,t.title=getEl("qtitle").value,t.questions=t.questions,t.R=getEl("R").checked,t.instructions=getEl("instructions").value,n&&n(t,i);localStorage[t.title]=JSON.stringify(t),localStorage[t.title+"answers"]=JSON.stringify(i),console.log("save quiz",t,i)}()}},s),button({innerHTML:'<i class="icon-btn fa-solid fa-door-closed"></i> Exit',onclick:()=>{o&&o()}},s),Array.isArray(t.questions)||(t.questions=Object.values(t.questions||[]));const c={};function a(l){console.log("saveq",c);const s={},a=getEl("all-options"),r=t.questions.findIndex((e=>e.id==l));i[l]=[],s.id=l;let u=getEl("categories");s.category=u.value,s.choices=[],a.querySelectorAll('input[type="checkbox"]:not(.answerChoice)').forEach((e=>{s[e.id]=e.checked,"false_check"==e.id&&i[l].push(!1)})),a.querySelectorAll('input[type="number"]').forEach((e=>{s[e.id]=Number(e.value)})),a.querySelectorAll('input:not([type="number"], [type="checkbox"], [type="radio"])').forEach((e=>{e.id&&(s[e.id]=e.value)})),a.querySelectorAll('input[type="text"]').forEach((e=>{s.choices.push(e.value)})),a.querySelectorAll("input.answerChoice").forEach((e=>{e.checked&&("object"==typeof t.questions[r].choices[0]?i[l].push({id:e.getAttribute("_id"),content:e.getAttribute("choice")}):i[l].push(e.getAttribute("choice")))})),a.querySelectorAll("select").forEach((e=>{s[e.id]=e.value})),a.querySelectorAll("textarea").forEach((e=>{let n=e._editor?.getValue();if(n){const e=n.split("\n").filter((e=>""!==e));i[l]=[{A:e}];let t=s.max_levels;n=n.split("\n").map((e=>t?e.trim():e)).filter((e=>e)),s.choices.push(...n)}else""!=e.value&&e.id&&("prompt"==e.id||"stimulus"==e.id?s[e.id]=e.value:"choice"==e.id?"object"==typeof t.questions[r]?.choices[0]?s.choices.push({id:e.getAttribute("_id"),content:e.value}):s.choices.push(e.value):i[l].push(e.value))})),console.log(i),console.log(s),-1!==r?t.questions[r]=s:t.questions.push(s),t.category=getEl("category").checked?"RAND":"ORD",t.R=getEl("R").checked,t.select=getEl("select").value,t.title=getEl("qtitle").value,t.instructions=getEl("instructions").value,quizBuilder(e,t,i,n,o)}function r(e,t){const i=e?.category||"Choose Category",n=newEl({tag:"form",id:"my-form",className:"container",style:{display:"flex",flexDirection:"column",gap:"8px"}},t);n.classList.add("back","qbuilder"),function(e,t){const i=newEl({tag:"select",id:"categories",events:{change:e=>{u(e.target.value,t,getEl("all-options"))}}},e);["Choose Category","MCQ","MRQ","OEQ","NRQ","CODE","MATCH","PARSONS"].forEach((e=>{newEl({tag:"option",value:e,textContent:e},i)}))}(n,e),getEl("categories").value=i;u(i,e,newEl({innerHTML:"",id:"all-options",style:{display:"flex",flexDirection:"row",gap:"2px",justifyContent:"center"}},n))}function u(e,n,o){var l=0;if(e!=n.category&&(o.innerHTML="",n.category=e),!n.id){do{l=(1e7*Math.random()).toFixed()}while(new Set(t.questions.map((e=>e.id))).has(l));n.id=l}const s=newEl({className:"qbuilder",style:{display:"flex",flexDirection:"column",gap:"6px",flex:.3}},o),c=newEl({className:"qbuilder",style:{display:"flex",flexDirection:"column",flex:1}},o);if("Choose Category"!==e){const t=newEl({className:"qbuilder gen-div"},s);input({id:"title",htmlBefore:"Title:",value:n?.title||"",placeholder:"Enter your title (Required)",style:{flexGrow:1},required:!0},t);const o=newEl({tag:"span",innerHTML:"Stimulus:",style:{display:"flex"}},t);newEl({tag:"textarea",id:"stimulus",value:marked.parse(n?.stimulus||""),rows:6,placeholder:"Enter your stimulus",style:{flexGrow:1}},o);const l=newEl({tag:"span",innerHTML:"Prompt:",style:{display:"flex"}},t);newEl({tag:"textarea",id:"prompt",value:marked.parse(n?.prompt||""),rows:6,placeholder:"Enter your prompt (Required)",style:{flexGrow:1},required:!0},l),input({id:"points",htmlBefore:"Points:",type:"number",value:n?.points||1,style:{flexGrow:1},required:!0},t);const u=newEl({className:"qbuilder options-div"},s);"MCQ"!=e&&"MRQ"!=e||input({id:"ordered",htmlAfter:"Order Choices",type:"checkbox",checked:n.ordered},u),"PARSONS"==e&&(input({id:"choice_reuse",htmlAfter:"Reuse Choices",type:"checkbox",checked:n.choice_reuse},u),input({id:"max_levels",htmlBefore:"Max Levels:",type:"number",value:n?.max_levels},u)),"OEQ"!=e&&"CODE"!=e||(input({id:"case_sensitive",htmlAfter:"Case Sensitive",type:"checkbox",checked:n.case_sensitive},u),input({id:"space_sensitive",htmlAfter:"Space Sensitive",type:"checkbox",checked:n.space_sensitive},u),input({id:"regex",htmlAfter:"Regex",type:"checkbox",checked:n.regex},u),input({id:"false_check",htmlAfter:"Manual Check If Incorrect",type:"checkbox",checked:n.false_check},u),input({id:"max_lines",htmlBefore:"Max Lines:",type:"number",value:n?.max_lines,style:{flexGrow:1},placeholder:"Enter number of Maximum Lines"},u),input({id:"max_length",htmlBefore:"Max Length (chars):",type:"number",value:n?.max_length,style:{flexGrow:1},placeholder:"Enter Maximum Length (chars)"},u));const p=newEl({className:"qbuilder answers-div",style:{display:"flex",gap:".5em"}},c);if("OEQ"==e&&newEl({tag:"textarea",id:"oeq",rows:10,value:i[n.id]?.join("\n")||"",style:{flexGrow:1}},p),"NRQ"==e&&input({id:"oeq2",htmlBefore:"Answer:",type:"number",value:i[n.id]||0,style:{flexGrow:1}},p),"MCQ"!=e&&"MRQ"!=e||(p.classList.add("mcq"),newEl({tag:"button",id:"add-option-btn",textContent:"Add Option",events:{click:e=>{localStorage.x="hello",d(null,p,n?.id||""),e.preventDefault()}}},p),n.choices?n.choices?.forEach((e=>{d(e,p,n.id)})):(console.log("here"),d(null,p,n?.id),d(null,p,n?.id))),"PARSONS"==e||"CODE"==e){const t=newEl({style:{display:"flex",flexDirection:"column",flexGrow:.2,alignItems:"center",gap:".5em"}},p),o=[];"PARSONS"==e&&newEl({tag:"button",id:"add-option-btn",textContent:"Add Distractor",events:{click:e=>{d(null,t,n?.id||""),e.preventDefault()}}},t);const l=newEl({style:{flexDirection:"column",flexGrow:1}},p);var a=newEl({tag:"select",id:"language"},l),r=newEl({tag:"textarea",id:"parsons",_id:n?.id},l);["text/plain","python","javascript","java","c_cpp","application/json","markdown"].forEach((e=>{newEl({tag:"option",value:e,textContent:e.charAt(0).toUpperCase()+e.slice(1)},a)})),a.value=n?.language||"text/plain",setTimeout((e=>{r._editor=CodeMirror.fromTextArea(r,{lineNumbers:!0,mode:"python",theme:"default",tabSize:4,smartIndent:!0,insertSoftTab:!0}),a.addEventListener("change",(()=>{const e=a.value;r._editor.setOption("mode",e)})),i[n?.id]?r._editor.setValue(i[n.id][0].A.join("\n")):r._editor.setValue(""),r._editor.on("change",(()=>{let e=r._editor.getValue();if(console.log(t),e){let i=e.split("\n").filter((e=>""!==e));console.log("Lines:",i),o.forEach((e=>e.remove())),i.forEach((e=>o.push(d(e,t,n?.id||""))))}}))}),100)}}}function d(e,t,n){let o=i[n]||[],l=null;l="object"==typeof e?o.some((t=>t.id==e.id)):o?.includes(e);let s=newEl({style:{display:"flex",alignItems:"center",justifyContent:"center",gap:"1em"}});t.prepend(s);let c="";e&&(c=e?.content?e.content:e);let a="MCQ"==getEl("categories").value?`<input type="radio" name="${n}" class="answerChoice" _id="${e?.id||""}" choice="${e?.id||c}" ${l?"checked":""}></input>`:`<input type="checkbox" class="answerChoice" _id="${e?.id||""}" choice="${c}" ${l?"checked":""}>`;return"PARSONS"==getEl("categories").value&&(a=""),newEl({innerHTML:`${a}`},s).scrollIntoView({behavior:"smooth"}),newEl({tag:"textarea",id:"choice",_id:e?.id||"",innerHTML:c},s),newEl({tag:"i",className:"icon-btn fa-solid fa-xmark choicecolor",events:{click:e=>{s.remove()}}},s),s}newEl({tag:"span",style:{display:"block",marginBottom:"2em"}},l),Object.keys(t.questions||[]).forEach((s=>{let u=t.questions[s];const d=newEl({style:{display:"flex",alignItems:"center",justifyContent:"center",gap:"1em"}},l),p=newEl({},d),h=showQuestion(p,structuredClone(u),s,c,i[u.id],((e,t)=>{i[e]=[t.a]}));button({innerHTML:'<i class="icon-btn fa-solid fa-pen-to-square"></i> Edit',class:"question-edit-button",onclick:()=>function(e){const t=popup("QID:"+e.id,"",button({textContent:"Update",events:{click:()=>{getEl("my-form").reportValidity()&&(a(e.id),t.close())}}}),"Cancel");r(e,t.main)}(u)},h);const m=newEl({style:{display:"flex",className:"icon-container",flexDirection:"column",gap:"20px"}},d);var f=newEl({tag:"i",className:"icon-btn fa-solid fa-angle-up",events:{click:l=>{const s=t.questions.findIndex((e=>e.id==u.id));if(s>0){const l=t.questions[s];t.questions[s]=t.questions[s-1],t.questions[s-1]=l,quizBuilder(e,t,i,n,o)}}}},m);0==t.questions.findIndex((e=>e.id==u.id))&&f.classList.add("transparent");var g=newEl({tag:"i",className:"icon-btn fa-solid fa-angle-down",events:{click:l=>{const s=t.questions.findIndex((e=>e.id==u.id));if(s<t.questions.length-1){const l=t.questions[s];t.questions[s]=t.questions[s+1],t.questions[s+1]=l,quizBuilder(e,t,i,n,o)}}}},m);t.questions.findIndex((e=>e.id==u.id))==t.questions.length-1&&g.classList.add("transparent"),newEl({tag:"i",class:"icon-btn fa-solid fa-trash-can",style:{marginTop:"1em"},onclick:l=>{const s=popup("","Are you sure you want to DELETE this question? This can NOT be undone!",button({textContent:"YES",events:{click:()=>{t.questions=t.questions.filter((e=>e.id!==u.id)),delete i[u.id],quizBuilder(e,t,i,n,o),s.close()}}}),"Cancel")}},m)}))}