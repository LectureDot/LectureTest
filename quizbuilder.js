import{el,addElementTo,button,importStyleSheet,input,download}from"./ui/common.js";import{showQuestion}from"./showQuestions.js";import{popup}from"./ui/popup.js";import{toast}from"./ui/toast.js";import{marked}from"https://cdn.jsdelivr.net/npm/marked/lib/marked.esm.js";export function quizBuilder(e,t,o,i,l){e.innerHTML="",o||(o={}),console.log(t),input({id:"qtitle",htmlBefore:"Enter Quiz Title:",value:t?.title||""},e),input({id:"category",htmlBefore:"Randomize Questions:",type:"checkbox",checked:"ORD"==t?.category?"":"checked"},e),input({id:"select",htmlBefore:"Number of Quiz Questions To Show:",value:t?.select||""},e),addElementTo(e,{tag:"span",style:{display:"block",marginBottom:"2em"}});const n=addElementTo(e,{style:{display:"flex",alignItems:"center",gap:"1em"}}),a=addElementTo(n,{className:"tooltip-container"});addElementTo(a,{tag:"i",className:"icon-btn fa-solid fa-plus",events:{click:e=>{const t=popup("New Question","",button({textContent:"Save Question",events:{click:()=>{el("my-form").reportValidity()&&(d(),t.close())}}}),"Cancel");r([],t.main)}}}),addElementTo(a,{className:"tooltip-text",innerHTML:"Add Question"});const s=addElementTo(n,{className:"tooltip-container"});addElementTo(s,{tag:"i",className:"icon-btn fa-solid fa-file-export",events:{click:e=>{t.category="on"===el("category").value?"RAND":"ORD",t.select=el("select").value,t.title=el("qtitle").value,t.questions=t.questions,i&&i(t,o),t.category=el("category").checked?"RAND":"ORD",t.select=el("select").value,t.title=el("qtitle").value,t.questions=t.questions,localStorage[t.title]=JSON.stringify(t),localStorage[t.title+"answers"]=JSON.stringify(o)}}}),addElementTo(s,{className:"tooltip-text",innerHTML:"Save Quiz"});const c=addElementTo(n,{className:"tooltip-container"});function d(n){const a={},s=el("all-options");if(!n)do{n=(1e7*Math.random()).toFixed()}while(new Set(t.questions.map((e=>e.id))).has(n));const c=t.questions.findIndex((e=>e.id==n));o[n]=[],a.id=n;let d=el("categories");a.category=d.value,a.choices=[],s.querySelectorAll('input[type="checkbox"]:not(.answerChoice)').forEach((e=>{a[e.id]=e.checked,"false_check"==e.id&&o[n].push(!1)})),s.querySelectorAll('input[type="number"]').forEach((e=>{a[e.id]=Number(e.value)})),s.querySelectorAll('input:not([type="number"], [type="checkbox"], [type="radio"])').forEach((e=>{e.id&&(a[e.id]=e.value)})),s.querySelectorAll('input[type="text"]').forEach((e=>{a.choices.push(e.value)})),s.querySelectorAll("input.answerChoice").forEach((e=>{e.checked&&("object"==typeof t.questions[c].choices[0]?o[n].push({id:e.getAttribute("_id"),content:e.getAttribute("choice")}):o[n].push(e.getAttribute("choice")))})),s.querySelectorAll("select").forEach((e=>{a[e.id]=e.value})),s.querySelectorAll("textarea").forEach((e=>{let i=e._editor?.getValue();if(i){const e=i.split("\n").filter((e=>""!==e));o[n]=[{A:e}];let t=a.max_levels;i=i.split("\n").map((e=>t?e.trim():e)).filter((e=>e)),a.choices.push(...i)}else""!=e.value&&e.id&&("prompt"==e.id||"stimulus"==e.id?a[e.id]=e.value:"choice"==e.id?"object"==typeof t.questions[c].choices[0]?a.choices.push({id:e.getAttribute("_id"),content:e.value}):a.choices.push(e.value):o[n].push(e.value))})),console.log(o),console.log(a),-1!==c?t.questions[c]=a:t.questions.push(a),quizBuilder(e,t,o,i,l)}function r(e,t){const o=e?.category||"Choose Category",i=addElementTo(t,{tag:"form",id:"my-form",className:"container",style:{display:"flex",flexDirection:"column",gap:"8px"}});!function(e,t){const o=addElementTo(e,{tag:"select",id:"categories",events:{change:e=>{u(e.target.value,t,el("all-options"))}}});["Choose Category","MCQ","MRQ","OEQ","NRQ","CODE","MATCH","PARSONS"].forEach((e=>{addElementTo(o,{tag:"option",value:e,textContent:e})}))}(i,e),el("categories").value=o;u(o,e,addElementTo(i,{innerHTML:"",id:"all-options",style:{display:"flex",flexDirection:"column",gap:"8px"}}))}function u(e,t,i){if(e!=t.category&&(i.innerHTML="",t.category=e),"Choose Category"!==e){const a=addElementTo(i,{className:"qbuilder gen-div"});input({id:"title",htmlBefore:"Title:",value:t?.title||"",placeholder:"Enter your title (Required)",style:{flexGrow:1},required:!0},a);const s=addElementTo(a,{tag:"span",innerHTML:"Stimulus:",style:{display:"flex"}});addElementTo(s,{tag:"textarea",id:"stimulus",value:marked.parse(t?.stimulus||""),rows:8,placeholder:"Enter your stimulus",style:{flexGrow:1}});const c=addElementTo(a,{tag:"span",innerHTML:"Prompt:",style:{display:"flex"}});addElementTo(c,{tag:"textarea",id:"prompt",value:marked.parse(t?.prompt||""),rows:8,placeholder:"Enter your prompt (Required)",style:{flexGrow:1},required:!0}),input({id:"points",htmlBefore:"Points:",type:"number",value:t?.points||1,style:{flexGrow:1},required:!0},a);const d=addElementTo(i,{className:"qbuilder options-div"});"MCQ"!=e&&"MRQ"!=e||input({id:"ordered",htmlAfter:"Order Choices",type:"checkbox",checked:t.ordered},d),"PARSONS"==e&&(input({id:"choice_reuse",htmlAfter:"Reuse Choices",type:"checkbox",checked:t.choice_reuse},d),input({id:"max_levels",htmlBefore:"Max Levels:",type:"number",value:t?.max_levels},d)),"OEQ"!=e&&"CODE"!=e||(i.innerHTML+=`\n        <span style="display: flex;">Max Lines:<input id="max_lines" placeholder="Enter number of Maximum Lines" style="flex-grow: 1;" type="number" min="0" value=${t?.max_lines||""}></span>\n        <span style="display: flex;">Max Length (chars):<input id="max_length" placeholder="Enter Maximum Length (char)" style="flex-grow: 1;" type="number" min="20" value=${t?.max_length||""}></span>\n        <label for="case_sensitive"><input type="checkbox" id="case_sensitive" value="case_sensitive" ${t?.case_sensitive?"checked":""}> Case Sensitive</label>\n        <label for="space_sensitive"><input type="checkbox" id="space_sensitive" value="space_sensitive" ${t?.space_sensitive?"checked":""}> Space Sensitive</label>\n        <label for="regex"><input type="checkbox" id="regex" value="regex" ${t?.regex?"checked":""}> Regex</label>\n        <label for="false_check"><input type="checkbox" id="false_check" value="false_check" ${t?.false_check?"checked":""}> Manual Check If Incorrect </label>\n        `);const r=addElementTo(i,{className:"qbuilder answers-div"});if("OEQ"==e&&(i.innerHTML+=`\n        <textarea id="oeq" rows=10>${o[t.id]?.join("\n")||""}</textarea>`),"NRQ"==e&&(console.log("NRQ"),i.innerHTML+=`\n        <span style="display: flex;">Answer:<input id="oeq2" type="number" style="flex-grow: 1;" value="${o[t.id]||0}"></span>`),"MCQ"!=e&&"MRQ"!=e||(addElementTo(r,{tag:"button",id:"add-option-btn",textContent:"Add Option",events:{click:e=>{p(null,r,t?.id||"")}}}),t?t.choices?.forEach((e=>{p(e,r,t.id)})):(p(null,r,t?.id),p(null,r,t?.id))),"PARSONS"==e){const e=addElementTo(r,{});addElementTo(e,{tag:"button",id:"add-option-btn",textContent:"Add Distractors",events:{click:o=>{p(null,e,t?.id||"")}}})}if("PARSONS"==e||"CODE"==e){var l=addElementTo(r,{tag:"select",id:"language"}),n=addElementTo(r,{tag:"textarea",id:"parsons",_id:t?.id});["text/plain","python","javascript","java","c_cpp","application/json","markdown"].forEach((e=>{addElementTo(l,{tag:"option",value:e,textContent:e.charAt(0).toUpperCase()+e.slice(1)})})),l.value=t?.language||"text/plain",setTimeout((e=>{n._editor=CodeMirror.fromTextArea(n,{lineNumbers:!0,mode:"python",theme:"default",tabSize:4,smartIndent:!0,insertSoftTab:!0}),l.addEventListener("change",(()=>{const e=l.value;n._editor.setOption("mode",e)})),o[t?.id]?n._editor.setValue(o[t.id][0].A.join("\n")):n._editor.setValue("")}),100)}}}function p(e,t,i){console.log(e,t,i);let l=o[i]||[],n=null;n="object"==typeof e?l.some((t=>t.id==e.id)):l?.includes(e);let a=addElementTo(t,{style:{display:"flex",alignItems:"center",justifyContent:"center",gap:"1em"}}),s=e.content?e.content:e||"",c="MCQ"==el("categories").value?`<input type="radio" name="${i}" class="answerChoice" _id="${e?.id||""}" choice="${e?.id||s}" ${n?"checked":""}></input>`:`<input type="checkbox" class="answerChoice" _id="${e?.id||""}" choice="${s}" ${n?"checked":""}>`;"PARSONS"==el("categories").value&&(c=""),addElementTo(a,{innerHTML:`${c}`}).scrollIntoView({behavior:"smooth"}),addElementTo(a,{tag:"textarea",id:"choice",_id:e?.id||"",innerHTML:s}),addElementTo(a,{tag:"i",className:"icon-btn fa-solid fa-xmark choicecolor",events:{click:e=>{a.remove()}}})}addElementTo(c,{tag:"i",className:"icon-btn fa-solid fa-door-closed",events:{click:e=>{l&&l()}}}),addElementTo(c,{className:"tooltip-text",innerHTML:"Exit QuizBuilder"}),Array.isArray(t.questions)||(t.questions=Object.values(t.questions||[])),addElementTo(e,{tag:"span",style:{display:"block",marginBottom:"2em"}}),Object.keys(t.questions||[]).forEach((n=>{let a=t.questions[n];const s=addElementTo(e,{style:{display:"flex",alignItems:"center",justifyContent:"center",gap:"1em"}}),c=addElementTo(s,{}),u=(showQuestion(c,structuredClone(a),n),addElementTo(s,{style:{display:"flex",className:"icon-container",flexDirection:"column",gap:"20px"}}));addElementTo(u,{tag:"i",className:"icon-btn fa-solid fa-pen-to-square",events:{click:e=>{const t=popup("QID:"+a.id,"",button({textContent:"Update",style:{minWidth:"700px"},events:{click:()=>{if(el("my-form").reportValidity()){const e=popup("","Are you sure you want to UPDATE this question?",button({textContent:"YES",events:{click:()=>{d(a.id),e.close(),t.close()}}}),"No")}}}}),"Cancel");r(a,t.main)}}}),addElementTo(u,{tag:"i",className:"icon-btn fa-solid fa-trash-can",events:{click:n=>{const s=popup("","Are you sure you want to DELETE this question? This can NOT be undone!",button({textContent:"YES",events:{click:()=>{t.questions=t.questions.filter((e=>e.id!==a.id)),delete o[a.id],quizBuilder(e,t,o,i,l),s.close()}}}),"No")}}})}))}