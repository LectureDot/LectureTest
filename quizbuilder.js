import{getEl,button,input,newEl,isObj,span,isArr}from"./ui/common.js";import{showQuestion}from"./showQuestions.js";import{confirmPopup,popup}from"./ui/popup.js";import{toast,toastError,toastWarn}from"./ui/toast.js";import{codeEditor,EDITOR_LANGUAGES}from"./ui/editor.js";import styles from"./quizbuilder.css"with{type:"css"};document.adoptedStyleSheets.push(styles);const ALLOWED_POSITION_EDITING_KEYS=new Set(["1","2","3","4","5","6","7","8","9","0","ArrowLeft","ArrowRight","Backspace","Delete","Home","End","Enter"]);export function quizBuilder(e,t,n,i,o){console.log(t),e.innerHTML="",n||(n={});const s=e,l=t?.i?.[0]===localStorage.email;input({id:"qtitle",htmlBefore:"Exam Title:",class:"bigger",value:t?.title||""},s),input({id:"category",htmlBefore:"Randomize Questions:",type:"checkbox",checked:"ORD"==t?.category?"":"checked"},s),input({id:"select",htmlBefore:"Number of Quiz Questions To Show:",value:t?.select||""},s),newEl({innerText:"Exam Description (markdown; shown prior to exam):"},s);let a=newEl({style:{width:"25em",height:"3.5em",resize:"both",overflow:"auto"}},s);codeEditor({id:"description",value:t?.description||"",lang:"markdown",lineNumbers:!0,lineWrapping:!0},a),newEl({innerText:"Exam Instructions (markdown; shown during exam):"},s),codeEditor({id:"instructions",value:t?.instructions||"",lang:"markdown",lineNumbers:!0,lineWrapping:!0,style:{width:"25em",height:"6.25em"}},s),input({id:"R",htmlBefore:"EXAM IS READ ONLY:",type:"checkbox",checked:t?.R?"checked":"",events:{input:n=>{e.className=n.target.checked?"readonly":"qouter",t.R=n.target.checked}}},s),e.className=t?.R?"readonly":"qouter",newEl({tag:"span",style:{display:"block",marginBottom:"2em"}},s);const r=newEl({class:"builder-control-row"},s);function c(e,n,i,o){if(i>=t.questions.length&&(i=t.questions.length-1),i<0&&(i=0),n===i)return;const l=n<i;if(i===t.questions.length-1)s.appendChild(e);else{const n=s.querySelector(`#q${t.questions[i+l].id}`);s.insertBefore(e,n)}t.questions.splice(n,1),t.questions.splice(i,0,o);for(let e=Math.min(n,i);e<=Math.max(n,i);e++){const n=s.querySelector(`#q${t.questions[e].id}`),o=n.querySelector(".builderQuestionNumberInput");o.value=e+1,o.style.width=(e+1).toString().length+1+"ch",e===i&&o.focus(),0===e?n.querySelector(".fa-angle-up").classList.add("transparent"):n.querySelector(".fa-angle-up").classList.remove("transparent"),e===t.questions.length-1?n.querySelector(".fa-angle-down").classList.add("transparent"):n.querySelector(".fa-angle-down").classList.remove("transparent")}e.scrollIntoView({behavior:"smooth",block:"start"})}button({innerHTML:'<i class="icon-btn fa-solid fa-plus"></i> Add Question',onclick:()=>{if(t.R)return void toastWarn("Cannot add question. This exam is marked as read-only.");const e={};let n;const i=new Set(t.questions.map((e=>e.id)));do{n=(1e7*Math.random()).toFixed()}while(i.has(n));e.id=n;const o=popup("New Question","",button({textContent:"Save Question",onclick:()=>{t.R?toastWarn("Cannot save question. This exam is read-only."):getEl("my-form").reportValidity()&&d(e.id)&&o.close()}}),"Cancel",null,{class:"large"});p(e,o.main)}},r),button({innerHTML:'<i class="icon-btn fa-solid fa-user-plus"></i> Share',onclick:()=>{var e=t.i||[localStorage.email];const n=newEl();function i(t,o){const s=newEl({class:"small flex-row"},n);0===o?span({innerText:"Owner:",style:{fontWeight:"bold"}},s):(span({innerHTML:'<i class="icon-btn fa-solid fa-user-times" title="Remove instructor."></i>',onclick:()=>{if(t===localStorage.email){confirmPopup("","Are you sure you want to remove yourself from this exam?","Remove",(()=>{s.remove(),e=e.filter((e=>e!==t))}),"Cancel")}else s.remove(),e=e.filter((e=>e!==t))}},s),l&&span({innerHTML:'<i class="icon-btn fa-solid fa-arrow-circle-up" title="Make this instructor the new owner."></i>',onclick:()=>{confirmPopup("Changing Exam Owner",["Are you sure you want change the owner for this exam?",`If you proceed, ${t} will become the new owner for this exam.`],"Change Owner",(()=>{e=[t].concat(e.filter((e=>e!==t))),n.innerHTML="",e.forEach(i)}),"Cancel")}},s)),span({innerText:t,style:{fontWeight:"bold"}},s),t===localStorage.email&&span({innerText:"(myself)"},s)}e.forEach(i);const o=popup("Exam Instructors",n,[button({innerText:"Add Instructor",onclick:()=>{const t=input({type:"email",placeholder:"Email address",required:!0}),n=popup("Add Instructor",["Enter email address for new instructor:",t],button({innerText:"OK",onclick:()=>{if(t.input.reportValidity()){if(e.includes(t.input.value))return void toast("This email is already in the list of instructors for this exam.");e.push(t.input.value),i(t.input.value,e.length-1),n.close()}}}),"Cancel")}}),button({innerText:"OK",onclick:()=>{t.i=e,toast("Instructor list updated. Don't forget to save the exam for changes to take effect."),o.close()}})],"Cancel")}},r),button({innerHTML:'<i class="icon-btn fa-solid fa-save"></i> Save',onclick:()=>{!function(){t.category=getEl("category").checked?"RAND":"ORD",t.select=getEl("select").value,t.title=getEl("qtitle").value,t.questions=t.questions,t.R=getEl("R").checked,t.instructions=getEl("instructions").value,t.description=getEl("description").value;const e=t.questions.map((e=>e.id));Object.keys(n).forEach((t=>{"_"===t||e.includes(t)||(n[t]=void 0)})),i&&i(t,n);console.log("save quiz",t,n)}()}},r),button({innerHTML:'<i class="icon-btn fa-solid fa-door-closed"></i> Exit',onclick:()=>{o&&o()}},r),t.questions||(t.questions=[]),isObj(t.questions)&&(t.questions=Object.values(t.questions));const u={};function d(s){try{const l={},a=getEl("all-options"),r=t.questions.findIndex((e=>e.id==s));n[s]=[],l.id=s;let c=getEl("categories");return l.category=c.value,l.choices=[],a.querySelectorAll('input[type="number"]').forEach((e=>{e.reportValidity()&&(l[e.id]=Number(e.value))})),a.querySelectorAll('input:not([type="number"], [type="checkbox"], [type="radio"])').forEach((e=>{e.reportValidity()&&e.id&&(l[e.id]=e.value)})),a.querySelectorAll('input[type="checkbox"]:not(.answerChoice)').forEach((e=>{l[e.id]=e.checked,"false_check"==e.id&&e.checked&&!n[s].includes(!1)&&n[s].push(!1)})),a.querySelectorAll("textarea.answerChoiceText").forEach((e=>{"object"==typeof t.questions[r]?.choices[0]?l.choices.push({id:e.getAttribute("_id"),content:e.value}):l.choices.push(e.value)})),a.querySelectorAll("input.answerChoice").forEach((e=>{console.log(e,e.checked,e.getAttribute("choice")),e.checked&&("MRQ"===c.value?(n[s][0]||(n[s][0]={A:[]}),n[s][0].A.push(e.getAttribute("choice"))):"object"==typeof t.questions[r]?.choices[0]?n[s].push({id:e.getAttribute("_id"),content:e.getAttribute("choice")}):n[s].push(e.getAttribute("choice")))})),a.querySelectorAll("select").forEach((e=>{l[e.id]=e.value})),a.querySelectorAll(".CodeMirror").forEach((e=>{let t=e.value.trim();if("prompt"==e.id)l[e.id]=t;else if("unit_tests"==e.id)if(t)try{t=JSON.parse(t),isArr(t)||(t=[t]),l.unit_tests=t}catch(e){return void toastError("Error parsing unit tests.\n"+e.toString())}else l.unit_tests=[];else if(t&&e.classList.contains("answer-editor"))if("CODE"===c.value)n[s]=JSON.parse(t);else{try{t=JSON.parse(t)}catch(e){}n[s].push(t)}})),console.log(n),console.log(l),-1!==r?t.questions[r]=l:t.questions.push(l),t.category=getEl("category").checked?"RAND":"ORD",t.R=getEl("R").checked,t.select=getEl("select").value,t.title=getEl("qtitle").value,t.instructions=getEl("instructions").value,t.description=getEl("description").value,quizBuilder(e,t,n,i,o),!0}catch(e){toastError("Error saving question.\n"+e.toString())}}function p(e,t){const n=e?.category||"Choose Category",i=newEl({tag:"form",id:"my-form",className:"container",style:{display:"flex",flexDirection:"column",gap:"8px"}},t);i.classList.add("back","qbuilder"),function(e,t){const n=newEl({tag:"select",id:"categories",events:{change:e=>{h(e.target.value,t,getEl("all-options"))}}},e);["Choose Category","MCQ","MRQ","OEQ","NRQ","CODE","MATCH","PARSONS"].forEach((e=>{newEl({tag:"option",value:e,textContent:e},n)}))}(i,e),getEl("categories").value=n;h(n,e,newEl({innerHTML:"",id:"all-options",style:{display:"flex",flexDirection:"row",gap:"2px",justifyContent:"center"}},i))}function h(e,t,i){if(console.log("q",t),e!=t.category&&(i.innerHTML="",t.category=e),!t.id)return void console.error("No ID found for question.");const o=newEl({className:"qbuilder",style:{display:"flex",flexDirection:"column",gap:"6px",flex:.3}},i),s=newEl({className:"qbuilder",style:{display:"flex",flexDirection:"column",flex:1}},i);if("Choose Category"!==e){const c=newEl({className:"qbuilder gen-div"},o);input({id:"title",htmlBefore:"Title:",value:t?.title||"",placeholder:"Enter your title (Required)",style:{flexGrow:1},required:!0},c);newEl({tag:"span",innerHTML:"Prompt:",style:{display:"flex"}},c);codeEditor({id:"prompt",value:t?.prompt||"",lang:"markdown",lineNumbers:!0,lineWrapping:!0,style:{height:"10em",width:"30em"}},c),input({id:"points",htmlBefore:"Points:",type:"number",value:t?.points||1,style:{flexGrow:1},required:!0},c);const u=newEl({className:"qbuilder options-div"},o);if("MCQ"!=e&&"MRQ"!=e||input({id:"ordered",htmlAfter:"Order Choices",type:"checkbox",checked:t.ordered},u),"PARSONS"==e){var l=newEl({tag:"select",id:"language"},u);input({id:"choice_reuse",htmlAfter:"Reuse Choices",type:"checkbox",checked:t.choice_reuse},u),input({id:"max_levels",htmlBefore:"Max Levels:",type:"number",value:t?.max_levels},u)}if(("OEQ"==e||"CODE"==e)&&(input({id:"max_lines",htmlBefore:"Max Lines:",min:0,type:"number",value:t?.max_lines||"",placeholder:"No limit",oninput:e=>{"0"===e.target.value&&(e.target.value="")}},u),input({id:"max_length",htmlBefore:"Max Chars:",min:0,type:"number",value:t?.max_length||"",placeholder:"No limit",oninput:e=>{"0"===e.target.value&&(e.target.value="")}},u),input({id:"case_sensitive",htmlAfter:"Case Sensitive",type:"checkbox",checked:t.case_sensitive},u),input({id:"space_sensitive",htmlAfter:"Space Sensitive",type:"checkbox",checked:t.space_sensitive},u),input({id:"false_check",htmlAfter:"Manual Check If Incorrect",type:"checkbox",checked:t.false_check},u),"CODE"===e)){l=newEl({tag:"select",id:"language"},u);input({id:"await_input",htmlAfter:"Convert `input()` to `await input()`",type:"checkbox",checked:t.await_input??!0},u),input({id:"max_output",htmlBefore:"Max output size:<br>(including newline characters)",min:1,max:1e5,step:1,type:"number",value:t?.max_output||"1000",oninput:e=>{e.target.reportValidity()},onchange:e=>{e.target.value||(e.target.value=1e3)},labelStyle:{alignItems:"flex-start"}},u),input({id:"runtime_limit",htmlBefore:"Max runtime:",htmlAfter:"s",min:0,type:"number",value:t?.runtime_limit||10,placeholder:"No limit",oninput:e=>{"0"===e.target.value?e.target.value="":e.target.reportValidity()}},u),input({id:"run",htmlAfter:"Display Run Button",type:"checkbox",checked:t.run},u),newEl({innerText:"Unit Tests:"},u);let p="[]";if(t?.unit_tests)try{p=JSON.stringify(t.unit_tests,null,2)}catch(h){console.error(h)}codeEditor({id:"unit_tests",value:p,lang:"json",lineNumbers:!0,lineWrapping:!0,style:{height:"10em",width:"30em"}},u)}newEl({innerText:"Answers"},s);const d=newEl({className:"qbuilder answers-div",style:{display:"flex",flexDirection:"column",gap:".5em"}},s);if("OEQ"==e){function a(e){e.target.value||e.target.remove();d.querySelector("textarea:last-child").value&&r()}function r(e=""){newEl({tag:"textarea",class:"answer-editor",rows:4,cols:50,style:{flexGrow:1},onchange:a,value:e},d)}for(let f of n[t.id]||[])"object"==typeof f&&(f=JSON.stringify(f,null,2)),r(f);r()}if("NRQ"==e&&input({htmlBefore:"Answer:",type:"number",value:n[t.id]||0,style:{flexGrow:1}},d),"MCQ"!=e&&"MRQ"!=e||(d.classList.add("mcq"),newEl({tag:"button",id:"add-option-btn",textContent:"Add Option",events:{click:e=>{localStorage.x="hello",m(null,d,t?.id||""),e.preventDefault()}}},d),t.choices?t.choices?.forEach((e=>{m(e,d,t.id)})):(m(null,d,t?.id),m(null,d,t?.id))),"PARSONS"!=e&&"CODE"!=e||(Object.keys(EDITOR_LANGUAGES).forEach((e=>{newEl({tag:"option",value:e,textContent:e},l)})),l.value=t?.language||"python"),"CODE"==e){const g=newEl({style:{flexDirection:"column",flexGrow:1}},d),y=codeEditor({class:"answer-editor",lang:"json"},g);t?.id&&n[t.id]&&(y.value=JSON.stringify(n[t.id],null,2))}if("PARSONS"==e){const E=newEl({style:{display:"flex",flexDirection:"column",flexGrow:.2,alignItems:"center",gap:".5em"}},d),w=[];newEl({tag:"button",id:"add-option-btn",textContent:"Add Distractor",onclick:e=>{m(null,E,t?.id||""),e.preventDefault()}},E);const v=newEl({style:{flexDirection:"column",flexGrow:1}},d),x=codeEditor({class:"answer-editor",lang:l.value},v);l.addEventListener("change",(()=>{x.setOption("mode",l.value)})),n[t?.id]&&n[t.id][0]?.A&&(x.value=n[t.id][0].A.join("\n")),x.on("change",(()=>{if(x.value){let e=x.value.split("\n").filter((e=>""!==e));w.forEach((e=>e.remove())),e.forEach((e=>w.push(m(e,E,t?.id||""))))}}))}}}function m(e,i,o){let s=n[o]||[];const l=t.questions.findIndex((e=>e.id==o));console.log("qanswers",s,n,e),console.log(o,t.questions[l]);let a=null;a=e&&"object"==typeof e?s.some((t=>t.id==e.id)):s?.[0]?.A?.includes(e)||s?.includes(e);let r=newEl({style:{display:"flex",alignItems:"center",justifyContent:"center",gap:"1em"}});i.append(r);let c="";e&&(c=e?.content?e.content:e);const u=getEl("categories").value;let d;"MCQ"===u?d=newEl({tag:"input",type:"radio",name:o,class:"answerChoice",_id:e?.id||"",choice:c},r):"MRQ"===u&&(d=newEl({tag:"input",type:"checkbox",class:"answerChoice",_id:e?.id||"",choice:c},r)),d&&a&&d.setAttribute("checked",!0),newEl({tag:"textarea",class:"answerChoiceText",_id:e?.id||"",innerHTML:c,rows:3,cols:50,onchange:e=>{d&&d.setAttribute("choice",e.target.value)}},r),newEl({tag:"i",className:"icon-btn fa-solid fa-xmark choicecolor",onclick:e=>r.remove()},r);var p=newEl({tag:"i",className:"icon-btn fa-solid fa-angle-up",onclick:n=>{const o=t.questions[l].choices.findIndex((t=>t==e));if(o>0){const e=i.children[o+1],n=i.children[o];i.insertBefore(e,n);const s=t.questions[l].choices[o];t.questions[l].choices[o]=t.questions[l].choices[o-1],t.questions[l].choices[o-1]=s,console.log(t.questions[l].choices),n.children[4].classList.add("transparent"),o==t.questions[l].choices.length-2&&p.classList.remove("transparent"),0==o&&h.classList.add("transparent")}}},r),h=newEl({tag:"i",className:"icon-btn fa-solid fa-angle-down",onclick:n=>{const o=t.questions[l].choices.findIndex((t=>t==e));if(o<t.questions[l].choices.length-1){const e=i.children[o+1],n=i.children[o+2];i.insertBefore(n,e);const s=t.questions[l].choices[o];t.questions[l].choices[o]=t.questions[l].choices[o+1],t.questions[l].choices[o+1]=s,console.log(t.questions[l].choices),console.log(n),n.children[3].classList.add("transparent"),o==t.questions[l].choices.length-2&&h.classList.add("transparent"),0==o&&p.classList.remove("transparent")}}},r);return r}newEl({tag:"span",style:{display:"block",marginBottom:"2em"}},s),(t.questions||[]).forEach(((l,a)=>{const r=newEl({id:"q"+l.id,style:{display:"flex",alignItems:"center",justifyContent:"center",scrollMarginTop:"7em",gap:"1em"}},s),h=newEl({},r);console.log("a",n[l.id]);let m=n[l.id]?.[0];m&&"MRQ"===l.category&&(m=m.A),"object"==typeof m&&(m=JSON.stringify(m,null,2));const f=showQuestion(h,structuredClone(l),a,u,m,((e,t)=>{if("MRQ"==l.category)n[e][0]=t.a?.length?{A:t.a}:void 0,toast("Answer updated. Don't forget to save the exam.");else if("MCQ"==l.category)n[e][0]=t.a,toast("Answer updated. Don't forget to save the exam.");else if("OEQ"==l.category||"CODE"==l.category){if(t.a.trim().startsWith("{")&&t.a.trim().endsWith("}")){let e=f.querySelector(".editor-controls");e||(e=f.appendChild(document.createElement("div")),e.classList.add("editor-controls"));let n=e.querySelector("span");n||(n=e.appendChild(document.createElement("span")));try{t.a=JSON.parse(t.a),n.innerHTML=""}catch(e){return void(n.innerHTML='<span style="color:red;font-weight:bold;">Invalid JSON.<span>')}}n[e][0]=t.a,toast("Answer updated. Don't forget to save the exam.")}})),g=newEl({class:"top-right small flex-row"},f);button({innerHTML:'<i class="icon-btn fa-solid fa-pen-to-square"></i> Edit',onclick:()=>function(e){const n=popup("QID:"+e.id,"",button({textContent:"Update",onclick:()=>{t.R?toastWarn("Cannot save question. This exam is read-only."):getEl("my-form").reportValidity()&&d(e.id)&&n.close()}}),"Cancel",null,{class:"large"});p(e,n.main)}(l),class:"small"},g);const y=newEl({style:{display:"flex",className:"icon-container",flexDirection:"column",gap:"0.5em",alignItems:"center"}},r);newEl({tag:"i",class:"icon-btn fa-solid fa-copy",style:{marginBottom:"1em"},onclick:s=>{const a=structuredClone(l);do{a.id=(1e7*Math.random()).toFixed()}while(t.questions.some((e=>e.id===a.id)));t.questions.push(a),quizBuilder(e,t,n,i,o),e.scrollIntoView({block:"end",behavior:"smooth"})}},y);var E=newEl({tag:"i",className:"icon-btn fa-solid fa-angle-up",onclick:e=>{const n=t.questions.findIndex((e=>e.id==l.id));c(r,n,n-1,l)}},y);0===a&&E.classList.add("transparent"),input({pattern:"[0-9]*",class:"builderQuestionNumberInput",style:{minWidth:"2ch",width:(a+1).toString().length+1+"ch",fontFamily:"fixed",textAlign:"center"},value:a+1,min:1,max:t.questions.length,step:1,oninput:e=>{e.target.style.width=e.target.value.length+1+"ch"},onchange:e=>{let n=Number(e.target.value);const i=t.questions.findIndex((e=>e.id==l.id));""===e.target.value.trim()||isNaN(n)||!Number.isInteger(n)||n<1?e.target.value=i+1:(n>t.questions.length&&(n=t.questions.length),c(r,i,n-1,l))},onkeydown:e=>{if(ALLOWED_POSITION_EDITING_KEYS.has(e.key)||e.preventDefault(),"ArrowDown"===e.key){const e=t.questions.findIndex((e=>e.id==l.id));c(r,e,e+1,l)}else if("ArrowUp"===e.key){const e=t.questions.findIndex((e=>e.id==l.id));c(r,e,e-1,l)}}},y);var w=newEl({tag:"i",className:"icon-btn fa-solid fa-angle-down",onclick:e=>{const n=t.questions.findIndex((e=>e.id==l.id));c(r,n,n+1,l)}},y);a===t.questions.length-1&&w.classList.add("transparent"),newEl({tag:"i",class:"icon-btn fa-solid fa-trash-can",style:{marginTop:"1em"},onclick:s=>{const a=popup("","Are you sure you want to DELETE this question? This can NOT be undone!",button({textContent:"Delete question",onclick:()=>{t.questions=t.questions.filter((e=>e.id!==l.id)),delete n[l.id],quizBuilder(e,t,n,i,o),a.close()}}),"Cancel")}},y)}))}