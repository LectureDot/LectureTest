import{el,addElementTo,button,importStyleSheet,input,download,newEl}from"./ui/common.js";import{showQuestion}from"./showQuestions.js";import{popup}from"./ui/popup.js";import{toast}from"./ui/toast.js";import{marked}from"https://cdn.jsdelivr.net/npm/marked/lib/marked.esm.js";export function quizBuilder(e,t,o,l,i){e.innerHTML="",o||(o={}),console.log(t),input({id:"qtitle",htmlBefore:"Enter Quiz Title:",value:t?.title||""},e),input({id:"category",htmlBefore:"Randomize Questions:",type:"checkbox",checked:"ORD"==t?.category?"":"checked"},e),input({id:"select",htmlBefore:"Number of Quiz Questions To Show:",value:t?.select||""},e),input({id:"instructions",htmlBefore:"Specify Instructrions To Show:",value:t?.instructions||""},e),input({id:"R",htmlBefore:"EXAM IS READ ONLY:",type:"checkbox",checked:t?.R?"checked":""},e),e.className=t?.R?"readonly":"qouter",addElementTo(e,{tag:"span",style:{display:"block",marginBottom:"2em"}});const n=addElementTo(e,{style:{display:"flex",alignItems:"center",gap:"1em"}}),a=addElementTo(n,{className:"tooltip-container"});addElementTo(a,{tag:"i",className:"icon-btn fa-solid fa-plus",events:{click:e=>{const o=popup("New Question","",button({textContent:"Save Question",style:{minWidth:"700px"},events:{click:()=>{el("my-form").reportValidity()&&(console.log("new question",t.R),t.R||d(),o.close())}}}),"Cancel");u([],o.main)}}}),addElementTo(a,{className:"tooltip-text",innerHTML:"Add Question"});const s=addElementTo(n,{className:"tooltip-container"});addElementTo(s,{tag:"i",className:"icon-btn fa-solid fa-file-export",events:{click:e=>{!function(){t.category="on"===el("category").value?"RAND":"ORD",t.select=el("select").value,t.title=el("qtitle").value,t.questions=t.questions,t.R=el("R").checked,t.instructions=el("instructions").value,l&&l(t,o);localStorage[t.title]=JSON.stringify(t),localStorage[t.title+"answers"]=JSON.stringify(o)}()}}}),addElementTo(s,{className:"tooltip-text",innerHTML:"Save Quiz"});const c=addElementTo(n,{className:"tooltip-container"});addElementTo(c,{tag:"i",className:"icon-btn fa-solid fa-door-closed",events:{click:e=>{i&&i()}}}),addElementTo(c,{className:"tooltip-text",innerHTML:"Exit QuizBuilder"}),Array.isArray(t.questions)||(t.questions=Object.values(t.questions||[]));const r={};function d(n){const a={},s=el("all-options"),c=t.questions.findIndex((e=>e.id==n));o[n]=[],a.id=n;let r=el("categories");a.category=r.value,a.choices=[],s.querySelectorAll('input[type="checkbox"]:not(.answerChoice)').forEach((e=>{a[e.id]=e.checked,"false_check"==e.id&&o[n].push(!1)})),s.querySelectorAll('input[type="number"]').forEach((e=>{a[e.id]=Number(e.value)})),s.querySelectorAll('input:not([type="number"], [type="checkbox"], [type="radio"])').forEach((e=>{e.id&&(a[e.id]=e.value)})),s.querySelectorAll('input[type="text"]').forEach((e=>{a.choices.push(e.value)})),s.querySelectorAll("input.answerChoice").forEach((e=>{e.checked&&("object"==typeof t.questions[c].choices[0]?o[n].push({id:e.getAttribute("_id"),content:e.getAttribute("choice")}):o[n].push(e.getAttribute("choice")))})),s.querySelectorAll("select").forEach((e=>{a[e.id]=e.value})),s.querySelectorAll("textarea").forEach((e=>{let l=e._editor?.getValue();if(l){const e=l.split("\n").filter((e=>""!==e));o[n]=[{A:e}];let t=a.max_levels;l=l.split("\n").map((e=>t?e.trim():e)).filter((e=>e)),a.choices.push(...l)}else""!=e.value&&e.id&&("prompt"==e.id||"stimulus"==e.id?a[e.id]=e.value:"choice"==e.id?"object"==typeof t.questions[c]?.choices[0]?a.choices.push({id:e.getAttribute("_id"),content:e.value}):a.choices.push(e.value):o[n].push(e.value))})),console.log(o),console.log(a),-1!==c?t.questions[c]=a:t.questions.push(a),t.category=el("category").checked?"RAND":"ORD",t.R=el("R").checked,t.select=el("select").value,t.title=el("qtitle").value,t.instructions=el("instructions").value,quizBuilder(e,t,o,l,i)}function u(e,t){const o=e?.category||"Choose Category",l=addElementTo(t,{tag:"form",id:"my-form",className:"container",style:{display:"flex",flexDirection:"column",gap:"8px"}});l.classList.add("back","qbuilder"),function(e,t){const o=addElementTo(e,{tag:"select",id:"categories",events:{change:e=>{p(e.target.value,t,el("all-options"))}}});["Choose Category","MCQ","MRQ","OEQ","NRQ","CODE","MATCH","PARSONS"].forEach((e=>{addElementTo(o,{tag:"option",value:e,textContent:e})}))}(l,e),el("categories").value=o;p(o,e,addElementTo(l,{innerHTML:"",id:"all-options",style:{display:"flex",flexDirection:"row",gap:"2px",justifyContent:"center"}}))}function p(e,l,i){var n=0;if(e!=l.category&&(i.innerHTML="",l.category=e),!l.id){do{n=(1e7*Math.random()).toFixed()}while(new Set(t.questions.map((e=>e.id))).has(n));l.id=n}const a=addElementTo(i,{className:"qbuilder",style:{display:"flex",flexDirection:"column",gap:"6px",flex:.3}}),s=addElementTo(i,{className:"qbuilder",style:{display:"flex",flexDirection:"column",flex:1}});if("Choose Category"!==e){const t=addElementTo(a,{className:"qbuilder gen-div"});input({id:"title",htmlBefore:"Title:",value:l?.title||"",placeholder:"Enter your title (Required)",style:{flexGrow:1},required:!0},t);const i=addElementTo(t,{tag:"span",innerHTML:"Stimulus:",style:{display:"flex"}});addElementTo(i,{tag:"textarea",id:"stimulus",value:marked.parse(l?.stimulus||""),rows:6,placeholder:"Enter your stimulus",style:{flexGrow:1}});const n=addElementTo(t,{tag:"span",innerHTML:"Prompt:",style:{display:"flex"}});addElementTo(n,{tag:"textarea",id:"prompt",value:marked.parse(l?.prompt||""),rows:6,placeholder:"Enter your prompt (Required)",style:{flexGrow:1},required:!0}),input({id:"points",htmlBefore:"Points:",type:"number",value:l?.points||1,style:{flexGrow:1},required:!0},t);const d=addElementTo(a,{className:"qbuilder options-div"});"MCQ"!=e&&"MRQ"!=e||input({id:"ordered",htmlAfter:"Order Choices",type:"checkbox",checked:l.ordered},d),"PARSONS"==e&&(input({id:"choice_reuse",htmlAfter:"Reuse Choices",type:"checkbox",checked:l.choice_reuse},d),input({id:"max_levels",htmlBefore:"Max Levels:",type:"number",value:l?.max_levels},d)),"OEQ"!=e&&"CODE"!=e||(input({id:"case_sensitive",htmlAfter:"Case Sensitive",type:"checkbox",checked:l.case_sensitive},d),input({id:"space_sensitive",htmlAfter:"Space Sensitive",type:"checkbox",checked:l.space_sensitive},d),input({id:"regex",htmlAfter:"Regex",type:"checkbox",checked:l.regex},d),input({id:"false_check",htmlAfter:"Manual Check If Incorrect",type:"checkbox",checked:l.false_check},d),input({id:"max_lines",htmlBefore:"Max Lines:",type:"number",value:l?.max_lines,style:{flexGrow:1},placeholder:"Enter number of Maximum Lines"},d),input({id:"max_length",htmlBefore:"Max Length (chars):",type:"number",value:l?.max_length,style:{flexGrow:1},placeholder:"Enter Maximum Length (chars)"},d));const u=addElementTo(s,{className:"qbuilder answers-div",style:{display:"flex",gap:".5em"}});if("OEQ"==e&&addElementTo(u,{tag:"textarea",id:"oeq",rows:10,value:o[l.id]?.join("\n")||"",style:{flexGrow:1}}),"NRQ"==e&&input({id:"oeq2",htmlBefore:"Answer:",type:"number",value:o[l.id]||0,style:{flexGrow:1}},u),"MCQ"!=e&&"MRQ"!=e||(u.classList.add("mcq"),addElementTo(u,{tag:"button",id:"add-option-btn",textContent:"Add Option",events:{click:e=>{localStorage.x="hello",m(null,u,l?.id||""),e.preventDefault()}}}),l.choices?l.choices?.forEach((e=>{m(e,u,l.id)})):(console.log("here"),m(null,u,l?.id),m(null,u,l?.id))),"PARSONS"==e||"CODE"==e){const t=addElementTo(u,{style:{display:"flex",flexDirection:"column",flexGrow:.2,alignItems:"center",gap:".5em"}}),i=[];"PARSONS"==e&&addElementTo(t,{tag:"button",id:"add-option-btn",textContent:"Add Distractor",events:{click:e=>{m(null,t,l?.id||""),e.preventDefault()}}});const n=addElementTo(u,{style:{flexDirection:"column",flexGrow:1}});var c=addElementTo(n,{tag:"select",id:"language"}),r=addElementTo(n,{tag:"textarea",id:"parsons",_id:l?.id});["text/plain","python","javascript","java","c_cpp","application/json","markdown"].forEach((e=>{addElementTo(c,{tag:"option",value:e,textContent:e.charAt(0).toUpperCase()+e.slice(1)})})),c.value=l?.language||"text/plain",setTimeout((e=>{r._editor=CodeMirror.fromTextArea(r,{lineNumbers:!0,mode:"python",theme:"default",tabSize:4,smartIndent:!0,insertSoftTab:!0}),c.addEventListener("change",(()=>{const e=c.value;r._editor.setOption("mode",e)})),o[l?.id]?r._editor.setValue(o[l.id][0].A.join("\n")):r._editor.setValue(""),r._editor.on("change",(()=>{let e=r._editor.getValue();if(console.log(t),e){let o=e.split("\n").filter((e=>""!==e));console.log("Lines:",o),i.forEach((e=>e.remove())),o.forEach((e=>i.push(m(e,t,l?.id||""))))}}))}),100)}}}function m(e,t,l){let i=o[l]||[],n=null;n="object"==typeof e?i.some((t=>t.id==e.id)):i?.includes(e);let a=newEl({style:{display:"flex",alignItems:"center",justifyContent:"center",gap:"1em"}});t.prepend(a);let s="";e&&(s=e?.content?e.content:e);let c="MCQ"==el("categories").value?`<input type="radio" name="${l}" class="answerChoice" _id="${e?.id||""}" choice="${e?.id||s}" ${n?"checked":""}></input>`:`<input type="checkbox" class="answerChoice" _id="${e?.id||""}" choice="${s}" ${n?"checked":""}>`;return"PARSONS"==el("categories").value&&(c=""),addElementTo(a,{innerHTML:`${c}`}).scrollIntoView({behavior:"smooth"}),addElementTo(a,{tag:"textarea",id:"choice",_id:e?.id||"",innerHTML:s}),addElementTo(a,{tag:"i",className:"icon-btn fa-solid fa-xmark choicecolor",events:{click:e=>{a.remove()}}}),a}addElementTo(e,{tag:"span",style:{display:"block",marginBottom:"2em"}}),Object.keys(t.questions||[]).forEach((n=>{let a=t.questions[n];const s=addElementTo(e,{style:{display:"flex",alignItems:"center",justifyContent:"center",gap:"1em"}}),c=addElementTo(s,{}),p=(showQuestion(c,structuredClone(a),n,r),addElementTo(s,{style:{display:"flex",className:"icon-container",flexDirection:"column",gap:"20px"}}));addElementTo(p,{tag:"i",className:"icon-btn fa-solid fa-pen-to-square",events:{click:e=>{const o=popup("QID:"+a.id,"",button({textContent:"Update",style:{minWidth:"700px"},events:{click:()=>{if(el("my-form").reportValidity()){const e=popup("","Are you sure you want to UPDATE this question?",button({textContent:"YES",events:{click:()=>{console.log("update question",t.R),t.R||d(a.id),e.close(),o.close()}}}),"No")}}}}),"Cancel");u(a,o.main)}}}),addElementTo(p,{tag:"i",className:"icon-btn fa-solid fa-trash-can",events:{click:n=>{const s=popup("","Are you sure you want to DELETE this question? This can NOT be undone!",button({textContent:"YES",events:{click:()=>{t.questions=t.questions.filter((e=>e.id!==a.id)),delete o[a.id],quizBuilder(e,t,o,l,i),s.close()}}}),"No")}}})}))}