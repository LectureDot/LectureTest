import{getEl,button,input,newEl,isObj,span,isArr,isStr,isNum,download,arrSum}from"./ui/common.js";import{showQuestion}from"./showQuestions.js";import{confirmPopup,popup}from"./ui/popup.js";import{toast,toastError,toastSuccess,toastWarn}from"./ui/toast.js";import{codeEditor,EDITOR_LANGUAGES}from"./ui/editor/editor.js";import{runUnitTest}from"./util/unitTest.js";import{rereadButtonBar,reToRr,rrToHTML,textToRe}from"./ui/editor/reread.js";import{compareText,textPattern}from"./util/compareText.js";import styles from"./quizbuilder.css"with{type:"css"};import{F}from"./schema.js";document.adoptedStyleSheets.push(styles);const QUESTION_CATEGORIES={MCQ:"Multiple Choice",MRQ:"Multiple Response",OEQ:"Open Ended Question",CODE:"Code (programming)"},ALLOWED_POSITION_EDITING_KEYS=new Set(["1","2","3","4","5","6","7","8","9","0","ArrowLeft","ArrowRight","Backspace","Delete","Home","End","Enter"]),CACHED_TEST_CODE="_Tc_",CACHED_TEST_TEXT="_Tt_";function importQuestionsFromJSON(e){try{let t,n=JSON.parse(e);if(isArr(n))t=n;else{if(!isObj(n)||!("questions"in n))return;t=n.questions}if(t=t.filter((e=>e.prompt)).map((e=>(e.points||(e.points=1),e.category in QUESTION_CATEGORIES||(e.category=e.choices?"MCQ":"OEQ"),isArr(e.answer)||(e.answer=[e.answer]),e))),t.length)return t}catch(e){console.error(e)}}export function quizBuilder(e,t,n,i,o){console.log(t),e.innerHTML="",n||(n={});const s=e,a=t?.i?.[0]===localStorage.email;input({id:"qtitle",htmlBefore:"Exam Title:",class:"bigger",value:t?.title||""},s),newEl({innerText:"Exam Description (markdown; shown prior to exam):"},s),codeEditor({id:"description",value:t?.description||"",lang:"markdown",lineNumbers:!0,lineWrapping:!0,style:{width:"35em",height:"4.5em"}},s),newEl({innerText:"Exam Instructions (markdown; shown during exam):"},s),codeEditor({id:"instructions",value:t?.instructions||"",lang:"markdown",lineNumbers:!0,lineWrapping:!0,style:{width:"35em",height:"7em"}},s);const l=input({id:"select",type:"number",step:1,min:0,htmlBefore:"Number of random questions to show:",value:t?.select||"",placeholder:"show all",oninput:e=>{const t=Math.round(Number(e.target.value)||0);t<=0?e.target.value="":e.target.value!=t&&(e.target.value=t)}});"ORD"==t?.category&&(l.style.visibility="hidden");const r=input({id:"extraCredit",type:"number",htmlBefore:"Extra Credit:",htmlAfter:"pts",value:t[F.EXAM_EXTRA_CREDIT]||0,min:0,oninput:u}),c=newEl();function u(){const e=arrSum(t.questions.map((e=>e.points))),n=Number(r.input.value)||0;c.innerHTML=`Max points possible: ${e} out of ${e-n} (${(e/(e-n)*100).toFixed(1)}%)`}u(),newEl({items:[input({id:"category",htmlAfter:"Present questions in random order",type:"checkbox",checked:"ORD"==t?.category?"":"checked",onchange:e=>{l.style.visibility=e.target.checked?"visible":"hidden"}}),l,r,c,input({id:"R",htmlAfter:"Mark exam as READ ONLY",type:"checkbox",checked:t?.R?"checked":"",oninput:n=>{t.R=n.target.checked,e.className=t.R?"readonly":"qouter",p.disabled=t.R,f()}})]},s),e.className=t?.R?"readonly":"qouter",newEl({tag:"span",style:{display:"block",marginBottom:"2em"}},s);const d=newEl({class:"builder-control-row"},s);button({innerHTML:'<i class="icon-btn fa-solid fa-plus"></i> Add Question',onclick:()=>{if(t.R)return void toastWarn("Cannot add question. This exam is marked as read-only.");const e={};let n;const i=new Set(t.questions.map((e=>e.id)));do{n=(1e7*Math.random()).toFixed()}while(i.has(n));e.id=n;const o=popup("New Question","",button({textContent:"Save Question",onclick:()=>{t.R?toastWarn("Cannot save question. This exam is read-only."):getEl("question-editing-form").reportValidity()&&g(e.id)&&o.close()}}),"Cancel",null,{class:"large"});y(e,o.main)}},d),button({innerHTML:'<i class="icon-btn fa-solid fa-file-import"></i> Import',onclick:()=>{if(t.R)return void toastWarn("Cannot add question. This exam is marked as read-only.");let s;const a=button({disabled:!0,textContent:"Import Exam",onclick:()=>{if(console.log("Importing..."),!s)return void(a.disabled=!0);const l=new Set(t.questions.map((e=>e.id)));s.forEach((e=>{if(!(e=structuredClone(e)).id){let t;do{t=(1e7*Math.random()).toFixed()}while(l.has(t));e.id=t}n[e.id]=e.answer||[],delete e.answer,t.questions.push(e),l.add(e.id)})),toastSuccess(`Imported ${s.length} questions. Don't forget to save the exam.`),quizBuilder(e,t,n,i,o),r.close()}}),l=codeEditor({lang:"json",style:{height:"15em"}});l.on("change",(()=>{s=importQuestionsFromJSON(l.value),a.disabled=!s}));const r=popup("Import Exam",["Paste JSON with your questions into the editor below.",'Pated JSON must be an array of questions or an object with a field "questions" whose value is an array of questions.','Each question in the questions array must be an object with a required field "prompt" and optional fields "answer", "choices", "category", "title", "points", "id", etc.',l],a,"Cancel",null,{class:"large"})}},d),button({innerHTML:'<i class="icon-btn fa-solid fa-download"></i> Export',onclick:()=>{download(t.title+".json",JSON.stringify(t,null,2))}},d),button({innerHTML:'<i class="icon-btn fa-solid fa-user-plus"></i> Share',onclick:()=>{var e=t.i||[localStorage.email];const n=newEl();function i(t,o){const s=newEl({class:"small flex-row"},n);0===o?span({innerText:"Owner:",style:{fontWeight:"bold"}},s):(span({innerHTML:'<i class="icon-btn fa-solid fa-user-times" title="Remove instructor."></i>',onclick:()=>{if(t===localStorage.email){confirmPopup("","Are you sure you want to remove yourself from this exam?","Remove",(()=>{s.remove(),e=e.filter((e=>e!==t))}),"Cancel")}else s.remove(),e=e.filter((e=>e!==t))}},s),a&&span({innerHTML:'<i class="icon-btn fa-solid fa-arrow-circle-up" title="Make this instructor the new owner."></i>',onclick:()=>{confirmPopup("Changing Exam Owner",["Are you sure you want change the owner for this exam?",`If you proceed, ${t} will become the new owner for this exam.`],"Change Owner",(()=>{e=[t].concat(e.filter((e=>e!==t))),n.innerHTML="",e.forEach(i)}),"Cancel")}},s)),span({innerText:t,style:{fontWeight:"bold"}},s),t===localStorage.email&&span({innerText:"(myself)"},s)}e.forEach(i);const o=popup("Exam Instructors",n,[button({innerText:"Add Instructor",onclick:()=>{const t=input({type:"email",placeholder:"Email address",required:!0}),n=popup("Add Instructor",["Enter email address for new instructor:",t],button({innerText:"OK",onclick:()=>{if(t.input.reportValidity()){if(e.includes(t.input.value))return void toast("This email is already in the list of instructors for this exam.");e.push(t.input.value),i(t.input.value,e.length-1),n.close()}}}),"Cancel")}}),button({innerText:"OK",onclick:()=>{t.i=e,toast("Instructor list updated. Don't forget to save the exam for changes to take effect."),o.close()}})],"Cancel")}},d);const p=button({innerHTML:'<i class="icon-btn fa-solid fa-save"></i> Save',onclick:f},d);function h(e,n,i,o){if(i>=t.questions.length&&(i=t.questions.length-1),i<0&&(i=0),n===i)return;const a=n<i;if(i===t.questions.length-1)s.appendChild(e);else{const n=s.querySelector(`#q${t.questions[i+a].id}`);s.insertBefore(e,n)}t.questions.splice(n,1),t.questions.splice(i,0,o);for(let e=Math.min(n,i);e<=Math.max(n,i);e++){const n=s.querySelector(`#q${t.questions[e].id}`),o=n.querySelector(".builderQuestionNumberInput");o.value=e+1,o.style.width=(e+1).toString().length+1+"ch",e===i&&o.focus(),0===e?n.querySelector(".fa-angle-up").classList.add("transparent"):n.querySelector(".fa-angle-up").classList.remove("transparent"),e===t.questions.length-1?n.querySelector(".fa-angle-down").classList.add("transparent"):n.querySelector(".fa-angle-down").classList.remove("transparent")}e.scrollIntoView({behavior:"smooth",block:"start"})}function m(){t[F.READ_ONLY]=getEl("R").checked,t[F.EXAM_TITLE]=getEl("qtitle").value,t[F.EXAM_DESCRIPTION]=getEl("description").value,t[F.EXAM_INSTRUCTIONS]=getEl("instructions").value,t.category=getEl("category").checked?"RAND":"ORD",t.select=getEl("select").value,t[F.EXAM_EXTRA_CREDIT]=Number(r.input.value)||0}function f(){m(),t.questions=t.questions;const e=t.questions.map((e=>e.id));Object.keys(n).forEach((i=>{if("_"!==i)if(e.includes(i))if(n[i]&&isArr(n[i])&&n[i].length){let e=t.questions.find((e=>e.id===i)),o=n[i];for(let e=o.length-1;e>=0;e--){const t=o[e];!1!==t&&(t?t.A&&!t.A.length&&o.splice(e,1):o.splice(e,1))}if(0===o.length)return void(n[i]=void 0);e.false_check!==o.includes(!1)&&(e.false_check=!0,o.includes(!1)||o.push(!1))}else n[i]=void 0;else n[i]=void 0})),i&&i(t,n),console.log("save quiz",t,n)}function g(s){try{const a={},l=getEl("all-options"),r=t.questions.findIndex((e=>e.id==s));n[s]=[],a.id=s;let c=getEl("categories");return a.category=c.value,a.choices=[],a.prompt=l.querySelector("#prompt").value,l.querySelectorAll('input[type="number"]').forEach((e=>{e.reportValidity()&&(a[e.id]=Number(e.value))})),l.querySelectorAll('input:not([type="number"], [type="checkbox"], [type="radio"])').forEach((e=>{e.reportValidity()&&e.id&&(a[e.id]=e.value)})),l.querySelectorAll('input[type="checkbox"]:not(.answerChoice)').forEach((e=>{a[e.id]=e.checked})),l.querySelectorAll("textarea.answerChoiceText").forEach((e=>{"object"==typeof t.questions[r]?.choices[0]?a.choices.push({id:e.getAttribute("_id"),content:e.value}):a.choices.push(e.value)})),l.querySelectorAll("input.answerChoice").forEach((e=>{console.log(e,e.checked,e.getAttribute("choice")),e.checked&&("MRQ"===c.value?(n[s][0]||(n[s][0]={A:[]}),n[s][0].A.push(e.getAttribute("choice"))):"object"==typeof t.questions[r]?.choices[0]?n[s].push({id:e.getAttribute("_id"),content:e.getAttribute("choice")}):n[s].push(e.getAttribute("choice")))})),l.querySelectorAll("select").forEach((e=>{a[e.id]=e.value})),a.unit_tests=[],l.querySelectorAll(".unit-test").forEach((e=>{try{a.unit_tests.push(JSON.parse(e.innerText))}catch(e){return void toastError("Error parsing unit tests.\n"+e.toString())}})),0===a.unit_tests.length&&delete a.unit_tests,l.querySelectorAll(".code-extra").forEach((e=>{a[e.id]=e.value})),l.querySelectorAll(".answers-div").forEach((e=>{const t=[];e.querySelectorAll(".answer-pattern").forEach((e=>{try{t.push(JSON.parse(e.innerText))}catch(e){return void toastError("Error parsing answer.\n"+e.toString())}})),n[s].push({A:t})})),n[s]=n[s].filter((e=>e)),l.querySelector("#false_check")?.checked&&n[s].push(!1),-1!==r?t.questions[r]=a:t.questions.push(a),m(),quizBuilder(e,t,n,i,o),toast("Question updated. Don't forget to save the exam."),!0}catch(e){toastError("Error saving question.\n"+e.toString())}}function y(e,t){t.innerHTML="";const n=e?.category||"Choose Category",i=newEl({tag:"form",id:"question-editing-form"},t);!function(e,t){const n=newEl({tag:"select",id:"categories",events:{change:e=>{x(e.target.value,t,getEl("all-options"))}}},e);newEl({tag:"option",value:"Choose Category",textContent:"Choose Category"},n);for(let e in QUESTION_CATEGORIES)newEl({tag:"option",value:e,textContent:QUESTION_CATEGORIES[e]},n)}(i,e),getEl("categories").value=n;x(n,e,newEl({innerHTML:"",id:"all-options",style:{display:"flex",flexDirection:"row",gap:"2px",justifyContent:"center"}},i))}function x(e,t,i){if(console.log("q",t),e!=t.category&&(i.innerHTML="",t.category=e),!t.id)return void console.error("No ID found for question.");const o=n[t.id]||[],s=newEl({className:"qbuilder",style:{display:"flex",flexDirection:"column",gap:"6px",flex:.3}},i),a=newEl({className:"qbuilder",style:{display:"flex",flexDirection:"column",flex:1}},i);if(e in QUESTION_CATEGORIES){newEl({innerText:"Question Options"},s);const c=newEl({className:"qbuilder gen-div"},s);input({id:"title",htmlBefore:"Title:",value:t?.title||"",placeholder:"Enter your title (Required)",style:{flexGrow:1}},c),newEl({tag:"span",innerHTML:"Prompt:",style:{display:"flex"}},c),codeEditor({id:"prompt",value:t?.prompt||"",lang:"markdown",lineNumbers:!0,lineWrapping:!0,style:{height:"10em",width:"30em"}},c),input({id:"points",htmlBefore:"Points:",type:"number",value:t?.points||1,style:{flexGrow:1},required:!0},c);const u=newEl({className:"qbuilder options-div"},s);let d={};if("MCQ"!=e&&"MRQ"!=e||input({id:"ordered",htmlAfter:"Order Choices",type:"checkbox",checked:t.ordered},u),"PARSONS"==e&&(input({id:"choice_reuse",htmlAfter:"Reuse Choices",type:"checkbox",checked:t.choice_reuse},u),input({id:"max_levels",htmlBefore:"Max Levels:",type:"number",value:t?.max_levels},u)),"OEQ"!=e&&"CODE"!=e||(input({id:"max_lines",htmlBefore:"Max Lines:",min:0,type:"number",value:t?.max_lines||"",placeholder:"No limit",oninput:e=>{"0"===e.target.value&&(e.target.value="")}},u),input({id:"max_length",htmlBefore:"Max Chars:",min:0,type:"number",value:t?.max_length||"",placeholder:"No limit",oninput:e=>{"0"===e.target.value&&(e.target.value="")}},u)),"PARSONS"==e||"CODE"==e){var l=newEl({tag:"select",id:"language"},u);Object.keys(EDITOR_LANGUAGES).forEach((e=>{newEl({tag:"option",value:e,textContent:e},l)})),l.value=t.language||"python",input({id:"run",htmlAfter:"Display Run Button",type:"checkbox",checked:t.run},u),input({id:"await_input",htmlAfter:"Convert `input()` to `await input()`",type:"checkbox",checked:t.await_input??!0},u),input({id:"max_output",htmlBefore:"Max output size:<br>(including newline characters)",min:1,max:1e5,step:1,type:"number",value:t?.max_output||"1000",oninput:e=>{e.target.reportValidity()},onchange:e=>{e.target.value||(e.target.value=1e3)},labelStyle:{alignItems:"flex-start"}},u),input({id:"runtime_limit",htmlBefore:"Max runtime default:",htmlAfter:"s",min:0,type:"number",value:t?.runtime_limit||10,placeholder:"No limit",oninput:e=>{"0"===e.target.value?e.target.value="":e.target.reportValidity()}},u),t.unit_tests||(t.unit_tests=[]),!isArr(t.unit_tests)&&t.unit_tests.run&&(t.unit_tests=[t.unit_tests]),newEl({innerText:"Unit Tests available to students:"},u);const p=newEl({},u);function r(){p.innerHTML="";for(let e=0;e<t.unit_tests.length;e++){let n=t.unit_tests[e];if(isObj(n)){let i=newEl({tag:"pre"});n.in||n.exec?i.innerText=n.in||n.exec:n.out?.re?i.innerHTML=rrToHTML(reToRr(n.out.re)):i.innerText=n.out||JSON.stringify(n,null,2);const o=newEl({items:[{class:"unit-test",innerText:JSON.stringify(n),style:{display:"none"}},i],style:{backgroundColor:"#333",height:"max-content",minHeight:"2.5em",maxHeight:"5em",overflow:"auto",resize:"vertical",marginBottom:"0.25em"}},p),s=newEl({class:"top-right flex-row"},o);button({innerHTML:'<i class="fa-solid fa-pen-to-square"></i>',title:"Edit",class:"small",onclick:async()=>{const n=await b(t.unit_tests[e],t);n?.delete?(t.unit_tests.splice(e,1),r()):n&&(t.unit_tests[e]=n,r())}},s),button({innerHTML:'<i class="fa-solid fa-copy"></i>',title:"Make a copy of this unit test",class:"small",onclick:()=>{t.unit_tests.push(structuredClone(n)),r()}},s),button({innerHTML:'<i class="fa-solid fa-trash-can"></i>',title:"Delete",class:"small",onclick:()=>{t.unit_tests.splice(e,1),r()}},s)}}}button({textContent:"Add python unit test...",class:"small",onclick:async()=>{const e=await b(null,t);e&&(t.unit_tests.push(e),r())}},u),r(),d.displayUnitTests=r,newEl({innerText:"Code prefix (runs before student code; hidden from students):"},u);const h=codeEditor({id:"codePrefix",value:t?.codePrefix||"",lang:l.value,lineNumbers:!0,lineWrapping:!0,style:{height:"10em",width:"30em"},class:"code-extra"},u);newEl({innerText:"Code postfix (runs after student code; hidden from students):"},u);const m=codeEditor({id:"codePostfix",value:t?.codePostfix||"",lang:l.value,lineNumbers:!0,lineWrapping:!0,style:{height:"10em",width:"30em"},class:"code-extra"},u);newEl({innerText:"Code template (starting point visible to students):"},u);const f=codeEditor({id:"answerTemplate",value:t?.answerTemplate||"",lang:l.value,lineNumbers:!0,lineWrapping:!0,style:{height:"10em",width:"30em"},class:"code-extra"},u);l.addEventListener("change",(()=>{h.setOption("lang",l.value)})),l.addEventListener("change",(()=>{m.setOption("lang",l.value)})),l.addEventListener("change",(()=>{f.setOption("lang",l.value)}))}E(t,o,a,d)}}function E(e,t,n,i){const o=()=>{E(e,t,n,i)};n.innerHTML="",newEl({innerText:"Answers"},n),input({id:"false_check",htmlAfter:"Manual Check If Incorrect",type:"checkbox",checked:e.false_check||t.includes(!1)},n);const s=newEl({className:"qbuilder answers-div"},n);if(t=structuredClone(t.filter((e=>e))),"NRQ"==e.category&&input({htmlBefore:"Answer:",type:"number",value:t[0]||0,style:{flexGrow:1}},s),"MCQ"!=e.category&&"MRQ"!=e.category||(s.classList.add("mcq"),newEl({tag:"button",id:"add-option-btn",textContent:"Add Option",events:{click:t=>{w(null,s,e.id),t.preventDefault()}}},s),e.choices?e.choices?.forEach((t=>{w(t,s,e.id)})):(w(null,s,e.id),w(null,s,e.id))),"CODE"==e.category||"OEQ"==e.category){function a(t,n,s){t[n]?t[n].A||(t[n]={A:[t[n]]}):t[n]={A:[]};const a=t[n].A;for(let t=0;t<a.length;t++){let n=a[t];isStr(n)&&(n={re:n});let l=newEl({tag:"pre"});if(n.in||n.exec)l.innerText=n.in||n.exec;else if(n.out){const e=textPattern(n.out);e?l.innerHTML=rrToHTML(reToRr(e.re)):l.innerText=JSON.stringify(n,null,2)}else{const e=textPattern(n);e?l.innerHTML=rrToHTML(reToRr(e.re)):l.innerText=JSON.stringify(n,null,2)}const r=newEl({items:[{class:"answer-pattern",innerText:JSON.stringify(n),style:{display:"none"}},l],style:{backgroundColor:"#333",height:"max-content",maxHeight:"5em",minHeight:"2em",overflow:"auto",resize:"vertical"}},s),c=newEl({class:"top-right flex-row"},r);"CODE"===e.category&&(newEl({class:"small",innerHTML:n.in?"Unit Test <code> stdin:</code>":n.exec?"Unit Test":n.out?"Unit Test <code> stdout:</code>":"Code Pattern"},r,!0),n.run&&button({innerHTML:'<i class="fa-solid fa-circle-left"></i>',title:"Copy this unit test to left column (i.e., allow students to run this unit test)",class:"small",onclick:()=>{e.unit_tests||(e.unit_tests=[]),e.unit_tests.push(n),i?.displayUnitTests?.()}},c,!0)),button({innerHTML:'<i class="fa-solid fa-pen-to-square"></i>',title:"Edit",class:"small",onclick:async()=>{const i=await(n.run?b:v)(n,e);i?.delete?(a.splice(t,1),o()):i&&(a[t]=i,console.log(a),o())}},c),button({innerHTML:'<i class="fa-solid fa-copy"></i>',title:"Make a copy of this unit test",class:"small",onclick:()=>{a.push(structuredClone(n)),o()}},c),button({innerHTML:'<i class="fa-solid fa-trash-can"></i>',title:"Delete",class:"small",onclick:()=>{a.splice(t,1),o()}},c)}const l=newEl({class:"flex-row"},s);button({textContent:`Add required ${"CODE"==e.category?"code":"text"} pattern...`,class:"small",onclick:async()=>{const e=await v();e&&(a.push(e),o())}},l),"CODE"==e.category&&button({textContent:"Add python unit test...",class:"small",onclick:async()=>{const t=await b(null,e);t&&(a.push(t),o())}},l),(t.length>1||a.length)&&(button({innerHTML:'<i class="fa-solid fa-copy"></i>',title:"Copy answer",class:"small",onclick:()=>{t.push(structuredClone(t[n])),o()}},l),button({innerHTML:'<i class="fa-solid fa-trash-can"></i>',title:"Delete answer",class:"small",onclick:()=>{t.splice(n,1),o()}},l))}a(t,0,s);for(let l=1;l<t.length;l++)a(t,l,newEl({className:"qbuilder answers-div"},n));button({textContent:"Add another valid answer...",class:"small",onclick:()=>{t.push({A:[]}),o()}},n)}if("PARSONS"==e.category){const r=getEl("language"),c=newEl({style:{display:"flex",flexDirection:"column",flexGrow:.2,alignItems:"center",gap:".5em"}},s),u=[];newEl({tag:"button",id:"add-option-btn",textContent:"Add Distractor",onclick:t=>{w(null,c,e.id),t.preventDefault()}},c);const d=newEl({style:{flexDirection:"column",flexGrow:1}},s),p=codeEditor({class:"answer-editor",lang:r.value},d);r.addEventListener("change",(()=>{p.setOption("mode",r.value)})),t[0]?.A&&(p.value=t[0].A.join("\n")),p.on("change",(()=>{if(p.value){let t=p.value.split("\n").filter((e=>""!==e));u.forEach((e=>e.remove())),t.forEach((t=>u.push(w(t,c,e.id))))}}))}}function w(e,i,o){let s=n[o]||[];const a=t.questions.findIndex((e=>e.id==o));console.log("qanswers",s,n,e),console.log(o,t.questions[a]);let l=null;l=e&&"object"==typeof e?s.some((t=>t.id==e.id)):s?.[0]?.A?.includes(e)||s?.includes(e);let r=newEl({style:{display:"flex",alignItems:"center",justifyContent:"center",gap:"1em"}});i.append(r);let c="";e&&(c=e?.content?e.content:e);const u=getEl("categories").value;let d;"MCQ"===u?d=newEl({tag:"input",type:"radio",name:o,class:"answerChoice",_id:e?.id||"",choice:c},r):"MRQ"===u&&(d=newEl({tag:"input",type:"checkbox",class:"answerChoice",_id:e?.id||"",choice:c},r)),d&&l&&d.setAttribute("checked",!0),newEl({tag:"textarea",class:"answerChoiceText",_id:e?.id||"",innerHTML:c,rows:3,cols:50,onchange:e=>{d&&d.setAttribute("choice",e.target.value)}},r),newEl({tag:"i",className:"icon-btn fa-solid fa-xmark choicecolor",onclick:e=>r.remove()},r);var p=newEl({tag:"i",className:"icon-btn fa-solid fa-angle-up",onclick:n=>{const o=t.questions[a].choices.findIndex((t=>t==e));if(o>0){const e=i.children[o+1],n=i.children[o];i.insertBefore(e,n);const s=t.questions[a].choices[o];t.questions[a].choices[o]=t.questions[a].choices[o-1],t.questions[a].choices[o-1]=s,console.log(t.questions[a].choices),n.children[4].classList.add("transparent"),o==t.questions[a].choices.length-2&&p.classList.remove("transparent"),0==o&&h.classList.add("transparent")}}},r),h=newEl({tag:"i",className:"icon-btn fa-solid fa-angle-down",onclick:n=>{const o=t.questions[a].choices.findIndex((t=>t==e));if(o<t.questions[a].choices.length-1){const e=i.children[o+1],n=i.children[o+2];i.insertBefore(n,e);const s=t.questions[a].choices[o];t.questions[a].choices[o]=t.questions[a].choices[o+1],t.questions[a].choices[o+1]=s,console.log(t.questions[a].choices),console.log(n),n.children[3].classList.add("transparent"),o==t.questions[a].choices.length-2&&h.classList.add("transparent"),0==o&&p.classList.remove("transparent")}}},r);return r}function v(e,t){return new Promise(((n,i)=>{const o=!e;e=textPattern(e)||{re:""};const s=codeEditor({lang:"reread",style:{height:"5em"}});s.cm.fromRe(e.re);const a=input({type:"checkbox",htmlAfter:"Case sensitive",checked:e.case,title:"Must match case: If checked, the pattern above must match capitalization in the answer text."}),l=input({type:"checkbox",htmlAfter:"At start",checked:e.start,title:"Must match at start: If checked, the pattern above must match the start of the answer text."}),r=input({type:"checkbox",htmlAfter:"At end",checked:e.end,title:"Must match at end: If checked, the pattern above must match the end of the answer text."}),c=input({type:"checkbox",htmlAfter:"Must <b>NOT</b> match",checked:e.not,title:"Must NOT match: If checked, the answer will be considered correct if it does *NOT* match the pattern above."});function u(){if(s.value.trim()){for(let e=1;e<h.children.length;e+=2){const n=h.children[e].value;n&&localStorage.setItem("_Tt_"+t.id+"_"+e,n)}return e={re:s.cm.toRe()},c.input.checked&&(e.not=!0),e}toast("Text pattern cannot be empty.")}const d=e=>{const t=e.target;t.previousElementSibling.innerText=compareText(t.value,u())?"✔️":"❌"},p=()=>{const e=u();for(let t=1;t<h.children.length;t+=2){const n=h.children[t].value;h.children[t-1].innerText=compareText(n,e)?"✔️":"❌"}};s.on("change",p),a.input.addEventListener("change",p),l.input.addEventListener("change",p),r.input.addEventListener("change",p),c.input.addEventListener("change",p);const h=newEl({items:["❌",newEl({tag:"textarea",rows:3,cols:50,oninput:d}),"❌",newEl({tag:"textarea",rows:3,cols:50,oninput:d}),"❌",newEl({tag:"textarea",rows:3,cols:50,oninput:d})],style:{display:"grid",gridTemplateColumns:"2em 1fr",gap:"0.5em",alignItems:"center"}}),m=popup("Answer Text Editor",["Text Pattern:",s,rereadButtonBar(s),newEl({class:"flex-row",items:[a,l,r,c],style:{placeContent:"flex-start center"}}),{class:"sep"},"Try sample answers against the pattern above:",h],[button({textContent:o?"Add Answer":"Update Answer",onclick:()=>{u()&&(n(e),m.close())}}),o?"":button({textContent:"Delete Answer",class:"special",onclick:()=>{n({delete:!0}),m.close()}})],"Cancel",n,{class:"large"})}))}function b(e,t){return new Promise(((n,i)=>{const o=!e;e||(e={re:""});var s=textPattern(e.out)||{};const a=codeEditor({lang:"text",value:e.in||"",style:{height:"5em"}}),l=codeEditor({lang:"python",value:e.exec||"",style:{height:"5em"}}),r=codeEditor({lang:"reread",style:{height:"5em"}});r.cm.fromRe(s.re);const c=input({type:"checkbox",htmlAfter:"Case sensitive",checked:s.case,title:"Must match case: If checked, the pattern above must match capitalization in the answer text."}),u=input({type:"checkbox",htmlAfter:"At start",checked:s.start,title:"Must match at start: If checked, the pattern above must match the start of the answer text."}),d=input({type:"checkbox",htmlAfter:"At end",checked:s.end,title:"Must match at end: If checked, the pattern above must match the end of the answer text."}),p=input({type:"checkbox",htmlAfter:"Must <b>NOT</b> match",checked:s.not,title:"Must NOT match: If checked, the answer will be considered correct if it does *NOT* match the pattern above."}),h=input({type:"number",htmlBefore:"Max Runtime (sec):",value:e.maxTime||.1,min:.001}),m=input({type:"number",htmlBefore:"Max Output Size:",value:e.maxOut||1e3,min:1,max:1e5,step:1}),f=codeEditor({lang:"python",value:localStorage.getItem("_Tc_"+t.id)||localStorage.getItem("_Tc_")||"",style:{height:"5em"}}),g=codeEditor({lang:"text",readOnly:!0,style:{height:"5em"}});function y(){if(!r.value.trim())return void toast("Output cannot be empty.");const n=f.value;return n&&(localStorage.setItem("_Tc_",n),localStorage.setItem("_Tc_"+t.id,n),document.querySelector("#q"+t.id+" .question-card .CodeMirror").value=n),e={run:"py",out:{re:r.cm.toRe()}},p.input.checked&&(e.out.not=!0),l.value.trim()&&(e.exec=l.value),a.value.trim()&&(e.in=a.value),h.input.value&&(e.maxTime=Number(h.input.value)),m.input.value&&(e.maxOut=Number(m.input.value)),e}const x=popup("Unit Test",[newEl({items:["Input:","Code to execute after student's code:",a,l],style:{display:"grid",gridTemplateColumns:"1fr 1fr",gap:"0.5em"}}),"Output:",r,rereadButtonBar(r),newEl({class:"flex-row",items:[c,u,d,p],style:{placeContent:"flex-start center"}}),[h,m],{class:"sep"},newEl({items:["Try some code:","Unit test output",f,g],style:{display:"grid",gridTemplateColumns:"1fr 1fr",gap:"0.5em"}})],[button({textContent:"▶ Run Unit Test",onclick:async()=>{if(!y())return;const t=await runUnitTest(f.value,e);g.value=t.output,t.passed?toast("✔️ Unit test passed.","",1):toast("❌ Unit test failed.","",-.5)}})," ",button({textContent:o?"Add Unit Test":"Update Unit Test",onclick:()=>{y()&&(n(e),x.close())}}),o?"":button({textContent:"Delete Unit Test",class:"special",onclick:()=>{n({delete:!0}),x.close()}})],"Cancel",n,{class:"large"})}))}p.disabled=t.R,button({innerHTML:'<i class="icon-btn fa-solid fa-door-closed"></i> Exit',onclick:()=>{o?o():e.remove()}},d),t.questions||(t.questions=[]),isObj(t.questions)&&(t.questions=Object.values(t.questions)),newEl({tag:"span",style:{display:"block",marginBottom:"2em"}},s),(t.questions||[]).forEach(((a,l)=>{const r=newEl({id:"q"+a.id,style:{display:"flex",alignItems:"center",justifyContent:"center",scrollMarginTop:"7em",gap:"1em"}},s),c=newEl({},r);let u;"MCQ"===a.category?u=n[a.id]?.[0]:"MRQ"===a.category?u=n[a.id]?.[0]?.A:"CODE"===a.category?u=localStorage.getItem("_Tc_"+a.id):"OEQ"===a.category&&(u=n[a.id]?.[0],u?.A&&u.A.length&&(u=u.A[0]),isNum(u)&&(u=u.toString()),isStr(u)&&(u={re:textToRe(u)}));const d=showQuestion(c,structuredClone(a),l,{},u,((e,t)=>{if("MRQ"==a.category)n[e][0]=t.a?.length?{A:t.a}:void 0,toast("Answer updated. Don't forget to save the exam.");else if("MCQ"==a.category)n[e][0]=t.a,toast("Answer updated. Don't forget to save the exam.");else if("CODE"===a.category)localStorage.setItem("_Tc_"+e,t.a);else if("OEQ"===a.category){const i={re:t.a};console.log(i),n[e][0]?(n[e][0].A||(n[e][0]={A:[n[e][0]]}),isObj(n[e][0].A[0])?Object.assign(n[e][0].A[0],i):n[e][0].A[0]=i):t.a.trim()&&(n[e][0]=i),toast("Answer updated. Don't forget to save the exam.")}})),p=newEl({class:"top-right small flex-row",style:{margin:"0.25em"}},d);button({innerHTML:'<i class="icon-btn fa-solid fa-pen-to-square"></i> Edit',onclick:()=>function(e){const n=popup("QID:"+e.id,"",button({textContent:"Update",onclick:()=>{t.R?toastWarn("Cannot save question. This exam is read-only."):getEl("question-editing-form").reportValidity()&&g(e.id)&&n.close()}}),"Cancel",null,{class:"large"});y(e,n.main)}(a),class:"small"},p);const m=newEl({style:{display:"flex",className:"icon-container",flexDirection:"column",gap:"0.5em",alignItems:"center"}},r);newEl({tag:"i",class:"icon-btn fa-solid fa-copy",style:{marginBottom:"1em"},onclick:s=>{const l=structuredClone(a);do{l.id=(1e7*Math.random()).toFixed()}while(t.questions.some((e=>e.id===l.id)));t.questions.push(l),n[l.id]=structuredClone(n[a.id]),quizBuilder(e,t,n,i,o),e.scrollIntoView({block:"end",behavior:"smooth"})}},m);var f=newEl({tag:"i",className:"icon-btn fa-solid fa-angle-up",onclick:e=>{const n=t.questions.findIndex((e=>e.id==a.id));h(r,n,n-1,a)}},m);0===l&&f.classList.add("transparent"),input({pattern:"[0-9]*",class:"builderQuestionNumberInput",style:{minWidth:"2ch",width:(l+1).toString().length+1+"ch",fontFamily:"fixed",textAlign:"center"},value:l+1,min:1,max:t.questions.length,step:1,oninput:e=>{e.target.style.width=e.target.value.length+1+"ch"},onchange:e=>{let n=Number(e.target.value);const i=t.questions.findIndex((e=>e.id==a.id));""===e.target.value.trim()||isNaN(n)||!Number.isInteger(n)||n<1?e.target.value=i+1:(n>t.questions.length&&(n=t.questions.length),h(r,i,n-1,a))},onkeydown:e=>{if(ALLOWED_POSITION_EDITING_KEYS.has(e.key)||e.preventDefault(),"ArrowDown"===e.key){const e=t.questions.findIndex((e=>e.id==a.id));h(r,e,e+1,a)}else if("ArrowUp"===e.key){const e=t.questions.findIndex((e=>e.id==a.id));h(r,e,e-1,a)}}},m);var x=newEl({tag:"i",className:"icon-btn fa-solid fa-angle-down",onclick:e=>{const n=t.questions.findIndex((e=>e.id==a.id));h(r,n,n+1,a)}},m);l===t.questions.length-1&&x.classList.add("transparent"),newEl({tag:"i",class:"icon-btn fa-solid fa-trash-can",style:{marginTop:"1em"},onclick:s=>{const l=popup("","Are you sure you want to DELETE this question? This can NOT be undone!",button({textContent:"Delete question",onclick:()=>{t.questions=t.questions.filter((e=>e.id!==a.id)),delete n[a.id],quizBuilder(e,t,n,i,o),l.close()}}),"Cancel")}},m)}))}