import{getEl,button,input,newEl}from"./ui/common.js";import{showQuestion}from"./showQuestions.js";import{popup}from"./ui/popup.js";import{marked}from"https://cdn.jsdelivr.net/npm/marked/lib/marked.esm.js";import styles from"./quizbuilder.css"with{type:"css"};document.adoptedStyleSheets.push(styles);const EDITOR_LANGUAGES=["text/plain","python","javascript","java","clike","application/json","markdown"];function codeEditor(e,t,i){return new Promise((n=>{const o={mode:"python",lineNumbers:!0,theme:"default",tabSize:4,smartIndent:!0,insertSoftTab:!0};e.lang&&(o.mode=e.lang,delete e.lang),void 0!==e.lineNumbers&&(o.lineNumbers=e.lineNumbers,delete e.lineNumbers);var s=newEl(Object.assign(e,{tag:"textarea"}),t,i);setTimeout((e=>{s._editor=CodeMirror.fromTextArea(s,o),s._editor.setSize("100%","100%"),n(s)}),100)}))}export function quizBuilder(e,t,i,n,o){console.log(t),e.innerHTML="",i||(i={});const s=e;input({id:"qtitle",htmlBefore:"Exam Title:",class:"bigger",value:t?.title||""},s),input({id:"category",htmlBefore:"Randomize Questions:",type:"checkbox",checked:"ORD"==t?.category?"":"checked"},s),input({id:"select",htmlBefore:"Number of Quiz Questions To Show:",value:t?.select||""},s),newEl({innerText:"Exam Description (markdown; shown prior to exam):"},s);let l=newEl({style:{width:"25em",height:"3.5em",resize:"both",overflow:"auto"}},s);codeEditor({id:"description",value:t?.description||"",lang:"markdown",lineNumbers:!1},l),newEl({innerText:"Exam Instructions (markdown; shown during exam):"},s),l=newEl({style:{width:"25em",height:"6.25em",resize:"both",overflow:"auto"}},s),codeEditor({id:"instructions",value:t?.instructions||"",lang:"markdown",lineNumbers:!1},l),input({id:"R",htmlBefore:"EXAM IS READ ONLY:",type:"checkbox",checked:t?.R?"checked":"",events:{input:t=>{e.className=t.target.checked?"readonly":"qouter"}}},s),e.className=t?.R?"readonly":"qouter",newEl({tag:"span",style:{display:"block",marginBottom:"2em"}},s);const c=newEl({class:"builder-control-row"},s);button({innerHTML:'<i class="icon-btn fa-solid fa-plus"></i> Add Question',onclick:()=>{const e={};let i;do{i=(1e7*Math.random()).toFixed()}while(new Set(t.questions.map((e=>e.id))).has(i));e.id=i;const n=popup("New Question","",button({textContent:"Save Question",onclick:()=>{getEl("my-form").reportValidity()&&(console.log("new question",t.R),t.R||r(e.id),n.close())}}),"Cancel",null,{class:"large"});u(e,n.main)}},c),button({innerHTML:'<i class="icon-btn fa-solid fa-save"></i> Save',onclick:()=>{!function(){t.category=getEl("category").checked?"RAND":"ORD",t.select=getEl("select").value,t.title=getEl("qtitle").value,t.questions=t.questions,t.R=getEl("R").checked,t.instructions=getEl("instructions")._editor.getValue(),t.description=getEl("description")._editor.getValue(),n&&n(t,i);localStorage[t.title]=JSON.stringify(t),localStorage[t.title+"answers"]=JSON.stringify(i),console.log("save quiz",t,i)}()}},c),button({innerHTML:'<i class="icon-btn fa-solid fa-door-closed"></i> Exit',onclick:()=>{o&&o()}},c),Array.isArray(t.questions)||(t.questions=Object.values(t.questions||[]));const a={};function r(s){const l={},c=getEl("all-options"),a=t.questions.findIndex((e=>e.id==s));i[s]=[],l.id=s;let r=getEl("categories");l.category=r.value,l.choices=[],c.querySelectorAll('input[type="number"]').forEach((e=>{l[e.id]=Number(e.value)})),c.querySelectorAll('input:not([type="number"], [type="checkbox"], [type="radio"])').forEach((e=>{e.id&&(l[e.id]=e.value)})),c.querySelectorAll('input[type="text"]').forEach((e=>{l.choices.push(e.value)})),c.querySelectorAll("input.answerChoice").forEach((e=>{e.checked&&("object"==typeof t.questions[a].choices[0]?i[s].push({id:e.getAttribute("_id"),content:e.getAttribute("choice")}):i[s].push(e.getAttribute("choice")))})),c.querySelectorAll("select").forEach((e=>{l[e.id]=e.value})),c.querySelectorAll("textarea").forEach((e=>{let n=e._editor?.getValue();if(e._editor&&e.classList.contains("answer-editor")&&"CODE"===r.value)i[s]=JSON.parse(n);else if(n){const e=n.split("\n").filter((e=>""!==e));i[s]=[{A:e}];let t=l.max_levels;n=n.split("\n").map((e=>t?e.trim():e)).filter((e=>e)),l.choices.push(...n)}else if(""!=e.value&&e.id)if("prompt"==e.id||"stimulus"==e.id)l[e.id]=e.value;else if("choice"==e.id)"object"==typeof t.questions[a]?.choices[0]?l.choices.push({id:e.getAttribute("_id"),content:e.value}):l.choices.push(e.value);else{const t=e.value.split("\n").filter((e=>""!==e&"false"!==e));i[s].push(t)}})),c.querySelectorAll('input[type="checkbox"]:not(.answerChoice)').forEach((e=>{l[e.id]=e.checked,"false_check"==e.id&&e.checked&&!i[s].includes(!1)&&i[s].push(!1)})),console.log(i),console.log(l),-1!==a?t.questions[a]=l:t.questions.push(l),t.category=getEl("category").checked?"RAND":"ORD",t.R=getEl("R").checked,t.select=getEl("select").value,t.title=getEl("qtitle").value,t.instructions=getEl("instructions")._editor.getValue(),t.description=getEl("description")._editor.getValue(),quizBuilder(e,t,i,n,o)}function u(e,t){const i=e?.category||"Choose Category",n=newEl({tag:"form",id:"my-form",className:"container",style:{display:"flex",flexDirection:"column",gap:"8px"}},t);n.classList.add("back","qbuilder"),function(e,t){const i=newEl({tag:"select",id:"categories",events:{change:e=>{d(e.target.value,t,getEl("all-options"))}}},e);["Choose Category","MCQ","MRQ","OEQ","NRQ","CODE","MATCH","PARSONS"].forEach((e=>{newEl({tag:"option",value:e,textContent:e},i)}))}(n,e),getEl("categories").value=i;d(i,e,newEl({innerHTML:"",id:"all-options",style:{display:"flex",flexDirection:"row",gap:"2px",justifyContent:"center"}},n))}function d(e,t,n){if(console.log("q",t),e!=t.category&&(n.innerHTML="",t.category=e),!t.id)return void console.error("No ID found for question.");const o=newEl({className:"qbuilder",style:{display:"flex",flexDirection:"column",gap:"6px",flex:.3}},n),s=newEl({className:"qbuilder",style:{display:"flex",flexDirection:"column",flex:1}},n);if("Choose Category"!==e){const n=newEl({className:"qbuilder gen-div"},o);input({id:"title",htmlBefore:"Title:",value:t?.title||"",placeholder:"Enter your title (Required)",style:{flexGrow:1},required:!0},n);const c=newEl({tag:"span",innerHTML:"Prompt:",style:{display:"flex"}},n);newEl({tag:"textarea",id:"prompt",value:t?.prompt||"",rows:6,placeholder:"Enter your prompt (Required)",style:{flexGrow:1},required:!0},c),input({id:"points",htmlBefore:"Points:",type:"number",value:t?.points||1,style:{flexGrow:1},required:!0},n);const a=newEl({className:"qbuilder options-div"},o);if("MCQ"!=e&&"MRQ"!=e||input({id:"ordered",htmlAfter:"Order Choices",type:"checkbox",checked:t.ordered},a),"PARSONS"==e){var l=newEl({tag:"select",id:"language"},a);input({id:"choice_reuse",htmlAfter:"Reuse Choices",type:"checkbox",checked:t.choice_reuse},a),input({id:"max_levels",htmlBefore:"Max Levels:",type:"number",value:t?.max_levels},a)}if("OEQ"==e||"CODE"==e){if(input({id:"max_lines",htmlBefore:"Max Lines:",min:0,type:"number",value:t?.max_lines||"",placeholder:"No limit",oninput:e=>{"0"===e.target.value&&(e.target.value="")}},a),input({id:"max_length",htmlBefore:"Max Chars:",min:0,type:"number",value:t?.max_length||"",placeholder:"No limit",oninput:e=>{"0"===e.target.value&&(e.target.value="")}},a),"CODE"===e){l=newEl({tag:"select",id:"language"},a);input({id:"run",htmlAfter:"Display Run Button",type:"checkbox",checked:t.run},a),input({id:"await_input",htmlAfter:"Convert `input()` to `await input()`",type:"checkbox",checked:t.await_input??!0},a)}input({id:"case_sensitive",htmlAfter:"Case Sensitive",type:"checkbox",checked:t.case_sensitive},a),input({id:"space_sensitive",htmlAfter:"Space Sensitive",type:"checkbox",checked:t.space_sensitive},a),input({id:"false_check",htmlAfter:"Manual Check If Incorrect",type:"checkbox",checked:t.false_check},a)}newEl({innerText:"Answers"},s);const r=newEl({className:"qbuilder answers-div",style:{display:"flex",gap:".5em"}},s);if("OEQ"==e&&newEl({tag:"textarea",id:"oeq",rows:10,value:i[t.id]?.join("\n")||"",style:{flexGrow:1}},r),"NRQ"==e&&input({id:"oeq2",htmlBefore:"Answer:",type:"number",value:i[t.id]||0,style:{flexGrow:1}},r),"MCQ"!=e&&"MRQ"!=e||(r.classList.add("mcq"),newEl({tag:"button",id:"add-option-btn",textContent:"Add Option",events:{click:e=>{localStorage.x="hello",p(null,r,t?.id||""),e.preventDefault()}}},r),t.choices?t.choices?.forEach((e=>{p(e,r,t.id)})):(p(null,r,t?.id),p(null,r,t?.id))),"PARSONS"!=e&&"CODE"!=e||(EDITOR_LANGUAGES.forEach((e=>{newEl({tag:"option",value:e,textContent:e},l)})),l.value=t?.language||"python"),"CODE"==e){codeEditor({class:"answer-editor",lang:"application/json"},newEl({style:{flexDirection:"column",flexGrow:1}},r)).then((e=>{t?.id&&i[t.id]&&e._editor.setValue(JSON.stringify(i[t.id],null,2))}))}if("PARSONS"==e){const e=newEl({style:{display:"flex",flexDirection:"column",flexGrow:.2,alignItems:"center",gap:".5em"}},r),n=[];newEl({tag:"button",id:"add-option-btn",textContent:"Add Distractor",onclick:i=>{p(null,e,t?.id||""),i.preventDefault()}},e);const o=newEl({style:{flexDirection:"column",flexGrow:1}},r);codeEditor({lang:l.value},o).then((o=>{l.addEventListener("change",(()=>{o._editor.setOption("mode",l.value)})),i[t?.id]&&i[t.id][0]?.A&&o._editor.setValue(i[t.id][0].A.join("\n")),o._editor.on("change",(()=>{let i=o._editor.getValue();if(i){let o=i.split("\n").filter((e=>""!==e));n.forEach((e=>e.remove())),o.forEach((i=>n.push(p(i,e,t?.id||""))))}}))}))}}}function p(e,n,o){let s=i[o]||[];const l=t.questions.findIndex((e=>e.id==o));console.log("qanswers",s,i,e),console.log(o,t.questions[l]);let c=null;c=e&&"object"==typeof e?s.some((t=>t.id==e.id)):s?.[0]?.A?.includes(e)||s?.includes(e);let a=newEl({style:{display:"flex",alignItems:"center",justifyContent:"center",gap:"1em"}});n.append(a);let r="";e&&(r=e?.content?e.content:e);let u="MCQ"==getEl("categories").value?`<input type="radio" name="${o}" class="answerChoice" _id="${e?.id||""}" choice="${e?.id||r}" ${c?"checked":""}></input>`:`<input type="checkbox" class="answerChoice" _id="${e?.id||""}" choice="${r}" ${c?"checked":""}>`;"PARSONS"==getEl("categories").value&&(u=""),newEl({innerHTML:`${u}`},a).scrollIntoView({behavior:"smooth"}),newEl({tag:"textarea",id:"choice",_id:e?.id||"",innerHTML:r},a),newEl({tag:"i",className:"icon-btn fa-solid fa-xmark choicecolor",onclick:e=>a.remove()},a);var d=newEl({tag:"i",className:"icon-btn fa-solid fa-angle-up",events:{click:i=>{const o=t.questions[l].choices.findIndex((t=>t==e));if(o>0){const e=n.children[o+1],i=n.children[o];n.insertBefore(e,i);const s=t.questions[l].choices[o];t.questions[l].choices[o]=t.questions[l].choices[o-1],t.questions[l].choices[o-1]=s,console.log(t.questions[l].choices),i.children[4].classList.add("transparent"),o==t.questions[l].choices.length-2&&d.classList.remove("transparent"),0==o&&p.classList.add("transparent")}}}},a),p=newEl({tag:"i",className:"icon-btn fa-solid fa-angle-down",events:{click:i=>{const o=t.questions[l].choices.findIndex((t=>t==e));if(o<t.questions[l].choices.length-1){const e=n.children[o+1],i=n.children[o+2];n.insertBefore(i,e);const s=t.questions[l].choices[o];t.questions[l].choices[o]=t.questions[l].choices[o+1],t.questions[l].choices[o+1]=s,console.log(t.questions[l].choices),console.log(i),i.children[3].classList.add("transparent"),o==t.questions[l].choices.length-2&&p.classList.add("transparent"),0==o&&d.classList.remove("transparent")}}}},a);return a}newEl({tag:"span",style:{display:"block",marginBottom:"2em"}},s),Object.keys(t.questions||[]).forEach((l=>{let c=t.questions[l];const d=newEl({style:{display:"flex",alignItems:"center",justifyContent:"center",gap:"1em"}},s),p=newEl({},d),h=showQuestion(p,structuredClone(c),l,a,i[c.id],((e,t)=>{"MCQ"==c.category&&(i[e]=[t.a]),"MRQ"==c.category&&(i[e][0].A=t.a),"OEQ"==c.category&&(i[e]=t.a.split("\n").filter((e=>""!==e)))}));button({innerHTML:'<i class="icon-btn fa-solid fa-pen-to-square"></i> Edit',class:"question-edit-button",onclick:()=>function(e){const t=popup("QID:"+e.id,"",button({textContent:"Update",onclick:()=>{getEl("my-form").reportValidity()&&(r(e.id),t.close())}}),"Cancel",null,{class:"large"});u(e,t.main)}(c)},h);const f=newEl({style:{display:"flex",className:"icon-container",flexDirection:"column",gap:"20px"}},d);var m=newEl({tag:"i",className:"icon-btn fa-solid fa-angle-up",events:{click:s=>{const l=t.questions.findIndex((e=>e.id==c.id));if(l>0){const s=t.questions[l];t.questions[l]=t.questions[l-1],t.questions[l-1]=s,quizBuilder(e,t,i,n,o)}}}},f);0==t.questions.findIndex((e=>e.id==c.id))&&m.classList.add("transparent");var g=newEl({tag:"i",className:"icon-btn fa-solid fa-angle-down",events:{click:s=>{const l=t.questions.findIndex((e=>e.id==c.id));if(l<t.questions.length-1){const s=t.questions[l];t.questions[l]=t.questions[l+1],t.questions[l+1]=s,quizBuilder(e,t,i,n,o)}}}},f);t.questions.findIndex((e=>e.id==c.id))==t.questions.length-1&&g.classList.add("transparent"),newEl({tag:"i",class:"icon-btn fa-solid fa-trash-can",style:{marginTop:"1em"},onclick:s=>{const l=popup("","Are you sure you want to DELETE this question? This can NOT be undone!",button({textContent:"YES",events:{click:()=>{t.questions=t.questions.filter((e=>e.id!==c.id)),delete i[c.id],quizBuilder(e,t,i,n,o),l.close()}}}),"Cancel")}},f)}))}