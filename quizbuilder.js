import{getEl,button,input,newEl}from"./ui/common.js";import{showQuestion}from"./showQuestions.js";import{popup}from"./ui/popup.js";import{marked}from"https://cdn.jsdelivr.net/npm/marked/lib/marked.esm.js";import styles from"./quizbuilder.css"with{type:"css"};document.adoptedStyleSheets.push(styles);export function quizBuilder(e,t,i,n,s){console.log(t),e.innerHTML="",i||(i={});const o=e;input({id:"qtitle",htmlBefore:"Exam Title:",class:"bigger",value:t?.title||""},o),input({id:"category",htmlBefore:"Randomize Questions:",type:"checkbox",checked:"ORD"==t?.category?"":"checked"},o),input({id:"select",htmlBefore:"Number of Quiz Questions To Show:",value:t?.select||""},o),input({id:"instructions",htmlBefore:"Specify Instructrions To Show:",value:t?.instructions||""},o),input({id:"R",htmlBefore:"EXAM IS READ ONLY:",type:"checkbox",checked:t?.R?"checked":""},o),e.className=t?.R?"readonly":"qouter",newEl({tag:"span",style:{display:"block",marginBottom:"2em"}},o);const l=newEl({class:"builder-control-row"},o);button({innerHTML:'<i class="icon-btn fa-solid fa-plus"></i> Add Question',onclick:()=>{const e=popup("New Question","",button({textContent:"Save Question",events:{click:()=>{getEl("my-form").reportValidity()&&(console.log("new question",t.R),t.R||a(),e.close())}}}),"Cancel");r([],e.main)}},l),button({innerHTML:'<i class="icon-btn fa-solid fa-save"></i> Save',onclick:()=>{!function(){t.category="on"===getEl("category").value?"RAND":"ORD",t.select=getEl("select").value,t.title=getEl("qtitle").value,t.questions=t.questions,t.R=getEl("R").checked,t.instructions=getEl("instructions").value,n&&n(t,i);localStorage[t.title]=JSON.stringify(t),localStorage[t.title+"answers"]=JSON.stringify(i),console.log("save quiz",t,i)}()}},l),button({innerHTML:'<i class="icon-btn fa-solid fa-door-closed"></i> Exit',onclick:()=>{s&&s()}},l),Array.isArray(t.questions)||(t.questions=Object.values(t.questions||[]));const c={};function a(o){console.log("saveq",c);const l={},a=getEl("all-options"),r=t.questions.findIndex((e=>e.id==o));i[o]=[],l.id=o;let u=getEl("categories");l.category=u.value,l.choices=[],a.querySelectorAll('input[type="number"]').forEach((e=>{l[e.id]=Number(e.value)})),a.querySelectorAll('input:not([type="number"], [type="checkbox"], [type="radio"])').forEach((e=>{e.id&&(l[e.id]=e.value)})),a.querySelectorAll('input[type="text"]').forEach((e=>{l.choices.push(e.value)})),a.querySelectorAll("input.answerChoice").forEach((e=>{e.checked&&("object"==typeof t.questions[r].choices[0]?i[o].push({id:e.getAttribute("_id"),content:e.getAttribute("choice")}):i[o].push(e.getAttribute("choice")))})),a.querySelectorAll("select").forEach((e=>{l[e.id]=e.value})),a.querySelectorAll("textarea").forEach((e=>{let n=e._editor?.getValue();if(n){const e=n.split("\n").filter((e=>""!==e));i[o]=[{A:e}];let t=l.max_levels;n=n.split("\n").map((e=>t?e.trim():e)).filter((e=>e)),l.choices.push(...n)}else if(""!=e.value&&e.id)if("prompt"==e.id||"stimulus"==e.id)l[e.id]=e.value;else if("choice"==e.id)"object"==typeof t.questions[r]?.choices[0]?l.choices.push({id:e.getAttribute("_id"),content:e.value}):l.choices.push(e.value);else{const t=e.value.split("\n").filter((e=>""!==e&"false"!==e));i[o].push(t)}})),a.querySelectorAll('input[type="checkbox"]:not(.answerChoice)').forEach((e=>{l[e.id]=e.checked,"false_check"==e.id&&e.checked&&!i[o].includes(!1)&&i[o].push(!1)})),console.log(i),console.log(l),-1!==r?t.questions[r]=l:t.questions.push(l),t.category=getEl("category").checked?"RAND":"ORD",t.R=getEl("R").checked,t.select=getEl("select").value,t.title=getEl("qtitle").value,t.instructions=getEl("instructions").value,quizBuilder(e,t,i,n,s)}function r(e,t){const i=e?.category||"Choose Category",n=newEl({tag:"form",id:"my-form",className:"container",style:{display:"flex",flexDirection:"column",gap:"8px"}},t);n.classList.add("back","qbuilder"),function(e,t){const i=newEl({tag:"select",id:"categories",events:{change:e=>{u(e.target.value,t,getEl("all-options"))}}},e);["Choose Category","MCQ","MRQ","OEQ","NRQ","CODE","MATCH","PARSONS"].forEach((e=>{newEl({tag:"option",value:e,textContent:e},i)}))}(n,e),getEl("categories").value=i;u(i,e,newEl({innerHTML:"",id:"all-options",style:{display:"flex",flexDirection:"row",gap:"2px",justifyContent:"center"}},n))}function u(e,n,s){var o=0;if(e!=n.category&&(s.innerHTML="",n.category=e),!n.id){do{o=(1e7*Math.random()).toFixed()}while(new Set(t.questions.map((e=>e.id))).has(o));n.id=o}const l=newEl({className:"qbuilder",style:{display:"flex",flexDirection:"column",gap:"6px",flex:.3}},s),c=newEl({className:"qbuilder",style:{display:"flex",flexDirection:"column",flex:1}},s);if("Choose Category"!==e){const t=newEl({className:"qbuilder gen-div"},l);input({id:"title",htmlBefore:"Title:",value:n?.title||"",placeholder:"Enter your title (Required)",style:{flexGrow:1},required:!0},t);const s=newEl({tag:"span",innerHTML:"Stimulus:",style:{display:"flex"}},t);newEl({tag:"textarea",id:"stimulus",value:marked.parse(n?.stimulus||""),rows:6,placeholder:"Enter your stimulus",style:{flexGrow:1}},s);const o=newEl({tag:"span",innerHTML:"Prompt:",style:{display:"flex"}},t);newEl({tag:"textarea",id:"prompt",value:marked.parse(n?.prompt||""),rows:6,placeholder:"Enter your prompt (Required)",style:{flexGrow:1},required:!0},o),input({id:"points",htmlBefore:"Points:",type:"number",value:n?.points||1,style:{flexGrow:1},required:!0},t);const u=newEl({className:"qbuilder options-div"},l);"MCQ"!=e&&"MRQ"!=e||input({id:"ordered",htmlAfter:"Order Choices",type:"checkbox",checked:n.ordered},u),"PARSONS"==e&&(input({id:"choice_reuse",htmlAfter:"Reuse Choices",type:"checkbox",checked:n.choice_reuse},u),input({id:"max_levels",htmlBefore:"Max Levels:",type:"number",value:n?.max_levels},u)),"OEQ"!=e&&"CODE"!=e||("CODE"===e&&(input({id:"run",htmlAfter:"Display Run Button",type:"checkbox",checked:n.run},u),input({id:"await_input",htmlAfter:"Convert `input()` to `await input()`",type:"checkbox",checked:n.await_input??!0},u)),input({id:"case_sensitive",htmlAfter:"Case Sensitive",type:"checkbox",checked:n.case_sensitive},u),input({id:"space_sensitive",htmlAfter:"Space Sensitive",type:"checkbox",checked:n.space_sensitive},u),input({id:"regex",htmlAfter:"Regex",type:"checkbox",checked:n.regex},u),input({id:"false_check",htmlAfter:"Manual Check If Incorrect",type:"checkbox",checked:n.false_check},u),input({id:"max_lines",htmlBefore:"Max Lines:",type:"number",value:n?.max_lines,style:{flexGrow:1},placeholder:"Enter number of Maximum Lines"},u),input({id:"max_length",htmlBefore:"Max Length (chars):",type:"number",value:n?.max_length,style:{flexGrow:1},placeholder:"Enter Maximum Length (chars)"},u));const p=newEl({className:"qbuilder answers-div",style:{display:"flex",gap:".5em"}},c);if("OEQ"==e&&newEl({tag:"textarea",id:"oeq",rows:10,value:i[n.id]?.join("\n")||"",style:{flexGrow:1}},p),"NRQ"==e&&input({id:"oeq2",htmlBefore:"Answer:",type:"number",value:i[n.id]||0,style:{flexGrow:1}},p),"MCQ"!=e&&"MRQ"!=e||(p.classList.add("mcq"),newEl({tag:"button",id:"add-option-btn",textContent:"Add Option",events:{click:e=>{localStorage.x="hello",d(null,p,n?.id||""),e.preventDefault()}}},p),n.choices?n.choices?.forEach((e=>{d(e,p,n.id)})):(d(null,p,n?.id),d(null,p,n?.id))),"PARSONS"==e||"CODE"==e){const t=newEl({style:{display:"flex",flexDirection:"column",flexGrow:.2,alignItems:"center",gap:".5em"}},p),s=[];"PARSONS"==e&&newEl({tag:"button",id:"add-option-btn",textContent:"Add Distractor",events:{click:e=>{d(null,t,n?.id||""),e.preventDefault()}}},t);const o=newEl({style:{flexDirection:"column",flexGrow:1}},p);var a=newEl({tag:"select",id:"language"},o),r=newEl({tag:"textarea",id:"parsons",_id:n?.id},o);["text/plain","python","javascript","java","c_cpp","application/json","markdown"].forEach((e=>{newEl({tag:"option",value:e,textContent:e},a)})),a.value=n?.language||"python",setTimeout((e=>{r._editor=CodeMirror.fromTextArea(r,{lineNumbers:!0,mode:a.value,theme:"default",tabSize:4,smartIndent:!0,insertSoftTab:!0}),a.addEventListener("change",(()=>{r._editor.setOption("mode",a.value)})),i[n?.id]?r._editor.setValue(i[n.id][0].A.join("\n")):r._editor.setValue(""),r._editor.on("change",(()=>{let e=r._editor.getValue();if(e){let i=e.split("\n").filter((e=>""!==e));s.forEach((e=>e.remove())),i.forEach((e=>s.push(d(e,t,n?.id||""))))}}))}),100)}}}function d(e,n,s){let o=i[s]||[];const l=t.questions.findIndex((e=>e.id==s));console.log("qanswers",o,i,e),console.log(s,t.questions[l]);let c=null;c=e&&"object"==typeof e?o.some((t=>t.id==e.id)):o?.[0]?.A?.includes(e)||o?.includes(e);let a=newEl({style:{display:"flex",alignItems:"center",justifyContent:"center",gap:"1em"}});n.append(a);let r="";e&&(r=e?.content?e.content:e);let u="MCQ"==getEl("categories").value?`<input type="radio" name="${s}" class="answerChoice" _id="${e?.id||""}" choice="${e?.id||r}" ${c?"checked":""}></input>`:`<input type="checkbox" class="answerChoice" _id="${e?.id||""}" choice="${r}" ${c?"checked":""}>`;"PARSONS"==getEl("categories").value&&(u=""),newEl({innerHTML:`${u}`},a).scrollIntoView({behavior:"smooth"}),newEl({tag:"textarea",id:"choice",_id:e?.id||"",innerHTML:r},a),newEl({tag:"i",className:"icon-btn fa-solid fa-xmark choicecolor",events:{click:e=>{a.remove()}}},a);var d=newEl({tag:"i",className:"icon-btn fa-solid fa-angle-up",events:{click:i=>{const s=t.questions[l].choices.findIndex((t=>t==e));if(s>0){const e=n.children[s+1],i=n.children[s];n.insertBefore(e,i);const o=t.questions[l].choices[s];t.questions[l].choices[s]=t.questions[l].choices[s-1],t.questions[l].choices[s-1]=o,console.log(t.questions[l].choices),i.children[4].classList.add("transparent"),s==t.questions[l].choices.length-2&&d.classList.remove("transparent"),0==s&&p.classList.add("transparent")}}}},a);0==t.questions[l].choices.findIndex((t=>t==e))&&d.classList.add("transparent");var p=newEl({tag:"i",className:"icon-btn fa-solid fa-angle-down",events:{click:i=>{const s=t.questions[l].choices.findIndex((t=>t==e));if(s<t.questions[l].choices.length-1){const e=n.children[s+1],i=n.children[s+2];n.insertBefore(i,e);const o=t.questions[l].choices[s];t.questions[l].choices[s]=t.questions[l].choices[s+1],t.questions[l].choices[s+1]=o,console.log(t.questions[l].choices),console.log(i),i.children[3].classList.add("transparent"),s==t.questions[l].choices.length-2&&p.classList.add("transparent"),0==s&&d.classList.remove("transparent")}}}},a);return t.questions[l].choices.findIndex((t=>t==e))==t.questions[l].choices.length-1&&p.classList.add("transparent"),a}newEl({tag:"span",style:{display:"block",marginBottom:"2em"}},o),Object.keys(t.questions||[]).forEach((l=>{let u=t.questions[l];const d=newEl({style:{display:"flex",alignItems:"center",justifyContent:"center",gap:"1em"}},o),p=newEl({},d),h=showQuestion(p,structuredClone(u),l,c,i[u.id],((e,t)=>{"MCQ"==u.category&&(i[e]=[t.a]),"MRQ"==u.category&&(i[e][0].A=t.a),"OEQ"==u.category&&(i[e]=t.a.split("\n").filter((e=>""!==e)))}));button({innerHTML:'<i class="icon-btn fa-solid fa-pen-to-square"></i> Edit',class:"question-edit-button",onclick:()=>function(e){const t=popup("QID:"+e.id,"",button({textContent:"Update",events:{click:()=>{getEl("my-form").reportValidity()&&(a(e.id),t.close())}}}),"Cancel");r(e,t.main)}(u)},h);const f=newEl({style:{display:"flex",className:"icon-container",flexDirection:"column",gap:"20px"}},d);var m=newEl({tag:"i",className:"icon-btn fa-solid fa-angle-up",events:{click:o=>{const l=t.questions.findIndex((e=>e.id==u.id));if(l>0){const o=t.questions[l];t.questions[l]=t.questions[l-1],t.questions[l-1]=o,quizBuilder(e,t,i,n,s)}}}},f);0==t.questions.findIndex((e=>e.id==u.id))&&m.classList.add("transparent");var g=newEl({tag:"i",className:"icon-btn fa-solid fa-angle-down",events:{click:o=>{const l=t.questions.findIndex((e=>e.id==u.id));if(l<t.questions.length-1){const o=t.questions[l];t.questions[l]=t.questions[l+1],t.questions[l+1]=o,quizBuilder(e,t,i,n,s)}}}},f);t.questions.findIndex((e=>e.id==u.id))==t.questions.length-1&&g.classList.add("transparent"),newEl({tag:"i",class:"icon-btn fa-solid fa-trash-can",style:{marginTop:"1em"},onclick:o=>{const l=popup("","Are you sure you want to DELETE this question? This can NOT be undone!",button({textContent:"YES",events:{click:()=>{t.questions=t.questions.filter((e=>e.id!==u.id)),delete i[u.id],quizBuilder(e,t,i,n,s),l.close()}}}),"Cancel")}},f)}))}