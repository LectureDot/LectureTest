import{initializeApp}from"https://www.gstatic.com/firebasejs/11.4.0/firebase-app.js";import{getAuth,onAuthStateChanged,signInWithPopup,GoogleAuthProvider}from"https://www.gstatic.com/firebasejs/11.4.0/firebase-auth.js";import{getFirestore,serverTimestamp,Timestamp,collection,doc,addDoc,setDoc,getDocs,getDoc,updateDoc,deleteDoc,onSnapshot,writeBatch,deleteField,FieldPath,query,where,documentId,orderBy,startAt,endBefore,limit,startAfter,getCountFromServer}from"https://www.gstatic.com/firebasejs/11.4.0/firebase-firestore.js";import{getDatabase,ref,get,set,push,onValue,onChildChanged,onChildAdded,serverTimestamp as rtdbTimestamp,orderByChild,query as dbrQuery,startAt as dbrStartAt,limitToLast}from"https://www.gstatic.com/firebasejs/11.4.0/firebase-database.js";const firebaseConfig={apiKey:"AIzaSyDnWzH0BBCtxWSRK0VHb3GZT7gx1vxMwc0",authDomain:"lecturedot-a4222.firebaseapp.com",projectId:"lecturedot-a4222",storageBucket:"lecturedot-a4222.firebasestorage.app",messagingSenderId:"225073159992",appId:"1:225073159992:web:cea0dbbf5c484b36556bcd",measurementId:"G-PX1NMT4EDL"},app=initializeApp(firebaseConfig),provider=new GoogleAuthProvider,auth=getAuth();export const onAuth=e=>onAuthStateChanged(auth,e);export const signOut=()=>auth.signOut();export function signIn(){signInWithPopup(auth,provider).then((e=>{GoogleAuthProvider.credentialFromResult(e).accessToken,e.user})).catch((e=>{e.code,e.message,e.customData.email,GoogleAuthProvider.credentialFromError(e)}))}const DATABASE=getFirestore(app);export const db={};function parseConstraints(e){if(!e?.length)return[];let r=[];e[0].constructor!==Array&&e[1].constructor!==Array&&e.length<=3&&(e=[e]);for(let t of e)t?.length&&("orderBy"==t[0]&&t[1]?r.push(orderBy(t[1])):"limit"==t[0]&&t[1]?r.push(limit(t[1])):3===t.length&&("startsWith"==t[1]?r.push(where(t[0],">=",t[2]),where(t[0],"<",t[2]+"")):r.push(where(...t))));return r}db.serverTimestamp=serverTimestamp,db.Timestamp=Timestamp,db.now=()=>Timestamp.now().seconds,db.orderBy=orderBy,db.where=where,db.startAfter=startAfter,db.limit=limit,db.startsWith=(e,r)=>[where(e,">=",r),where(e,"<",r+"")],db.getDoc=async function(e,r,t){if("_"===r)return null;var o=`db.getDoc(${e},${r})`;if(void 0!==t&&t&&o in localStorage)try{return JSON.parse(localStorage[o])}catch(e){}if(!navigator.onLine)return{error:"You are offline."};try{console.log(`db.getDoc(${e},${r})`);var n=await getDoc(doc(DATABASE,e,r));let t=n.exists()?n.data():null;return t&&(t._={t:Date.now()},localStorage[o]=JSON.stringify(t)),t}catch(e){return console.error(e),{error:e.code||"unknown error"}}},db.insertOne=async function(e,r,t){if(!navigator.onLine)return{error:"You are offline."};try{if(r){var o=await setDoc(doc(DATABASE,e,r),t);let n=`db.getDoc(${e},${r})`;return localStorage[n]=JSON.stringify(t),r}{let r=`db.getDoc(${e},${(o=await addDoc(collection(DATABASE,e),t)).id})`;t._={t:Date.now()},localStorage[r]=JSON.stringify(t);const n=[];for(let r=0;r<localStorage.length;r++){const t=localStorage.key(r);t.startsWith(`db.find(${e},`)&&n.push(t)}return n.forEach((e=>localStorage.removeItem(e))),o.id}}catch(e){return console.error(e),{error:e.code||"unknown error"}}},db.updateOne=async function(e,r,t){if(!navigator.onLine)return{error:"You are offline."};try{let o=Object.fromEntries(Object.entries(t).map((([e,r])=>[e,void 0===r?deleteField():r])));await updateDoc(doc(DATABASE,e,r),o);let n=`db.getDoc(${e},${r})`,a=localStorage[n];if(a)try{a=JSON.parse(a),Object.assign(a,t,{_:{t:Date.now()}}),localStorage[n]=JSON.stringify(a);for(let o in localStorage)if(o.startsWith(`db.find(${e},`))try{let e=JSON.parse(localStorage[o]);r in e&&(Object.assign(e[r],t,{_:{t:Date.now()}}),localStorage[o]=JSON.stringify(e))}catch(e){delete localStorage[o]}}catch(e){delete localStorage[n]}return!0}catch(e){return console.error(e),{error:e.code||"unknown error"}}},db.deleteOne=async function(e,r){if(!navigator.onLine)return{error:"You are offline."};try{await deleteDoc(doc(DATABASE,e,r)),delete localStorage[`db.getDoc(${e},${r})`]}catch(e){return console.error(e),{error:e.code||"unknown error"}}},db.getDocsByIds=async function(e,r,t){let o={};for(let n of r){let r=await db.getDoc(e,n,t);if(r){if(r.error)return{error:r.error};o[n]=r}}return o},db.find=async function(e,r,t){if(void 0!==t){var o=`db.find(${e},${JSON.stringify(r)})`;try{n=JSON.parse(localStorage[o])}catch(e){}if(t&&n)return n}if(!navigator.onLine)return{error:"You are offline."};try{if(console.log(`db.find(${e},${JSON.stringify(r)})`),r=parseConstraints(r),r?.length)var n=await getDocs(query(collection(DATABASE,e),...r));else n=await getDocs(collection(DATABASE,e));let a={};if(a._={first:n.docs[n.docs.length-1],last:n.docs[n.docs.length-1],count:n.docs.length,t:Date.now()},n.docs.forEach((e=>a[e.id]=e.data())),void 0!==t){localStorage[o]=JSON.stringify(a);for(let r in a)"_"!==r&&(localStorage[`db.getDoc(${e},${r})`]=JSON.stringify(a[r]))}return a}catch(e){return console.error(e),{error:e.code||"unknown error"}}},db.onSnapshot=function(e,...r){const t=r.pop();return onSnapshot(query(collection(DATABASE,e),...r),(e=>{e.forEach((e=>t(e.id,e.data())))}))};const rtDB=getDatabase();export const dbr={};const fTIMESTAMP="d";dbr.timestamp=rtdbTimestamp,dbr.get=async function(e){if(!navigator.onLine)return{error:"You are offline."};try{return await get(ref(rtDB,e))}catch(e){return console.error(e),{error:e.code||"unknown error"}}},dbr.write=async function(e,r){if(!navigator.onLine)return{error:"You are offline."};try{return await set(ref(rtDB,e),r)}catch(e){return console.error(e),{error:e.code||"unknown error"}}},dbr.push=async function(e,r){if(!navigator.onLine)return{error:"You are offline."};try{return await set(push(ref(rtDB,e)),r)}catch(e){return console.error(e),{error:e.code||"unknown error"}}},dbr.twoLevelPushListener=function(e,r,t){try{const i=`dbr/${e}`,c=[ref(rtDB,e)],s=[];var o={};let d,l,u={};function n(r,n,a,c){"d"!==n&&(clearTimeout(l),clearTimeout(u[r]),t(r,n,a),o[r].d=Math.max(o[r].d||0,a.d),c||(console.log(`New doc ${c?"from cache":""} ${e}/${r}/${n}: ${JSON.stringify(a)}`),o[r][n]=a,l=setTimeout((()=>{localStorage[i]=JSON.stringify(o)}),250),u[r]=setTimeout((()=>{dbr.write(`${e}/${r}/d`,o[r].d)}),250)))}function a(t,a,i){r(t),i||(o[t]={});for(let e in a)n(t,e,a[e],i);const c=[ref(rtDB,e+"/"+t),orderByChild("d"),dbrStartAt(o[t].d+.1)];i||console.log(`Listening at ${e+"/"+t} (after ${o[t].d})...`),s.push(onChildAdded(dbrQuery(...c),(e=>{e?.key&&n(t,e.key,e.val())})))}try{(o=JSON.parse(localStorage[i])).constructor!==Object&&(o={});for(let f in o)a(f,o[f],!0),d=Math.max(d||0,o[f].d||0)}catch(g){}return d&&c.push(orderByChild("d"),dbrStartAt(d+.1)),console.log(`Listening at ${e} (starting at ${d||0})...`),s.push(onChildAdded(dbrQuery(...c),(e=>{e?.key&&a(e.key,e.val())}))),()=>{console.log(`Unsubscribing ${s.length} listeners.`),s.forEach((e=>e instanceof Function&&e()))}}catch(h){return console.error(h),{error:h.code||"unknown error"}}},window.auth=auth,window.db=db,window.dbr=dbr;