import{arrMean,arrStderr,groupAndSummarize,newEl}from"./common.js";import{popup}from"./popup.js";import{showQuestion}from"../showQuestions.js";import{grid}from"./grid.js";import{}from"./chart.js";import{}from"./chartjs-plugin-zoom.js";import{}from"./chartjs-plugin-annotation.js";function getBounds(t){const[e,a]=t.split("-").map((t=>parseFloat(t.trim())));return{lower:e,upper:a}}function calculateHistogram(t){const e=Math.min(...t),a=Math.max(...t),o=Math.ceil(2*Math.cbrt(t.length)),n=(a-e)/o,r=Array.from({length:o},((t,a)=>({range:`${(e+a*n).toFixed(1)} - ${(e+(a+1)*n).toFixed(1)}`,count:0})));return t.forEach((t=>{const a=Math.min(Math.floor((t-e)/n),o-1);r[a].count++})),r}function linearRegression(t){const e=t.length,a=t.reduce(((t,e)=>t+e.x),0),o=t.reduce(((t,e)=>t+e.y),0),n=(e*t.reduce(((t,e)=>t+e.x*e.y),0)-a*o)/(e*t.reduce(((t,e)=>t+e.x*e.x),0)-a*a);return{m:n,b:(o-n*a)/e}}function getRegressionLine(t,e,a){const{m:o,b:n}=linearRegression(t);return[{x:e,y:o*e+n},{x:a,y:o*a+n}]}function zoomPopup(t,e,a,o,n){if(!Array.isArray(t.data)||t.data.length<=1)return;const r=popup("","",null,"Dismiss",null,{style:{width:"600px",height:"600px"}});if(new Set(t.data).size<5){const e=groupAndSummarize(t.data.map(((e,a)=>({category:e,label:t.content[a]}))),{groupBy:"category",valuesField:"category",labelField:"label"}),o={labels:e.labels,data:e.data.map((t=>t.length)),content:e.content};drawPie(r.main,o,a)}else drawBar(r.main,t,e,a,o,n)}function showContents(t,e,a,o){let n,r;if(n=r=-1,t?.labels&&t.labels.forEach(((t,a)=>{t==e&&(n=a)})),console.log(t),-1==n){let a=getBounds(e);r=[],t.data.forEach(((e,o)=>{a.lower<=e&&a.upper>=e&&r.push([t.content[o],e.toFixed(2)])}))}else r=t.content?t.content[n].map((t=>[t,e])):[];if(r.length>0){let t=popup((o!=a?o:"")+" "+a+" : "+e,"",null,"Dismiss");newEl({},t.main);var i=grid(["Element","Value"],[],{},t.main);r.forEach((t=>{i.addRow([t[0],t[1]])}))}}function copyChartToClipboard(t){const e=t.canvas,a=t.options.plugins.tooltip.enabled;t.options.plugins.tooltip.enabled=!1,t.update(),setTimeout((()=>{e.toBlob((e=>{const o=new ClipboardItem({"image/png":e});navigator.clipboard.write([o]).then((()=>{console.log("Chart copied to clipboard!")})).catch((t=>{console.error("Failed to copy:",t)})),t.options.plugins.tooltip.enabled=a,t.update()}))}),200)}Chart.defaults.color="#a5a5a5",Chart.defaults.borderColor="#aaa",Chart.defaults.plugins.legend.labels.color="#a5a5a5",Chart.defaults.plugins.tooltip.backgroundColor="rgba(0, 0, 0, 1)",Chart.defaults.backgroundColor=["#679436","#a6d96a","#f4a261","#e76f51","#ef233c","#d80032"];export function drawBar(t,e,a,o,n,r,i,l=!1,s){var d,p,c,u,g;if(t.innerHTML="",Array.isArray(e)||null==e.labels){const t=calculateHistogram(e.data);d=t.map((t=>t.range)),p=t.map((t=>t.count)),c=g=d.map((t=>0)),u=d.map((t=>Math.max(p)))}else d=e.labels,p=e.data.map(arrMean),c=e.data.map(arrStderr),u=Math.max(...p.map(((t,e)=>t+c[e]))),g=e.data.map((t=>(Array.isArray(t)||(t=[t]),t.filter((t=>void 0!==t)).length)));if(d.length>25){var h=newEl({className:"toggle-container"},t),m=newEl({tag:"label",className:"toggle-switch"},h),b=newEl({tag:"input",id:"toggleSwitch",type:"checkbox"},m);newEl({tag:"span",className:"slider"},m),newEl({tag:"span",id:"toggleLabel",className:"toggle-label",textContent:"Show Question"},h)}var f=newEl({tag:"canvas",id:t.id},t).getContext("2d");const x=d.map((t=>{let e=a.questions.find((e=>e.id===t));return e?.points||0})),y={low:"rgba(255, 99, 132, 0.8)",medium:"rgba(255, 206, 86, 0.8)",high:"rgba(75, 192, 192, 0.8)"},w=g.map((t=>{var e="high";return l&&(e=t<.33*i?"low":t>.8*i?"high":"medium"),y[e]})),C={id:"referenceLine",afterDraw(t){if(null==s)return;const{ctx:e,scales:{y:a}}=t,o=a.getPixelForValue(s);e.save(),e.beginPath(),e.moveTo(t.chartArea.left,o),e.lineTo(t.chartArea.right,o),e.strokeStyle="red",e.lineWidth=2,e.stroke(),e.restore()}},M={id:"errorBars",afterDatasetsDraw(t){const e=t.ctx;e.save(),e.strokeStyle="white",e.lineWidth=1.5,t.data.datasets.forEach(((a,o)=>{if(!a.errorBars)return;t.getDatasetMeta(o).data.forEach(((o,n)=>{const r=a.errorBars[n];if(!r||r.lower===r.upper)return;const i=o.x,l=t.scales.y.getPixelForValue(r.lower),s=t.scales.y.getPixelForValue(r.upper);e.beginPath(),e.moveTo(i,l),e.lineTo(i,s),e.stroke()}))})),e.restore()}},v={labels:d,datasets:[{data:p,backgroundColor:w,errorBars:p.map(((t,e)=>({lower:t-c[e],upper:t+c[e]})))}]},A={responsive:!0,onClick:(t,i)=>{if(i.length>0){const l=i[0].index,s=E.data.labels[l],d=e?.content?e.content[l]:"";let p=a.questions.find((t=>t.id===s)),c=a.answers[s];if(b?.checked){if(p){let t=popup(s,"",null,"Dismiss"),e=newEl({innerHTML:"Answer: "+c},t.main);showQuestion(e,p,p.id,a.answers,a.answers[p.id])}}else copyChartToClipboard(t.chart),e?.data&&Array.isArray(e.data[l])&&e.data[l].length>1?zoomPopup({data:e.data[l],content:d},a,s,r||s,"Frequency"):showContents(e,s,n,o)}},plugins:{title:{display:!0,text:o,font:{size:25},padding:{top:10,bottom:20},color:"#aaa"},legend:{display:!1},tooltip:{callbacks:{label:function(t){const e=t.dataIndex;return[`Value: ${t.raw.toFixed(2)}`,g[e]>1?`Count: ${g[e]}`:"",0!=x[e]?`Worth: ${x[e]}`:""].filter(Boolean)}}},annotation:{annotations:{referenceLine:{type:"line",yMin:s||0,yMax:s||0,label:{content:"Target",enabled:!0,position:"end"}}}},zoom:{pan:{enabled:!0,mode:"xy"},zoom:{wheel:{enabled:!0},pinch:{enabled:!0},mode:"xy"}}},scales:{x:{title:{display:!0,text:n},ticks:{display:!0},grid:{display:!1}},y:{title:{display:!0,text:r},beginAtZero:!0,max:Math.max(u,s||0),grid:{color:"rgba(207, 196, 196, 0.4)"}}},maintainAspectRatio:!1},E=new Chart(f,{id:"myChart",type:"bar",data:v,options:A,plugins:[M,C]});t.addEventListener("dblclick",(()=>{E.resetZoom()}))}export function drawPie(t,e,a){let o=e.labels,n=e.data,r=n.reduce(((t,e)=>t+e),0);t.innerHTML="";var i=newEl({tag:"canvas",id:t.id},t).getContext("2d");new Chart(i,{type:"pie",data:{labels:o,datasets:[{data:n,borderWidth:1,borderColor:"rgb(43,27,13)"}]},options:{responsive:!0,maintainAspectRatio:!1,layout:{padding:0},onClick:(t,n)=>{if(n.length>0){const r=n[0].index,i=o[r];copyChartToClipboard(t.chart),showContents(e,i,"",a)}},plugins:{title:{display:!0,text:a,font:{size:25},padding:{top:10,bottom:20},color:"#aaa"},legend:{position:"left",labels:{boxWidth:10,font:{size:20},color:"#a5a5a5"}},tooltip:{enabled:!0,callbacks:{label:function(t){t.dataIndex;return[`${t.raw.toFixed(2)} (${100*(t.raw/r).toFixed(2)}%)`].filter(Boolean)}}}}}})}export function drawScatter(t,e,a,o,n,r){if(0==arrStderr(e.map((t=>t.y)))||0==arrStderr(e.map((t=>t.x))))return void(t.innerHTML+="<p>All points have the same value. Cannot plot regression line.</p>");t.innerHTML="";var i=newEl({tag:"canvas",id:t.id,style:{width:"100%",height:"100%"}},t).getContext("2d"),l=Math.min(...e.map((t=>t.x))),s=Math.max(...e.map((t=>t.x))),d=Math.min(...e.map((t=>t.y))),p=Math.max(...e.map((t=>t.y)));const{m:c,b:u}=linearRegression(e),g=getRegressionLine(e,l,s),h=Array.from({length:9},(()=>0));e.forEach((({x:t,y:e})=>{const a=Math.floor((t-l)/(s-l)*3),o=3*Math.floor((e-d)/(p-d)*3)+a;void 0!==h[o]&&h[o]++}));const m=h.indexOf(Math.min(...h)),b=Math.floor(m/3),f=l+(m%3+.5)/3*(s-l),x=d+(b+.5)/3*(p-d);new Chart(i,{type:"scatter",data:{datasets:[{label:"",data:e,backgroundColor:"rgba(70, 193, 230, 0.4)",pointRadius:5},{label:"Regression Line",data:g,type:"line",borderColor:"red",borderWidth:1,fill:!1,pointRadius:0}]},options:{plugins:{title:{display:!0,text:a,font:{size:25},padding:{top:10,bottom:20},color:"#aaa"},legend:{display:!1},annotation:{annotations:{equationLabel:{type:"label",content:`y = ${c.toFixed(2)}x + ${u.toFixed(2)}`,xValue:f,yValue:x,backgroundColor:"#acacac",font:{size:14,weight:"bold",color:"white"},padding:6}}},tooltip:{callbacks:{label:function(t){const e=t.raw;return[`${e.label||"Point"}`,`(${e.x.toFixed(2)}, ${e.y.toFixed(2)})`]}}}},scales:{x:{type:"linear",position:"bottom",title:{display:!0,text:o},grid:{color:"rgba(207, 196, 196, 0.4)"}},y:{beginAtZero:!0,title:{display:!0,text:n},grid:{color:"rgba(207, 196, 196, 0.4)"}}}}})}function uniformDistribution(t,e,a){return t>=e&&t<=a?1/(a-e):0}function normalDistribution(t,e,a){return 1/(a*Math.sqrt(2*Math.PI))*Math.exp(-.5*Math.pow((t-e)/a,2))}