import"https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/codemirror.min.js";import"https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/addon/mode/simple.min.js";const MODE_NAME="reread",BRACKETS={CHAR:"‚¶ã‚¶å",TEXT:"‚¶á‚¶à",OPERATOR:"‚¶ó‚¶ò",COUNT:"‚¶â‚¶ä"},SYMBOLS={GROUP_START:"‚¶Ö",GROUP_END:"‚¶Ü"},COMMENT="‚ßª",ESCAPE="‚çø",ALL_SYMBOLS=[...Object.values(BRACKETS).map((e=>[...e])).flat(),...Object.values(SYMBOLS),"‚ßª","‚çø"],CATEGORIES={OPTIONAL_TEXT:{icon:"¬øAbc?",name:"optional",hint:"Optional text patterns (i.e., text that may or may not appear)."},TOKEN:{icon:"Abc",name:"token",hint:"Common text patterns."},CHARACTER:{icon:"A",name:"character",hint:"Special characters (e.g., tab) and character classes (e.g., alphanumeric)."},COUNT:{icon:"A‚®Ø",name:"instances",hint:"Instance number specification for preceding character or group."},SPECIAL_CHAR:{icon:BRACKETS.TEXT+BRACKETS.COUNT+"‚ßª...",name:"special",hint:"These symbols are treated as special in this editor, and should not be pasted in directly.\nUse these buttons for inserting one of these special characters."}};export const DOC="Note: When a ‚ßªCOMMENT takes up the entire line of text, the line-break on that line is ignored.";export const REREAD=[{r:SYMBOLS.GROUP_START,re:"("},{r:SYMBOLS.GROUP_END,re:")"},{name:"or",r:`${BRACKETS.OPERATOR[0]}or${BRACKETS.OPERATOR[1]}`,re:"|",hint:`${SYMBOLS.GROUP_START}text1${SYMBOLS.GROUP_END} or ${SYMBOLS.GROUP_START}text2${SYMBOLS.GROUP_END}`,example:`${SYMBOLS.GROUP_START}hello${SYMBOLS.GROUP_END}OR${SYMBOLS.GROUP_START}hi${SYMBOLS.GROUP_END} will match either "hello" or "hi"`,class:"cm-rr-operator"},{name:"anything?",cat:CATEGORIES.OPTIONAL_TEXT,r:`${BRACKETS.TEXT[0]}anything?${BRACKETS.TEXT[1]}`,re:"([\\s\\S]*)",hint:"zero or more characters of any kind, including newlines",class:"cm-rr-text"},{name:"spaces?",cat:CATEGORIES.OPTIONAL_TEXT,r:`${BRACKETS.TEXT[0]}spaces?${BRACKETS.TEXT[1]}`,re:"( *)",class:"cm-rr-text",hint:"zero or more spaces"},{name:"spaces/tabs?",cat:CATEGORIES.OPTIONAL_TEXT,r:`${BRACKETS.TEXT[0]}spaces/tabs?${BRACKETS.TEXT[1]}`,re:"([ \\t]*)",hint:"zero or more spaces or tabs",class:"cm-rr-text"},{name:"whitespace?",cat:CATEGORIES.OPTIONAL_TEXT,r:`${BRACKETS.TEXT[0]}whitespace?${BRACKETS.TEXT[1]}`,re:"(\\s*)",hint:"zero or more spaces or tabs or newlines",class:"cm-rr-text"},{name:"not whitespace?",cat:CATEGORIES.OPTIONAL_TEXT,r:`${BRACKETS.TEXT[0]}not whitespace?${BRACKETS.TEXT[1]}`,re:"([\\S]*)",hint:"zero or more of any character except spaces, tabs, or newlines",class:"cm-rr-text"},{name:"not ‚§∂ ?",cat:CATEGORIES.OPTIONAL_TEXT,r:`${BRACKETS.TEXT[0]}not ‚§∂ ?${BRACKETS.TEXT[1]}`,re:"(.*)",hint:"zero or more of any character except newlines",class:"cm-rr-text"},{name:"letters",cat:CATEGORIES.TOKEN,r:`${BRACKETS.TEXT[0]}letters${BRACKETS.TEXT[1]}`,re:"(\\p{L}+)",hint:"one or more letters A-z",class:"cm-rr-text"},{name:"not letters",cat:CATEGORIES.TOKEN,r:`${BRACKETS.TEXT[0]}not letters${BRACKETS.TEXT[1]}`,re:"(\\P{L}+)",hint:"one or more characters that are not letters A-z",class:"cm-rr-text"},{name:"integer",cat:CATEGORIES.TOKEN,r:`${BRACKETS.TEXT[0]}integer${BRACKETS.TEXT[1]}`,re:"(-?\\d+)",hint:"one or more digits, optionally preceded by a negative sign",class:"cm-rr-text"},{name:"number",cat:CATEGORIES.TOKEN,r:`${BRACKETS.TEXT[0]}number${BRACKETS.TEXT[1]}`,re:"(-?\\d+(\\.\\d+)?)",hint:"any standard number (e.g., -12.34, 0.5, 3); does not match scientific notation; does not capture numbers starting with a period (.2 doesn't match, but 0.2 matches)",class:"cm-rr-text"},{name:"letters/digits",cat:CATEGORIES.TOKEN,r:`${BRACKETS.TEXT[0]}letters/digits${BRACKETS.TEXT[1]}`,re:"([\\p{L}0-9]+)",hint:"one or more letters or digits",class:"cm-rr-text"},{name:"symbols",cat:CATEGORIES.TOKEN,r:`${BRACKETS.TEXT[0]}symbols${BRACKETS.TEXT[1]}`,re:"([^\\p{L}0-9]+)",hint:"one or more characters that are not letters nor digits",class:"cm-rr-text"},{name:"spaces",cat:CATEGORIES.TOKEN,r:`${BRACKETS.TEXT[0]}spaces${BRACKETS.TEXT[1]}`,re:"( +)",hint:"one or more spaces",class:"cm-rr-text"},{name:"spaces/tabs",cat:CATEGORIES.TOKEN,r:`${BRACKETS.TEXT[0]}spaces/tabs${BRACKETS.TEXT[1]}`,re:"([ \\t]+)",hint:"one or more spaces or tabs",class:"cm-rr-text"},{name:"whitespace",cat:CATEGORIES.TOKEN,r:`${BRACKETS.TEXT[0]}whitespace${BRACKETS.TEXT[1]}`,re:"(\\s+)",hint:"one or more spaces or tabs or newlines",class:"cm-rr-text"},{name:"‚§∂",cat:CATEGORIES.CHARACTER,r:BRACKETS.CHAR[0]+"‚§∂"+BRACKETS.CHAR[1],re:"\\n",hint:"newline (i.e., line break)",class:"cm-rr-char"},{name:"tab",cat:CATEGORIES.CHARACTER,r:BRACKETS.CHAR[0]+"tab"+BRACKETS.CHAR[1],re:"\\t",class:"cm-rr-char"},{name:"space/tab",cat:CATEGORIES.CHARACTER,r:`${BRACKETS.CHAR[0]}space/tab${BRACKETS.CHAR[1]}`,re:"[ \\t]",hint:"space or tab character",class:"cm-rr-char"},{name:"whitespace",cat:CATEGORIES.CHARACTER,r:`${BRACKETS.CHAR[0]}whitespace${BRACKETS.CHAR[1]}`,re:"\\s",hint:"whitespace character (space, tab, newline)",class:"cm-rr-char"},{name:"not whitespace",cat:CATEGORIES.CHARACTER,r:`${BRACKETS.CHAR[0]}not whitespace${BRACKETS.CHAR[1]}`,re:"\\S",hint:"any character except space, tab, or newline",class:"cm-rr-char"},{name:"not ‚§∂",cat:CATEGORIES.CHARACTER,r:`${BRACKETS.CHAR[0]}not ‚§∂${BRACKETS.CHAR[1]}`,re:".",hint:"any character except newline",class:"cm-rr-char"},{name:"any char",cat:CATEGORIES.CHARACTER,r:`${BRACKETS.CHAR[0]}any char${SYMBOLS.NEWLINE}${BRACKETS.CHAR[1]}`,re:"[\\s\\S]",hint:"any character (including whitespace)",class:"cm-rr-char"},{name:"letter",cat:CATEGORIES.CHARACTER,r:`${BRACKETS.CHAR[0]}letter${BRACKETS.CHAR[1]}`,re:"[A-Za-z]",hint:"any letter",class:"cm-rr-char"},{name:"digit",cat:CATEGORIES.CHARACTER,r:`${BRACKETS.CHAR[0]}digit${BRACKETS.CHAR[1]}`,re:"\\d",hint:"any digit",class:"cm-rr-char"},{name:"1+",cat:CATEGORIES.COUNT,r:`${BRACKETS.COUNT[0]}1+${BRACKETS.COUNT[1]}`,re:"+",hint:"one or more instances of preceding character or group",class:"cm-rr-count"},{name:"0+",cat:CATEGORIES.COUNT,r:`${BRACKETS.COUNT[0]}0+${BRACKETS.COUNT[1]}`,re:"*",hint:"zero or more instances of preceding character or group",class:"cm-rr-count"},{name:"0 or 1",cat:CATEGORIES.COUNT,r:`${BRACKETS.COUNT[0]}0 or 1${BRACKETS.COUNT[1]}`,re:"?",hint:"zero or one instances of preceding character or group",class:"cm-rr-count"}];ALL_SYMBOLS.forEach((e=>REREAD.push({name:e,cat:CATEGORIES.SPECIAL_CHAR,r:"‚çø"+e,re:e,hint:`insert special character '${e}'`,class:"rr-special-char"})));export const rereadBtns=[{name:`${SYMBOLS.GROUP_START} ${SYMBOLS.GROUP_END}`,hint:"group",class:"cm-rr-operator",action:e=>{e.replaceSelection(SYMBOLS.GROUP_START+e.getSelection()+SYMBOLS.GROUP_END),e.focus()}},...REREAD.filter((e=>e.name)),{name:"‚ßª COMMENT",hint:"add a comment (the comment will be ignored for pattern matching)",class:"rr-comment-btn",action:e=>{const r=e.getSelection();e.replaceSelection("‚ßª"+r),e.focus()}}];function defaultAction(e){return function(r){r.replaceSelection(e.r),r.focus()}}function defaultGroupAction(e){return function(r){const t=r.getSelection();t?1==t.length?r.replaceSelection(t+e.r):r.replaceSelection(SYMBOLS.GROUP_START+t+SYMBOLS.GROUP_END+e.r):r.replaceSelection(e.r),r.focus()}}for(const e of rereadBtns)e.action||(e.cat===CATEGORIES.COUNT?e.action=defaultGroupAction(e):e.action=defaultAction(e));const div=(...e)=>{const r=document.createElement("div");return r.classList.add(...e),r};export function rereadButtonBar(e){const r=div("rr-button-row"),t={};for(const n of rereadBtns){const a=div(n.class);if(a.innerText=n.name,a.title=n.hint,a.onclick=()=>n.action(e),n.cat){if(!t[n.cat.name]){const e=div(n.class);e.innerText=n.cat.icon+"  üûÉ",e.onclick=()=>{};const a=e.appendChild(div("rr-button-menu"));a.innerHTML=n.cat.hint,t[n.cat.name]=a.appendChild(div("rr-button-row")),r.appendChild(e)}t[n.cat.name].appendChild(a)}else r.appendChild(a)}return r}export function rrNoComments(e){return e.replace(new RegExp("(?<!‚çø)‚ßª.*","gm"),"")}export function checkRr(e){if(!e)return;const r=(e=rrNoComments(e)).match(new RegExp(`(${BRACKETS.CHAR[0]}.*?${BRACKETS.CHAR[1]})|(${BRACKETS.TEXT[0]}.*?${BRACKETS.TEXT[1]})|(${BRACKETS.OPERATOR[0]}.*?${BRACKETS.OPERATOR[1]})|(${BRACKETS.COUNT[0]}.*?${BRACKETS.COUNT[1]})`,"gm"));if(!r)return!0;for(let e of r)if(!REREAD.find((r=>r.r===e)))return!1;return!0}export function rrToRe(e){let r="",t=0;for(;t<e.length;){const n=e[t];if("‚çø"===n)r+=e[t+1],t+=2;else if("‚ßª"===n){const r=0===t||"\n"===e[t-1];for(;t<e.length&&"\n"!==e[t];)t++;r&&t++}else{let a=!1;for(const n of REREAD)if(e.startsWith(n.r,t)){r+=n.re,t+=n.r.length,a=!0;break}a||(r+=n.replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&"),t++)}}return r}const sortedRereadPatterns=REREAD.toSorted(((e,r)=>e.re.length>r.re.length?-1:1));export function reToRr(e){let r="",t=0;for(;t<e.length;){const n=e[t];if("\\"===n){r+=e[t+1],t+=2;continue}let a=!1;for(const n of sortedRereadPatterns)if(e.startsWith(n.re,t)){r+=n.r,t+=n.re.length,a=!0;break}a||(r+=n,t++)}return r}export function textToRr(e){e=e.replace(new RegExp("‚çø","g"),"‚çø‚çø");for(let r of ALL_SYMBOLS)"‚çø"!==r&&(e=e.replace(new RegExp(r,"g"),"‚çø"+r));return e}export function rrToHTML(e){const r=e=>e.replace("<","&lt;").replace(">","&gt;");let t="<pre>",n="start",a=0;for(;a<e.length;){const o=e.slice(a);let c;for(let e of REREAD_SIMPLE_MODE[n])if(c=o.match(new RegExp("^"+e.regex.source)),c){const o=c[0].length,s=r(c[0]);if(e.token){let r=e.token?.split(" ").map((e=>`cm-${e}`)).join(" ")||"";r&&(r=` class="rr-atomic-unit ${r}"`),t+=`<span${r}>${s}</span>`}else t+=s;n=e.next||n,a+=o;break}c||(t+=r(e[a]),a++)}return t+"</pre>"}export function rrToText(e){if(!e)return"";let r="",t=0;for(;t<e.length;){const n=e[t];if("‚çø"===n)r+=e[t+1],t+=2;else if("‚ßª"===n){const r=0===t||"\n"===e[t-1];for(;t<e.length&&"\n"!==e[t];)t++;r&&t++}else{for(const r of REREAD)if(e.startsWith(r.r,t))return!1;r+=n,t++}}return r}export function matchRe(e,r,t,n,a,o){try{return new RegExp((t?"^":"")+e+(n?"$":""),"u"+(a?"":"i")).test(r)?!o:o}catch(e){return!1}}export function matchRr(e,r,t,n,a,o){matchRe(rrToRe(e),r,t,n,a,o)}const REREAD_SIMPLE_MODE={start:[{regex:new RegExp("‚çø"),token:"rr-bracket rr-escape",next:"escaped"},{regex:new RegExp("‚ßª.*"),token:"rr-comment"},{regex:new RegExp(BRACKETS.CHAR[0]),token:"rr-char rr-bracket rr-start",next:"char"},{regex:new RegExp(BRACKETS.TEXT[0]),token:"rr-text rr-bracket rr-start",next:"text"},{regex:new RegExp(BRACKETS.OPERATOR[0]),token:"rr-operator rr-bracket rr-start",next:"operator"},{regex:new RegExp(BRACKETS.COUNT[0]),token:"rr-count rr-bracket rr-start",next:"count"},{regex:new RegExp(`[${Object.values(SYMBOLS).join("")}]`),token:"rr-symbol"},{regex:/./,token:null}],char:[{regex:new RegExp(`${BRACKETS.CHAR[1]}`),token:"rr-char rr-bracket rr-end",pop:!0,next:"start"},{regex:/./,token:"rr-char"}],text:[{regex:new RegExp(`${BRACKETS.TEXT[1]}`),token:"rr-text rr-bracket rr-end",pop:!0,next:"start"},{regex:/./,token:"rr-text"}],operator:[{regex:new RegExp(`${BRACKETS.OPERATOR[1]}`),token:"rr-operator rr-bracket rr-end",pop:!0,next:"start"},{regex:/./,token:"rr-operator"}],count:[{regex:new RegExp(`${BRACKETS.COUNT[1]}`),token:"rr-count rr-bracket rr-end",pop:!0,next:"start"},{regex:/./,token:"rr-count"}],escaped:[{regex:/[^]/,token:null,pop:!0,next:"start"}],meta:{lineComment:"‚ßª"}};function setAtoms(e){if(e.getAllMarks().forEach((e=>e.clear())),"reread"!==e.getOption("mode"))return;const r=Object.values(BRACKETS).map((([e,r])=>`${e}[\\s\\S]*?${r}`)).join("|")+"|‚çø.",t=new RegExp(r,"g"),n=e.getValue().split("\n");for(let r=0;r<n.length;r++){const a=n[r];let o;for(;o=t.exec(a);){const t={line:r,ch:o.index},n={line:r,ch:o.index+o[0].length};if(t.ch||t.line){const e=a.slice(0,t.ch);if(e.match(new RegExp("^‚ßª")))continue;if(e.match(new RegExp("[^‚çø]‚ßª")))continue}e.markText(t,n,{atomic:!0,className:"rr-atomic-unit",title:REREAD.find((e=>e.r===o[0]))?.hint||""})}}}CodeMirror.defineSimpleMode("reread",REREAD_SIMPLE_MODE),CodeMirror.modeInitFunctions||(CodeMirror.modeInitFunctions={}),CodeMirror.modeInitFunctions.reread=function(e){console.log("initializing","reread"),setAtoms(e),e.on("change",setAtoms),e.toRe=()=>rrToRe(e.getValue()),e.on("optionChange",(function e(r,t){"mode"===t&&"reread"!==r.getOption("mode")&&(r.getAllMarks().forEach((e=>e.clear())),r.off("change",setAtoms),r.off("optionChange",e),delete r.toRe)}))};const CSS="\n.rr-button-row {\n  display: flex;\n  flex-wrap: wrap;\n  place-content: flex-start center;\n  gap: 0.25em;\n  font-size: 85%;\n}\n.rr-button-row > * {\n  padding: .1em .75em;\n  border-radius: 4px;\n  background-color: #444;\n  color: #ccc;\n  position: relative;\n}\n.rr-button-row > *:hover {\n  cursor: pointer;\n  outline: 1px solid #888;\n}\n.rr-button-row > * > .rr-button-menu {\n  visibility: hidden;\n  z-index: 10;\n  padding: 1em;\n  background-color: #eee;\n  box-shadow: rgba(0, 0, 0, 0.35) 0px 5px 15px;\n  color: #222;\n  position: absolute;\n  top: 101%;\n  left: 50%;\n  transform: translateX(-50%);\n  width: max-content;\n  max-width: 300px;\n  display: flex;\n  flex-direction: column;\n  gap: 0.5em;\n}\n.rr-button-row > *:hover > .rr-button-menu {\n  visibility: visible;\n}\n\n.rr-atomic-unit {\n  /*border: 1px dashed #888;\n  font-family: 'Arial Narrow';*/\n  font-size: 70%;\n}\n\n.cm-rr-comment {\n  padding-left: .15em;\n  color: #888;\n  font-style: italic;\n}\n.rr-comment-btn {\n  background-color: #888;\n  color: #fff;\n  font-style: italic;\n}\n\n.cm-rr-symbol {\n  color: #808;\n}\n\n.cm-rr-operator {\n  background-color: #ddd;\n  color: #808;\n}\n\n.cm-rr-char {\n  background-color: #fc8;\n  color: #004;\n  border-radius: 1px;\n}\n\n.cm-rr-text {\n  background-color: #8dd;\n  color: #004;\n}\n.cm-rr-text.cm-rr-bracket.cm-rr-start {\n  padding: 0 0.1em;\n  border-radius: 999em 0 0 999em;\n}\n.cm-rr-text.cm-rr-bracket.cm-rr-end {\n  padding: 0 0.1em;\n  border-radius: 0 999em 999em 0;\n}\n\n.cm-rr-count {\n  background-color: #355;\n  color: #eee;\n  border-top-left-radius: 0;\n  border-bottom-left-radius: 0;\n}\n.cm-rr-count.cm-rr-bracket.cm-rr-start {\n  --radius: .2em;\n  -webkit-mask: radial-gradient(circle var(--radius) at -5% 50%, transparent 0, transparent var(--radius), black var(--radius));\n  mask: radial-gradient(circle var(--radius) at -5% 50%, transparent 0, transparent var(--radius), black var(--radius));\n}\n.cm-rr-count.cm-rr-bracket.cm-rr-end {\n  border-radius: 0 2px 2px 0;\n}\n\n.cm-rr-bracket {\n  color: transparent;\n}\n.cm-rr-bracket.cm-rr-start {\n  margin-left: .75px;\n}\n\n.cm-rr-escape {\n  font-size: 1px;\n}\n";document.head.appendChild(Object.assign(document.createElement("style"),{textContent:CSS}));