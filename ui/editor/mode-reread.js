import"https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/codemirror.min.js";import"https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/addon/mode/simple.min.js";const MODE_NAME="reread",BRACKETS={CHAR:"⦋⦌",TEXT:"⦇⦈",OPERATOR:"⦗⦘",COUNT:"⦉⦊"},SYMBOLS={NEWLINE:"⤶",TAB:"⇥",GROUP_START:"⦅",GROUP_END:"⦆"},COMMENT="⧻",ESCAPE="⍿",ALL_SYMBOLS=[...Object.values(BRACKETS).map((r=>[...r])).flat(),...Object.values(SYMBOLS),"⧻","⍿"],CATEGORIES={SPECIAL_CHAR:"special character",OPTIONAL_TEXT:"optional text",TOKEN:"token",CHARACTER:"character",COUNT:"⨯ instance number"};export const REREAD=[{r:SYMBOLS.GROUP_START,re:"("},{r:SYMBOLS.GROUP_END,re:")"},{name:"or",r:`${BRACKETS.OPERATOR[0]}or${BRACKETS.OPERATOR[1]}`,re:"|",hint:`${SYMBOLS.GROUP_START}text1${SYMBOLS.GROUP_END} or ${SYMBOLS.GROUP_START}text2${SYMBOLS.GROUP_END}`,example:`${SYMBOLS.GROUP_START}hello${SYMBOLS.GROUP_END}OR${SYMBOLS.GROUP_START}hi${SYMBOLS.GROUP_END} will match either "hello" or "hi"`,class:"cm-rr-operator"},{name:"any text or ⤶",cat:CATEGORIES.OPTIONAL_TEXT,r:`${BRACKETS.TEXT[0]}any text or ⤶${BRACKETS.TEXT[1]}`,re:"[\\s\\S]*",hint:"any text, including newlines",class:"cm-rr-text"},{name:"any text",cat:CATEGORIES.OPTIONAL_TEXT,r:`${BRACKETS.TEXT[0]}any text${BRACKETS.TEXT[1]}`,re:".*",hint:"any text except newlines",class:"cm-rr-text"},{name:"any spaces",cat:CATEGORIES.OPTIONAL_TEXT,r:`${BRACKETS.TEXT[0]}any spaces${BRACKETS.TEXT[1]}`,re:" *",class:"cm-rr-text",hint:"zero or more spaces"},{name:"any spaces/tabs",cat:CATEGORIES.OPTIONAL_TEXT,r:`${BRACKETS.TEXT[0]}any spaces/tabs${BRACKETS.TEXT[1]}`,re:"[ \\t]*",hint:"zero or more spaces or tabs",class:"cm-rr-text"},{name:"any whitespace",cat:CATEGORIES.OPTIONAL_TEXT,r:`${BRACKETS.TEXT[0]}any whitespace${BRACKETS.TEXT[1]}`,re:"\\s*",hint:"zero or more spaces or tabs or newlines",class:"cm-rr-text"},{name:"word",cat:CATEGORIES.TOKEN,r:`${BRACKETS.TEXT[0]}word${BRACKETS.TEXT[1]}`,re:"(?<![a-zA-Z])[a-zA-Z]+(?![a-zA-Z])",hint:"one or more letters surrounded by non-letters",class:"cm-rr-text"},{name:"letters",cat:CATEGORIES.TOKEN,r:`${BRACKETS.TEXT[0]}letters${BRACKETS.TEXT[1]}`,re:"[A-Za-z]+",hint:"one or more letters",class:"cm-rr-text"},{name:"integer",cat:CATEGORIES.TOKEN,r:`${BRACKETS.TEXT[0]}integer${BRACKETS.TEXT[1]}`,re:"-?\\d+",hint:"one or more digits, optionally preceded by a negative sign",class:"cm-rr-text"},{name:"number",cat:CATEGORIES.TOKEN,r:`${BRACKETS.TEXT[0]}number${BRACKETS.TEXT[1]}`,re:"-?\\d+(\\.\\d+)?",hint:"any number (e.g., -12.34, 0.5, 3)",class:"cm-rr-text"},{name:"id",cat:CATEGORIES.TOKEN,r:`${BRACKETS.TEXT[0]}id${BRACKETS.TEXT[1]}`,re:"\\b\\w+\\b",hint:"one or more valid ID characters (letters, numbers, _) surrounded by non-ID characters",class:"cm-rr-text"},{name:"letters/digits",cat:CATEGORIES.TOKEN,r:`${BRACKETS.TEXT[0]}letters/digits${BRACKETS.TEXT[1]}`,re:"[A-Za-z0-9]+",hint:"one or more letters or digits",class:"cm-rr-text"},{name:"symbols",cat:CATEGORIES.TOKEN,r:`${BRACKETS.TEXT[0]}symbols${BRACKETS.TEXT[1]}`,re:"[^A-Za-z0-9]+",hint:"one or more characters that are not letters nor digits",class:"cm-rr-text"},{name:SYMBOLS.NEWLINE,cat:CATEGORIES.CHARACTER,r:SYMBOLS.NEWLINE,re:"\\n",hint:"newline",class:"cm-rr-char"},{name:SYMBOLS.TAB,cat:CATEGORIES.CHARACTER,r:SYMBOLS.TAB,re:"\\t",hint:"tab",class:"cm-rr-char"},{name:"space/tab",cat:CATEGORIES.CHARACTER,r:`${BRACKETS.CHAR[0]}space/tab${BRACKETS.CHAR[1]}`,re:"[ \\t]",hint:"space or tab character",class:"cm-rr-char"},{name:"whitespace",cat:CATEGORIES.CHARACTER,r:`${BRACKETS.CHAR[0]}whitespace${BRACKETS.CHAR[1]}`,re:"\\s",hint:"whitespace character (space, tab, newline)",class:"cm-rr-char"},{name:"any char",cat:CATEGORIES.CHARACTER,r:`${BRACKETS.CHAR[0]}any char${BRACKETS.CHAR[1]}`,re:".",hint:"any character except newline",class:"cm-rr-char"},{name:"letter",cat:CATEGORIES.CHARACTER,r:`${BRACKETS.CHAR[0]}letter${BRACKETS.CHAR[1]}`,re:"[A-Za-z]",hint:"any letter",class:"cm-rr-char"},{name:"digit",cat:CATEGORIES.CHARACTER,r:`${BRACKETS.CHAR[0]}digit${BRACKETS.CHAR[1]}`,re:"\\d",hint:"any digit",class:"cm-rr-char"},{name:"1+",cat:CATEGORIES.COUNT,r:`${BRACKETS.COUNT[0]}1+${BRACKETS.COUNT[1]}`,re:"+",hint:"one or more instances of preceding character or group",class:"cm-rr-count"},{name:"0+",cat:CATEGORIES.COUNT,r:`${BRACKETS.COUNT[0]}0+${BRACKETS.COUNT[1]}`,re:"*",hint:"zero or more instances of preceding character or group",class:"cm-rr-count"},{name:"0 or 1",cat:CATEGORIES.COUNT,r:`${BRACKETS.COUNT[0]}0 or 1${BRACKETS.COUNT[1]}`,re:"?",hint:"zero or one instances of preceding character or group",class:"cm-rr-count"}];ALL_SYMBOLS.forEach((r=>REREAD.push({name:r,cat:CATEGORIES.SPECIAL_CHAR,r:"⍿"+r,re:r,hint:`insert special character '${r}'`,class:"rr-special-char"})));export const rereadBtns=[{name:`${SYMBOLS.GROUP_START} ${SYMBOLS.GROUP_END}`,hint:"group",class:"cm-rr-operator",action:r=>r.replaceSelection(SYMBOLS.GROUP_START+r.getSelection()+SYMBOLS.GROUP_END)},...REREAD.filter((r=>r.name)),{name:"⧻ COMMENT",hint:"add a comment (the comment will be ignored for pattern matching)",class:"rr-comment-btn",action:r=>{const e=r.getSelection();r.replaceSelection("⧻"+e),r.focus()}}];function defaultAction(r){return function(e){e.replaceSelection(r.r),e.focus()}}function defaultGroupAction(r){return function(e){const t=e.getSelection();t?1==t.length?e.replaceSelection(t+r.r):e.replaceSelection(SYMBOLS.GROUP_START+t+SYMBOLS.GROUP_END+r.r):e.replaceSelection(r.r),e.focus()}}for(const r of rereadBtns)r.action||(r.cat===CATEGORIES.COUNT?r.action=defaultGroupAction(r):r.action=defaultAction(r));export function toRe(r){let e="",t=0;for(;t<r.length;){const n=r[t];if("⍿"===n)e+=r[t+1],t+=2;else if("⧻"===n)for(;t<r.length&&"\n"!==r[t];)t++;else{let a=!1;for(const n of REREAD)if(r.startsWith(n.r,t)){e+=n.re,t+=n.r.length,a=!0;break}a||(e+=n.replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&"),t++)}}return e}export function matchRe(r,e,t,n,a){try{return new RegExp((t?"^":"")+r+(n?"$":""),a?"":"i").test(e)}catch(r){return!1}}export function match(r,e,t,n,a){return matchRe(toRe(r),e,t,n,a)}const CSS="\n.rr-atomic-unit {\n  /*border: 1px dashed #888;\n  font-family: 'Arial Narrow';*/\n  font-size: 70%;\n}\n\n.cm-rr-comment {\n  padding-left: .15em;\n  color: #888;\n  font-style: italic;\n}\n.rr-comment-btn {\n  background-color: #888;\n  color: #fff;\n  font-style: italic;\n}\n\n.cm-rr-operator {\n  background-color: #ddd;\n  color: #808;\n}\n\n.cm-rr-char {\n  background-color: #fc8;\n  color: #004;\n  border-radius: 1px;\n}\n\n.cm-rr-text {\n  background-color: #8dd;\n  color: #004;\n}\n.cm-rr-text.cm-rr-bracket.cm-rr-start {\n  padding: 0 0.1em;\n  border-radius: 999em 0 0 999em;\n}\n.cm-rr-text.cm-rr-bracket.cm-rr-end {\n  padding: 0 0.1em;\n  border-radius: 0 999em 999em 0;\n}\n\n.cm-rr-count {\n  background-color: #355;\n  color: #eee;\n}\n.cm-rr-count.cm-rr-bracket.cm-rr-start {\n  --radius: .2em;\n  -webkit-mask: radial-gradient(circle var(--radius) at -5% 50%, transparent 0, transparent var(--radius), black var(--radius));\n  mask: radial-gradient(circle var(--radius) at -5% 50%, transparent 0, transparent var(--radius), black var(--radius));\n}\n.cm-rr-count.cm-rr-bracket.cm-rr-end {\n  border-radius: 0 2px 2px 0;\n}\n\n.cm-rr-bracket {\n  color: transparent;\n}\n.cm-rr-bracket.cm-rr-end {\n  -margin-right: 0.5px;\n}\n.cm-rr-bracket.cm-rr-start {\n  margin-left: 0.5px;\n}\n\n.cm-rr-escape {\n  font-size: 1px;\n}\n";function setAtoms(r){if(r.getAllMarks().forEach((r=>r.clear())),"reread"!==r.getOption("mode"))return;const e=Object.values(BRACKETS).map((([r,e])=>`${r}[\\s\\S]*?${e}`)).join("|")+"|⍿.",t=new RegExp(e,"g"),n=r.getValue().split("\n");for(let e=0;e<n.length;e++){const a=n[e];let c;for(;c=t.exec(a);){const t={line:e,ch:c.index},n={line:e,ch:c.index+c[0].length};if(t.ch||t.line){const r=a.slice(0,t.ch);if(r.match(new RegExp("^⧻")))continue;if(r.match(new RegExp("[^⍿]⧻")))continue}r.markText(t,n,{atomic:!0,className:"rr-atomic-unit"})}}}document.head.appendChild(Object.assign(document.createElement("style"),{textContent:CSS})),CodeMirror.defineSimpleMode("reread",{start:[{regex:new RegExp("⍿"),token:"rr-bracket rr-escape",next:"escaped"},{regex:new RegExp("⧻.*"),token:"rr-comment"},{regex:new RegExp(BRACKETS.CHAR[0]),token:"rr-char rr-bracket rr-start",next:"char"},{regex:new RegExp(BRACKETS.TEXT[0]),token:"rr-text rr-bracket rr-start",next:"text"},{regex:new RegExp(BRACKETS.OPERATOR[0]),token:"rr-operator rr-bracket rr-start",next:"operator"},{regex:new RegExp(BRACKETS.COUNT[0]),token:"rr-count rr-bracket rr-start",next:"count"},{regex:new RegExp(`[${Object.values(SYMBOLS).join("")}]`),token:"keyword"},{regex:/./,token:null}],char:[{regex:new RegExp(`${BRACKETS.CHAR[1]}`),token:"rr-char rr-bracket rr-end",pop:!0,next:"start"},{regex:/./,token:"rr-char"}],text:[{regex:new RegExp(`${BRACKETS.TEXT[1]}`),token:"rr-text rr-bracket rr-end",pop:!0,next:"start"},{regex:/./,token:"rr-text"}],operator:[{regex:new RegExp(`${BRACKETS.OPERATOR[1]}`),token:"rr-operator rr-bracket rr-end",pop:!0,next:"start"},{regex:/./,token:"rr-operator"}],count:[{regex:new RegExp(`${BRACKETS.COUNT[1]}`),token:"rr-count rr-bracket rr-end",pop:!0,next:"start"},{regex:/./,token:"rr-count"}],escaped:[{regex:/[^]/,token:null,pop:!0,next:"start"}],meta:{lineComment:"⧻"}}),CodeMirror.modeInitFunctions||(CodeMirror.modeInitFunctions={}),CodeMirror.modeInitFunctions.reread=function(r){console.log("initializing","reread"),setAtoms(r),r.on("change",setAtoms),r.toRe=()=>toRe(r.getValue()),r.on("optionChange",(function r(e,t){"mode"===t&&"reread"!==e.getOption("mode")&&(e.getAllMarks().forEach((r=>r.clear())),e.off("change",setAtoms),e.off("optionChange",r),delete e.toRe)}))};