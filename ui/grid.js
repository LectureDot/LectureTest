import{arrayToCsv,isNum,isStr,newEl,pad0,span}from"./common.js";import styles from"./grid.css"with{type:"css"};document.adoptedStyleSheets.push(styles);export function grid(e,t,r,n){r.className?r.className+=" grid":r.className="grid";const o=newEl(r,n);o.setCols=e=>o.style.setProperty("--cols",e),o.addRow=function(e,t={},r){const n=newEl(t);isNum(r)&&r<o.children.length?o.insertBefore(n,o.children[r]):o.appendChild(n);for(let t of e)t instanceof HTMLElement?n.appendChild(t):span({innerHTML:t.toString()},n);return e.length&&o.setCols(e.length),n},o.setHeader=function(e){o.headerRow&&o.headerRow.remove(),o.headerRow=o.addRow(e,{className:"header"},0);for(let e=0;e<o.headerRow.children.length;e++){o.headerRow.children[e].addEventListener("click",(t=>o.sort(e)))}},o.clearDataRows=function(){for(let e of[...o.children])e!==o.headerRow&&e.remove()},o.getCSV=function(){return arrayToCsv([...o.children].map((e=>[...e.children].map((e=>isNaN(Number(e.textContent))?e.textContent:Number(e.textContent))))))},o.sortDirection=[],o.resort=function(){o.sortDirection[o.lastSort||0]*=-1,o.sort(o.lastSort||0)},o.sort=function(e,t=!0){clearTimeout(o.sortTimeout),o.lastSort=e,o.sortTimeout=setTimeout((()=>{let r;r=t?o.sortDirection[e]||1:t?1:-1,o.sortDirection[e]=-r,[...o.children].slice(1).toSorted(((t,n)=>getElementText(t.children[e])>getElementText(n.children[e])?r:-r)).forEach((e=>o.appendChild(e)))}),50)},e&&o.setHeader(e);for(let e of t)o.addRow(e);return o}function getElementText(e){if(isStr(e))return e;if(!e)return"";let t="";e.textContent?t+=e.textContent:void 0!==e.value&&null!==e.value?t+=e.value:e.className&&(t+=e.className);let r=parseFloat(t);if(!isNaN(r)){let[e,n]=r.toString().split(".");t=e.padStart(7,"0")+"."+(n||"0").padEnd(7,"0")+t.slice(r.toString().length)}if(e.children&&e.children.length>0)for(const r of e.children)t+=getElementText(r);return t.toLowerCase()}