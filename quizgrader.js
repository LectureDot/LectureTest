import{isArr,span,addElementTo,input,button}from"./ui/common.js";import{showQuestion}from"./showQuestions.js";import{popup}from"./ui/popup.js";import{grid}from"./ui/grid.js";import{reindent}from"./indentation.js";function countCommonElements(e,i){const n=new Set(e);let t=0;for(const e of i)n.has(e)&&t++;return t}export function quizGrader(e,i,n,t,o,s){e.innerHTML="";const a=checkAnswers(i,n,t),r={};var c=JSON.parse(JSON.stringify(t));console.log(t),addElementTo(e,{innerHTML:"Auto Score:"+checkScore(i,a),className:"score"});const d=addElementTo(e,{innerHTML:"Final Score:"+checkScore(i,a),className:"score"});let l=grid([],{className:"submission-table"},e);l.addRow(["QID","Category","Worth","Prompt","Correct Answer","Submission","AutoGrader","Points"],{className:"header"}),(i.questions||[]).forEach(((e,i)=>{t[e.id]?t[e.id].p=t[e.id]?.p||(e.points||1)*(!0===a[e.id]):t[e.id]={p:0},r[e.id]=(e.points||1)*(!0===a[e.id]);let o=e.points;const s=span({id:e.id,style:{display:"flex",alignItems:"start"}}),p=input({type:"number",style:{width:"40px",color:t[e.id].p===r[e.id]?"black":"purple"},min:0,value:t[e.id].p,events:{change:i=>{let n=Number(i.target.value);i.target.style.color=n>o?"red":n==r[e.id]?"black":"purple",t[e.id].p=Number(n),d.innerHTML="Final Score:"+Object.values(t).reduce(((e,i)=>e+(i.p||0)),0)}}},s);addElementTo(s,{tag:"i",className:"icon-btn fa-solid fa-check",events:{click:e=>{p.input.value=Number(o),p.input.dispatchEvent(new Event("change"))}}}),addElementTo(s,{tag:"i",className:"icon-btn fa-solid fa-xmark",events:{click:e=>{p.input.value=0,p.input.dispatchEvent(new Event("change"))}}}),l.addRow([e.id,e.category,(e.points||1).toFixed(1),span({innerHTML:e.prompt,events:{click:i=>{let n=popup("","",null,"Dismiss");showQuestion(n.main,e,e.id,c)}}}),span({innerHTML:n[e.id].map((e=>`<div style='border-bottom:solid 1px gray'>${e.A?e.A.join("\n"):e}</div>`)).join(""),style:{color:"green",whiteSpace:"pre",fontFamily:"monospace"}}),span({innerText:isArr(t[e.id]?.a)?t[e.id].a.join("\n"):t[e.id]?.a||"",style:{color:"blue",whiteSpace:"pre",fontFamily:"monospace"}}),!0===a[e.id]?'<i class="icon-btn fa-solid fa-check"></i>':!1===a[e.id]?'<i class="icon-btn fa-solid fa-xmark"></i>':null===a[e.id]?'<i class="icon-btn fa-solid fa-minus"></i>':'<i class="icon-btn fa-solid fa-circle-exclamation"></i>',s],{id:i})})),addElementTo(e,{tag:"i",className:"icon-btn fa-solid fa-file-export",events:{click:e=>{console.log("Saving:",t),c=JSON.parse(JSON.stringify(t)),o&&o(t)}}}),addElementTo(e,{tag:"i",className:"icon-btn fa-solid fa-door-closed",events:{click:e=>{if(JSON.stringify(t)!==JSON.stringify(c)){const e=popup("","Changes NOT saved! Are you sure?",button({textContent:"YES",events:{click:()=>{s&&s(),e.close()}}}),"No")}else s&&s()}}})}export function checkAnswers(e,i,n){const t={};return(e.questions||[]).forEach((e=>{if(t[e.id]=null,n[e.id]?.a&&(!isArr(n[e.id].a)||n[e.id].a.length)){if(!i[e.id]||isArr(i[e.id])&&0===i[e.id].length)t[e.id]="check";else if("MCQ"==e.category||"OEQ"==e.category||"CODE"==e.category){let o=n[e.id].a,s=i[e.id];e.case_sensitive||(o=o.toUpperCase(),s=s.map((e=>e?e.toUpperCase():e))),e.space_sensitive||(o=o.trim(),s=s.map((e=>e?e.trim():e))),"CODE"==e.category&&(o=reindent(o),s=s.map((e=>reindent(e)))),t[e.id]=s.includes(o)}else if("MRQ"==e.category){let o=!1;i[e.id].forEach((i=>{o=countCommonElements(i.A,n[e.id].a)==i.A.length})),t[e.id]=o}else if("PARSONS"==e.category){let o=!1;i[e.id].forEach((i=>{i.A&&reindent(i.A.join("\n"))==reindent(n[e.id].a.join("\n"))&&(o=!0)})),t[e.id]=o}i[e.id].includes(!1)&&!1===t[e.id]&&(t[e.id]="check")}})),t}export function checkScore(e,i){let n=0;return(e.questions||[]).forEach((e=>{let t=e?.points||1;1==i[e.id]&&(n+=t)})),n}