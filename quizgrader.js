import{isArr,isStr,span,input,copyToClipboard,newEl,button,isNum}from"./ui/common.js";import{showQuestion}from"./showQuestions.js";import{popup}from"./ui/popup.js";import{grid}from"./ui/grid.js";import{reindent}from"./indentation.js";import{F}from"./schema.js";import{run as runPython,unitTest as pyUnitTest}from"./util/pyodide.js";import{compareText}from"./util/compareText.js";import{haveSameMembers}from"./util/utils.js";import{runUnitTest}from"./util/unitTest.js";import{reToRr,rrToHTML}from"./ui/editor/reread.js";export async function quizGrader(e,i,n,t,s){const o=t.answers,r=await checkAnswers(i,n,o),a={},c={...s};var d,l;if(e&&(e.innerHTML="",newEl({innerHTML:"Exam Duration:"+(t.duration/6e4).toFixed(1)+"min",className:"score"},e),newEl({innerHTML:"Auto Score:"+checkScore(i,r),className:"score"},e),d=newEl({innerHTML:"Final Score:"+checkScore(i,r),className:"score"},e),l=grid(["QID","Category","Worth","Prompt","Correct Answer","Submission","AutoGrader","Points"],[],{className:"submission-table"},e)),(i.questions||[]).forEach(((i,t)=>{a[i.id]="check"===r[i.id]?void 0:(i.points||1)*(!0===r[i.id]),s[i.id]=s[i.id]??a[i.id];let u=i.points;const p=span({id:i.id,style:{display:"flex",flexDirection:"column",minHeight:"50px"}}),m=input({type:"number",style:{width:"40px",color:s[i.id]===a[i.id]?"black":"purple",border:void 0===s[i.id]?"3px solid red":""},min:0,value:s[i.id],events:{change:e=>{let n=e.target.value;e.target.style.color=Number(n)>u?"red":n==a[i.id]?"black":"purple",s[i.id]=""==n?void 0:Number(n),d.innerHTML="Final Score:"+Object.values(s).reduce(((e,i)=>e+(i||0)),0),e.target.value!=c[i.id]?m.classList.add("question-changed"):m.classList.remove("question-changed")}}},p);s[i.id]!=c[i.id]&&m.classList.add("question-changed");const f=newEl({style:{alignItems:"center"}},p);if(newEl({tag:"i",className:"icon-btn fa-solid fa-check grayscale",events:{click:e=>{m.input.value=Number(u),m.input.dispatchEvent(new Event("change"))}}},f),newEl({tag:"i",className:"icon-btn fa-solid fa-xmark grayscale",events:{click:e=>{m.input.value=0,m.input.dispatchEvent(new Event("change"))}}},f),e){const e=newEl({class:"grader-student-answer"}),s=isArr(o[i.id]?.a)?o[i.id].a.join("\n"):o[i.id]?.a||"";span({innerText:s,onclick:e=>copyToClipboard(e.target.innerText)},e),"python"==i.language&&button({innerText:"▶",class:"small",onclick:e=>{console.log(`code: ${s};;`);const i=popup("","","","Dismiss");i.main.className="code-output",runPython(s,i.main),console.log(i.main)}},e),o[i.id]?.out&&o[i.id].out.forEach(((n,t)=>{span({innerText:n},e),o[i.id]?.passed&&span({innerText:o[i.id].passed[t]?"✔️ Unit test passed.":"❌ Unit test failed.",class:"small"},e)})),l.addRow([i.id,i.category,(i.points||1).toFixed(1),span({innerHTML:i.prompt,events:{click:e=>{let t=popup("","",null,"Dismiss");showQuestion(t.main,i,i.id,c,n[i.id])}}}),span({innerHTML:null==n[i.id]?"":n[i.id].filter((e=>!1!==e)).map((e=>`<div style='border-bottom:solid 1px gray'>${(e.A||[e]).map((e=>isStr(e)||isNum(e)?e:e.re?rrToHTML(reToRr(e.re)):JSON.stringify(e,null,2))).join("\n")}</div>`)).join(""),style:{color:"green",whiteSpace:"pre",fontFamily:"monospace"}}),e,!0===r[i.id]?'<i class="icon-btn fa-solid fa-check"></i>':!1===r[i.id]?'<i class="icon-btn fa-solid fa-xmark"></i>':null===r[i.id]?'<i class="icon-btn fa-solid fa-minus"></i>':'<i class="icon-btn fa-solid fa-circle-exclamation"></i>',p],{id:t})}})),e&&l.sort(7,!1),!e)return s}export async function checkAnswers(e,i,n){const t={};for(let s of e[F.EXAM_QUESTIONS]||[])if(t[s.id]=null,n&&n[s.id]?.a&&(!isArr(n[s.id].a)||n[s.id].a.length)){if(i[s.id]&&isArr(i[s.id])&&i[s.id].length)if("MCQ"==s.category)t[s.id]=i[s.id].includes(n[s.id].a);else if("MRQ"==s.category)t[s.id]=i[s.id].some((e=>{if(e)return haveSameMembers(e.A||[e],n[s.id].a)}));else if("OEQ"==s.category)t[s.id]=i[s.id].some((e=>{if(!e)return;const i=e.A||[e];return i.length?i.every((e=>compareText(n[s.id].a,e))):void 0}));else if("CODE"==s.category){n[s.id].out=[],n[s.id].passed=[];for(let e of i[s.id]){if(!e)continue;const i=e.A||[e];let o=0;for(let e of i)if(e.run){if("py"!==e.run){t[s.id]="check";break}const{output:i,passed:r}=await runUnitTest(n[s.id].a,e);n[s.id].out.push(i),n[s.id].passed.push(r),r&&o++}else{compareText(n[s.id].a,e)&&o++}if(o===i.length){t[s.id]=!0;break}}}else"PARSONS"==s.category&&(t[s.id]=i[s.id].some((e=>{if(e)return e.A&&(e=e.A.join("\n")),reindent(e)==reindent(n[s.id].a.join("\n"))})));else t[s.id]="check";t[s.id]||(t[s.id]=!!i[s.id].includes(!1)&&"check")}return t}export function checkScore(e,i){let n=0;return(e.questions||[]).forEach((e=>{let t=e?.points||1;1==i[e.id]&&(n+=t)})),n}export async function makeGradesheet(e,i,n){const t=await checkAnswers(e,i,n[F.SUBMISSION_ANSWERS]),s={};for(let i in t)"check"!==t[i]&&(s[i]=!0===t[i]?e[F.EXAM_QUESTIONS].find((e=>e[F.EXAM_QUESTION_ID]===i)).points||1:0);return s}