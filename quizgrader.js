import{isArr,span,addElementTo,input,importStyleSheet}from"./ui/common.js";import{showQuestion}from"./showQuestions.js";import{popup}from"./ui/popup.js";import{grid}from"./ui/grid.js";import{reindent}from"./indentation.js";function countCommonElements(i,e){const n=new Set(i);let t=0;for(const i of e)n.has(i)&&t++;return t}export function quizGrader(i,e,n,t,o,s){i.innerHTML="";const a=checkAnswers(e,n,t),r={},c=JSON.stringify(t);addElementTo(i,{innerHTML:"Score:"+checkScore(e,a),className:"score"});let d=grid([],{className:"submission-table"},i);d.addRow(["QID","Category","Worth","Prompt","Correct Answer","Submission","AutoGrader","Points"],{className:"header"}),(e.questions||[]).forEach(((i,e)=>{t[i.id]?t[i.id].p=t[i.id]?.p||(i.points||1)*(!0===a[i.id]):t[i.id]={p:0},r[i.id]=(i.points||1)*(!0===a[i.id]);let o=i.points;const l=span({id:i.id,style:{display:"flex",alignItems:"start"}}),p=input({type:"number",style:{width:"40px",color:t[i.id].p===r[i.id]?"black":"purple"},min:0,value:t[i.id].p,events:{change:e=>{let n=Number(e.target.value);e.target.style.color=n>o?"red":n==r[i.id]?"black":"purple",t[i.id].p=Number(n),s&&s(JSON.stringify(t)!==c)}}},l);addElementTo(l,{tag:"i",className:"icon-btn fa-solid fa-check",events:{click:i=>{p.input.value=Number(o),p.input.dispatchEvent(new Event("change"))}}}),addElementTo(l,{tag:"i",className:"icon-btn fa-solid fa-xmark",events:{click:i=>{p.input.value=0,p.input.dispatchEvent(new Event("change"))}}}),d.addRow([i.id,i.category,(i.points||1).toFixed(1),span({innerHTML:i.prompt,events:{click:e=>{let n=popup("","",null,"Dismiss");showQuestion(n.main,i,i.id)}}}),span({innerHTML:n[i.id].map((i=>`<div style='border-bottom:solid 1px gray'>${i.A?i.A.join("\n"):i}</div>`)).join(""),style:{color:"green",whiteSpace:"pre",fontFamily:"monospace"}}),span({innerText:isArr(t[i.id]?.a)?t[i.id].a.join("\n"):t[i.id]?.a||"",style:{color:"blue",whiteSpace:"pre",fontFamily:"monospace"}}),!0===a[i.id]?'<i class="icon-btn fa-solid fa-check"></i>':!1===a[i.id]?'<i class="icon-btn fa-solid fa-xmark"></i>':null===a[i.id]?'<i class="icon-btn fa-solid fa-minus"></i>':'<i class="icon-btn fa-solid fa-circle-exclamation"></i>',l],{id:e})})),addElementTo(i,{tag:"i",className:"icon-btn fa-solid fa-file-export",events:{click:i=>{console.log("Saving:",t,a),o&&o(t)}}})}export function checkAnswers(i,e,n){const t={};return(i.questions||[]).forEach((i=>{if(t[i.id]=null,n[i.id]?.a&&(!isArr(n[i.id].a)||n[i.id].a.length)){if(!e[i.id]||isArr(e[i.id])&&0===e[i.id].length)t[i.id]="check";else if("MCQ"==i.category||"OEQ"==i.category||"CODE"==i.category){let o=n[i.id].a,s=e[i.id];i.case_sensitive||(o=o.toUpperCase(),s=s.map((i=>i?i.toUpperCase():i))),i.space_sensitive||(o=o.trim(),s=s.map((i=>i?i.trim():i))),"CODE"==i.category&&(o=reindent(o),s=s.map((i=>reindent(i)))),t[i.id]=s.includes(o)}else if("MRQ"==i.category)t[i.id]=countCommonElements(e[i.id],n[i.id].a)==e[i.id].length;else if("PARSONS"==i.category){let o=!1;e[i.id].forEach((e=>{e.A&&reindent(e.A.join("\n"))==reindent(n[i.id].a.join("\n"))&&(o=!0)})),t[i.id]=o}e[i.id].includes(!1)&&!1===t[i.id]&&(t[i.id]="check")}})),t}export function checkScore(i,e){let n=0;return(i.questions||[]).forEach((i=>{let t=i?.points||1;1==e[i.id]&&(n+=t)})),n}