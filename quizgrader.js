import{isArr,span,addElementTo,input,button}from"./ui/common.js";import{showQuestion}from"./showQuestions.js";import{popup}from"./ui/popup.js";import{grid}from"./ui/grid.js";import{reindent}from"./indentation.js";function countCommonElements(e,i){const n=new Set(e);let t=0;for(const e of i)n.has(e)&&t++;return t}export function quizGrader(e,i,n,t,o,s,a){const r=checkAnswers(i,n,t),c={};var d,l,p=JSON.parse(JSON.stringify(o));if(e&&(e.innerHTML="",addElementTo(e,{innerHTML:"Auto Score:"+checkScore(i,r),className:"score"}),d=addElementTo(e,{innerHTML:"Final Score:"+checkScore(i,r),className:"score"}),l=grid(["QID","Category","Worth","Prompt","Correct Answer","Submission","AutoGrader","Points"],[],{className:"submission-table"},e)),(i.questions||[]).forEach(((i,s)=>{c[i.id]="check"===r[i.id]?void 0:(i.points||1)*(!0===r[i.id]),o[i.id]=o[i.id]||c[i.id];let a=i.points;const m=span({id:i.id,style:{display:"flex",alignItems:"start"}}),u=input({type:"number",style:{width:"40px",color:o[i.id]===c[i.id]?"black":"purple"},min:0,value:o[i.id],events:{change:e=>{let n=e.target.value;e.target.style.color=Number(n)>a?"red":n==c[i.id]?"black":"purple",o[i.id]=""==n?void 0:Number(n),d.innerHTML="Final Score:"+Object.values(o).reduce(((e,i)=>e+(i||0)),0)}}},m);addElementTo(m,{tag:"i",className:"icon-btn fa-solid fa-check",events:{click:e=>{u.input.value=Number(a),u.input.dispatchEvent(new Event("change"))}}}),addElementTo(m,{tag:"i",className:"icon-btn fa-solid fa-xmark",events:{click:e=>{u.input.value=0,u.input.dispatchEvent(new Event("change"))}}}),e&&l.addRow([i.id,i.category,(i.points||1).toFixed(1),span({innerHTML:i.prompt,events:{click:e=>{let n=popup("","",null,"Dismiss");showQuestion(n.main,i,i.id,p)}}}),span({innerHTML:n[i.id].map((e=>`<div style='border-bottom:solid 1px gray'>${e.A?e.A.join("\n"):e}</div>`)).join(""),style:{color:"green",whiteSpace:"pre",fontFamily:"monospace"}}),span({innerText:isArr(t[i.id]?.a)?t[i.id].a.join("\n"):t[i.id]?.a||"",style:{color:"blue",whiteSpace:"pre",fontFamily:"monospace"}}),!0===r[i.id]?'<i class="icon-btn fa-solid fa-check"></i>':!1===r[i.id]?'<i class="icon-btn fa-solid fa-xmark"></i>':null===r[i.id]?'<i class="icon-btn fa-solid fa-minus"></i>':'<i class="icon-btn fa-solid fa-circle-exclamation"></i>',m],{id:s})})),e&&(addElementTo(e,{tag:"i",className:"icon-btn fa-solid fa-file-export",events:{click:e=>{console.log("Saving:",t),p=JSON.parse(JSON.stringify(t)),s&&s(o)}}}),addElementTo(e,{tag:"i",className:"icon-btn fa-solid fa-door-closed",events:{click:e=>{if(JSON.stringify(o)!==JSON.stringify(p)){const e=popup("","Changes NOT saved! Are you sure?",button({textContent:"YES",events:{click:()=>{a&&a(),e.close()}}}),"No")}else a&&a()}}})),!e)return o}export function checkAnswers(e,i,n){const t={};return(e.questions||[]).forEach((e=>{if(t[e.id]=null,n[e.id]?.a&&(!isArr(n[e.id].a)||n[e.id].a.length)){if(!i[e.id]||isArr(i[e.id])&&0===i[e.id].length)t[e.id]="check";else if("MCQ"==e.category||"OEQ"==e.category||"CODE"==e.category){let o=n[e.id].a,s=i[e.id];e.case_sensitive||(o=o.toUpperCase(),s=s.map((e=>e?e.toUpperCase():e))),e.space_sensitive||(o=o.trim(),s=s.map((e=>e?e.trim():e))),"CODE"==e.category&&(o=reindent(o),s=s.map((e=>reindent(e)))),t[e.id]=s.includes(o)}else if("MRQ"==e.category){let o=!1;i[e.id].forEach((i=>{o=countCommonElements(i.A,n[e.id].a)==i.A.length})),t[e.id]=o}else if("PARSONS"==e.category){let o=!1;i[e.id].forEach((i=>{i.A&&reindent(i.A.join("\n"))==reindent(n[e.id].a.join("\n"))&&(o=!0)})),t[e.id]=o}i[e.id].includes(!1)&&!1===t[e.id]&&(t[e.id]="check")}})),t}export function checkScore(e,i){let n=0;return(e.questions||[]).forEach((e=>{let t=e?.points||1;1==i[e.id]&&(n+=t)})),n}