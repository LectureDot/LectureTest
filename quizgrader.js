import{isArr,isStr,span,input,copyToClipboard,newEl,button}from"./ui/common.js";import{showQuestion}from"./showQuestions.js";import{popup}from"./ui/popup.js";import{grid}from"./ui/grid.js";import{reindent}from"./indentation.js";import{F}from"./schema.js";import{run as runPython,unitTest as pyUnitTest}from"./pyodide.js";function haveSameMembers(e,i){const n=new Set(e),s=new Set(i);if(n.size!==s.size)return!1;for(const e of n)if(!s.has(e))return!1;return!0}function compareText(e,i,n={ignoreCase:!0,removeNewlines:!0,removeEmptyLines:!0,reduceWhitespace:!0,trim:!0,standardizeIndent:!1}){if(n.removeNewlines&&(e=e.replace(/\n/g,"")),n.reduceWhitespace&&(e=e.replace(/(?!^)[ \t]+/gm," ")),n.standardizeIndent?e=reindent(e):n.trim&&(e=e.split("\n").map((e=>e.trim())).join("\n")),n.removeEmptyLines&&(e=e.replace(/^\s*$/gm,"")),isStr(i))return n.ignoreCase&&(i=i.toLowerCase(),e=e.toLowerCase()),n.removeNewlines&&(i=i.replace(/\n/g,"")),n.reduceWhitespace&&(i=i.replace(/(?!^)[ \t]+/gm," ")),n.standardizeIndent?i=reindent(i):n.trim&&(i=i.split("\n").map((e=>e.trim())).join("\n")),n.removeEmptyLines&&(i=i.replace(/^\s*$/gm,"")),e==i;if(i.re){let s=n.ignoreCase?"i":"";const t=new RegExp(i.re,s);return!!e.match(t)}}export async function quizGrader(e,i,n,s,t){const r=s.answers,o=await checkAnswers(i,n,r),a={},c={...t};var d,l;if(e&&(e.innerHTML="",newEl({innerHTML:"Exam Duration:"+(s.duration/6e4).toFixed(1)+"min",className:"score"},e),newEl({innerHTML:"Auto Score:"+checkScore(i,o),className:"score"},e),d=newEl({innerHTML:"Final Score:"+checkScore(i,o),className:"score"},e),l=grid(["QID","Category","Worth","Prompt","Correct Answer","Submission","AutoGrader","Points"],[],{className:"submission-table"},e)),(i.questions||[]).forEach(((i,s)=>{a[i.id]="check"===o[i.id]?void 0:(i.points||1)*(!0===o[i.id]),t[i.id]=t[i.id]??a[i.id];let p=i.points;const m=span({id:i.id,style:{display:"flex",flexDirection:"column",minHeight:"50px"}}),u=input({type:"number",style:{width:"40px",color:t[i.id]===a[i.id]?"black":"purple",border:void 0===t[i.id]?"3px solid red":""},min:0,value:t[i.id],events:{change:e=>{let n=e.target.value;e.target.style.color=Number(n)>p?"red":n==a[i.id]?"black":"purple",t[i.id]=""==n?void 0:Number(n),d.innerHTML="Final Score:"+Object.values(t).reduce(((e,i)=>e+(i||0)),0),e.target.value!=c[i.id]?u.classList.add("question-changed"):u.classList.remove("question-changed")}}},m);t[i.id]!=c[i.id]&&u.classList.add("question-changed");const f=newEl({style:{alignItems:"center"}},m);if(newEl({tag:"i",className:"icon-btn fa-solid fa-check grayscale",events:{click:e=>{u.input.value=Number(p),u.input.dispatchEvent(new Event("change"))}}},f),newEl({tag:"i",className:"icon-btn fa-solid fa-xmark grayscale",events:{click:e=>{u.input.value=0,u.input.dispatchEvent(new Event("change"))}}},f),e){const e=newEl({class:"grader-student-answer"}),t=isArr(r[i.id]?.a)?r[i.id].a.join("\n"):r[i.id]?.a||"";span({innerText:t,onclick:e=>copyToClipboard(e.target.innerText)},e),"python"==i.language&&button({innerText:"â–¶",class:"small",onclick:e=>{console.log(`code: ${t};;`);const i=popup("","","","Dismiss");i.main.className="code-output",runPython(t,i.main),console.log(i.main)}},e),r[i.id]?.out&&r[i.id].out.forEach((i=>span({innerText:i},e))),l.addRow([i.id,i.category,(i.points||1).toFixed(1),span({innerHTML:i.prompt,events:{click:e=>{let s=popup("","",null,"Dismiss");showQuestion(s.main,i,i.id,c,n[i.id])}}}),span({innerHTML:null==n[i.id]?"":n[i.id].map((e=>`<div style='border-bottom:solid 1px gray'>${e.A?e.A.map((e=>isStr(e)?e:JSON.stringify(e,null,2))).join("\n"):!1===e?"<span style='color:purple;font-size:10px'>Need to check...</span>":isStr(e)?e:JSON.stringify(e,null,2)}</div>`)).join(""),style:{color:"green",whiteSpace:"pre",fontFamily:"monospace"}}),e,!0===o[i.id]?'<i class="icon-btn fa-solid fa-check"></i>':!1===o[i.id]?'<i class="icon-btn fa-solid fa-xmark"></i>':null===o[i.id]?'<i class="icon-btn fa-solid fa-minus"></i>':'<i class="icon-btn fa-solid fa-circle-exclamation"></i>',m],{id:s})}})),e&&l.sort(7,!1),!e)return t}export async function checkAnswers(e,i,n){const s={};for(let t of e[F.EXAM_QUESTIONS]||[])if(s[t.id]=null,n&&n[t.id]?.a&&(!isArr(n[t.id].a)||n[t.id].a.length)){if(i[t.id]&&isArr(i[t.id])&&i[t.id].length)if("MCQ"==t.category)s[t.id]=i[t.id].includes(n[t.id].a);else if("MRQ"==t.category)s[t.id]=i[t.id].some((e=>{if(e)return haveSameMembers(e.A||[e],n[t.id].a)}));else if("OEQ"==t.category)s[t.id]=i[t.id].some((e=>{if(!e)return;return(e.A||[e]).every((e=>compareText(n[t.id].a,e,{ignoreCase:!t.case_sensitive,removeNewlines:!t.space_sensitive,removeEmptyLines:!t.space_sensitive,reduceWhitespace:!t.space_sensitive,trim:!t.space_sensitive,standardizeIndent:!1})))}));else if("CODE"==t.category){n[t.id].out=[],n[t.id].passed=[];for(let e of i[t.id]){if(!e)continue;const i=e.A||[e];let r=0;for(let e of i)if(e.run){if("py"!==e.run){s[t.id]="check";break}let i=await pyUnitTest(n[t.id].a,e.in,e.exec);n[t.id].out.push(i),isStr(e.out)&&i.endsWith("\n")&&!e.out.endsWith("\n")&&(e.out+="\n");const o=compareText(i,e.out,{ignoreCase:!t.case_sensitive,removeNewlines:!1,removeEmptyLines:!1,reduceWhitespace:!t.space_sensitive,trim:!t.space_sensitive,standardizeIndent:!1});n[t.id].passed.push(o),o&&r++}else{compareText(n[t.id].a,e,{ignoreCase:!t.case_sensitive,removeNewlines:!1,removeEmptyLines:!0,reduceWhitespace:!t.space_sensitive,trim:!1,standardizeIndent:!0})&&r++}if(r===i.length&&(s[t.id]=!0),s[t.id])break}}else"PARSONS"==t.category&&(s[t.id]=i[t.id].some((e=>{if(e)return e.A&&(e=e.A.join("\n")),reindent(e)==reindent(n[t.id].a.join("\n"))})));else s[t.id]="check";s[t.id]||(s[t.id]=!!i[t.id].includes(!1)&&"check")}return s}export function checkScore(e,i){let n=0;return(e.questions||[]).forEach((e=>{let s=e?.points||1;1==i[e.id]&&(n+=s)})),n}export async function makeGradesheet(e,i,n){const s=await checkAnswers(e,i,n[F.SUBMISSION_ANSWERS]),t={};for(let i in s)"check"!==s[i]&&(t[i]=!0===s[i]?e[F.EXAM_QUESTIONS].find((e=>e[F.EXAM_QUESTION_ID]===i)).points||1:0);return t}