import{isArr,span,addElementTo,importStyleSheet}from"./ui/common.js";import{showQuestion}from"./showQuestions.js";import{popup}from"./ui/popup.js";import{grid}from"./ui/grid.js";import{reindent}from"./indentation.js";function countCommonElements(e,i){const t=new Set(e);let o=0;for(const e of i)t.has(e)&&o++;return o}export function quizGrader(e,i,t,o,n,r){e.innerHTML="";const s=checkAnswers(i,t,o),d={};addElementTo(e,{innerHTML:"Score:"+checkScore(i,s),className:"score"});let a=grid([],{className:"submission-table"},e);a.addRow(["QID","Category","Worth","Prompt","Correct Answer","Submission","AutoGrader","Points","InstructorGrade","Mark Correct","Mark Wrong"],{className:"header"}),(i.questions||[]).forEach(((e,i)=>{o[e.id]?o[e.id].p=o[e.id]?.p||(e.points||1)*(!0===s[e.id]):o[e.id]={p:0},d[e.id]=(e.points||1)*(!0===s[e.id]),a.addRow([e.id,e.category,(e.points||1).toString(),e.prompt,span({innerHTML:t[e.id].map((e=>`<div style='border-bottom:solid 1px gray'>${e.A?e.A.join("\n"):e}</div>`)).join(""),style:{color:"green",whiteSpace:"pre",fontFamily:"monospace"}}),span({innerText:isArr(o[e.id]?.a)?o[e.id].a.join("\n"):o[e.id]?.a||"",style:{color:"blue",whiteSpace:"pre",fontFamily:"monospace"}}),!0===s[e.id]?'<i class="icon-btn fa-solid fa-check"></i>':!1===s[e.id]?'<i class="icon-btn fa-solid fa-xmark"></i>':null===s[e.id]?'<i class="icon-btn fa-solid fa-minus"></i>':'<i class="icon-btn fa-solid fa-circle-exclamation"></i>',o[e.id].p.toFixed(2),`<input type='number' style="width: 40px;" min="0" step="0.01" value="${o[e.id].p.toFixed(2)}"\n      style='color:${o[e.id].p===d[e.id]?"black":"purple"}'></input>`,'<i class="icon-btn fa-solid fa-check" id="correct"></i>','<i class="icon-btn fa-solid fa-xmark" id="wrong"></i>'],{id:i})})),a.querySelectorAll('input[type="number"]').forEach((e=>{["click","input"].forEach((t=>e.addEventListener(t,(e=>{let t=e.target.closest("[id]"),n=t.id,r=t.children,s=i.questions[n].points,a=Number(e.target.value).toFixed(2);r[7].innerHTML=a,r[8].children[0].value=a,r[7].style.color=a>s?"red":a==d[i.questions[n].id]?"black":"purple",r[8].children[0].style.color=a>s?"red":a==d[i.questions[n].id]?"black":"purple",o[i.questions[n].id].p=Number(a)}))))})),a.querySelectorAll("i").forEach((e=>{e.addEventListener("click",(e=>{let t=e.target.parentNode.parentNode,n=t.id,r=t.children,s=i.questions[n].points,a="correct"==e.target.id?Number(s).toFixed(2):"wrong"==e.target.id?(0).toFixed(2):r[7].innerHTML;r[7].innerHTML=a,r[8].children[0].value=a,r[7].style.color=a>s?"red":a==d[i.questions[n].id]?"black":"purple",r[8].children[0].style.color=a>s?"red":a==d[i.questions[n].id]?"black":"purple",o[i.questions[n].id].p=Number(a)}))})),a.querySelectorAll("div").forEach((e=>{e.addEventListener("click",(e=>{if(e.target.matches('input[type="number"]'))return;if(e.target.matches("i"))return;let t=e.target.closest("[id]").id,o=popup("","",null,"Dismiss");showQuestion(o.main,i.questions[t],t)}))})),addElementTo(e,{tag:"i",className:"icon-btn fa-solid fa-file-export",events:{click:e=>{console.log("Saving:",o,s),n&&n(o)}}})}export function checkAnswers(e,i,t){const o={};return(e.questions||[]).forEach((e=>{if(o[e.id]=null,t[e.id]?.a&&(!isArr(t[e.id].a)||t[e.id].a.length)){if(!i[e.id]||isArr(i[e.id])&&0===i[e.id].length)o[e.id]="check";else if("MCQ"==e.category||"OEQ"==e.category||"CODE"==e.category){let n=t[e.id].a,r=i[e.id];e.case_sensitive||(n=n.toUpperCase(),r=r.map((e=>e?e.toUpperCase():e))),e.space_sensitive||(n=n.trim(),r=r.map((e=>e?e.trim():e))),"CODE"==e.category&&(n=reindent(n),r=r.map((e=>reindent(e)))),o[e.id]=r.includes(n)}else if("MRQ"==e.category)o[e.id]=countCommonElements(i[e.id],t[e.id].a)==i[e.id].length;else if("PARSONS"==e.category){let n=!1;i[e.id].forEach((i=>{i.A&&reindent(i.A.join("\n"))==reindent(t[e.id].a.join("\n"))&&(n=!0)})),o[e.id]=n}i[e.id].includes(!1)&&!1===o[e.id]&&(o[e.id]="check")}})),o}export function checkScore(e,i){let t=0;return(e.questions||[]).forEach((e=>{let o=e?.points||1;1==i[e.id]&&(t+=o)})),t}