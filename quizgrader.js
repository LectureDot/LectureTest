import{isArr,span,addElementTo,input,button,copyToClipboard}from"./ui/common.js";import{showQuestion}from"./showQuestions.js";import{popup}from"./ui/popup.js";import{grid}from"./ui/grid.js";import{reindent}from"./indentation.js";function countCommonElements(e,i){const n=new Set(e);let t=0;for(const e of i)n.has(e)&&t++;return t}export function quizGrader(e,i,n,t,o){const s=t.answers,a=checkAnswers(i,n,s),r={},c={...o};var d,l;if(e&&(e.innerHTML="",addElementTo(e,{innerHTML:"Exam Duration:"+(t.duration/6e4).toFixed(1)+"min",className:"score"}),addElementTo(e,{innerHTML:"Auto Score:"+checkScore(i,a),className:"score"}),d=addElementTo(e,{innerHTML:"Final Score:"+checkScore(i,a),className:"score"}),l=grid(["QID","Category","Worth","Prompt","Correct Answer","Submission","AutoGrader","Points"],[],{className:"submission-table"},e)),(i.questions||[]).forEach(((i,t)=>{r[i.id]="check"===a[i.id]?void 0:(i.points||1)*(!0===a[i.id]),o[i.id]=o[i.id]??r[i.id];let p=i.points;const m=span({id:i.id,style:{display:"flex",flexDirection:"column",minHeight:"50px"}}),u=input({type:"number",style:{width:"40px",color:o[i.id]===r[i.id]?"black":"purple",border:void 0===o[i.id]?"3px solid red":""},min:0,value:o[i.id],events:{change:e=>{let n=e.target.value;e.target.style.color=Number(n)>p?"red":n==r[i.id]?"black":"purple",o[i.id]=""==n?void 0:Number(n),d.innerHTML="Final Score:"+Object.values(o).reduce(((e,i)=>e+(i||0)),0),console.log(e.target,e.target._original,e.target.value,e.target._original==e.target.value),e.target.value!=c[i.id]?u.classList.add("question-changed"):u.classList.remove("question-changed")}}},m);o[i.id]!=c[i.id]&&u.classList.add("question-changed");const g=addElementTo(m,{style:{alignItems:"center"}});addElementTo(g,{tag:"i",className:"icon-btn fa-solid fa-check bigger",events:{click:e=>{u.input.value=Number(p),u.input.dispatchEvent(new Event("change"))}}}),addElementTo(g,{tag:"i",className:"icon-btn fa-solid fa-xmark bigger",events:{click:e=>{u.input.value=0,u.input.dispatchEvent(new Event("change"))}}}),e&&l.addRow([i.id,i.category,(i.points||1).toFixed(1),span({innerHTML:i.prompt,events:{click:e=>{let t=popup("","",null,"Dismiss");showQuestion(t.main,i,i.id,c,n[i.id])}}}),span({innerHTML:n[i.id].map((e=>`<div style='border-bottom:solid 1px gray'>${e.A?e.A.join("\n"):!1===e?"<span style='color:red;font-size:10px'>CHECK!</span>":e}</div>`)).join(""),style:{color:"green",whiteSpace:"pre",fontFamily:"monospace"}}),span({innerText:isArr(s[i.id]?.a)?s[i.id].a.join("\n"):s[i.id]?.a||"",style:{color:"blue",whiteSpace:"pre",fontFamily:"monospace"},events:{click:e=>{copyToClipboard(e.target.innerText)}}}),!0===a[i.id]?'<i class="icon-btn fa-solid fa-check"></i>':!1===a[i.id]?'<i class="icon-btn fa-solid fa-xmark"></i>':null===a[i.id]?'<i class="icon-btn fa-solid fa-minus"></i>':'<i class="icon-btn fa-solid fa-circle-exclamation"></i>',m],{id:t})})),e&&l.sort(7,!1),!e)return o}export function checkAnswers(e,i,n){const t={};return(e.questions||[]).forEach((e=>{if(t[e.id]=null,n[e.id]?.a&&(!isArr(n[e.id].a)||n[e.id].a.length)){if(!i[e.id]||isArr(i[e.id])&&0===i[e.id].length)t[e.id]="check";else if("MCQ"==e.category||"OEQ"==e.category||"CODE"==e.category){let o=n[e.id].a,s=i[e.id];e.case_sensitive||(o=o.toUpperCase(),s=s.map((e=>e?e.toUpperCase():e))),e.space_sensitive||(o=o.trim(),s=s.map((e=>e?e.trim():e))),"CODE"==e.category&&(o=reindent(o),s=s.map((e=>reindent(e)))),t[e.id]=s.includes(o)}else if("MRQ"==e.category){let o=!1;i[e.id].forEach((i=>{o=countCommonElements(i.A,n[e.id].a)==i.A.length})),t[e.id]=o}else if("PARSONS"==e.category){let o=!1;i[e.id].forEach((i=>{i.A&&reindent(i.A.join("\n"))==reindent(n[e.id].a.join("\n"))&&(o=!0)})),t[e.id]=o}i[e.id].includes(!1)&&!1===t[e.id]&&(t[e.id]="check")}})),t}export function checkScore(e,i){let n=0;return(e.questions||[]).forEach((e=>{let t=e?.points||1;1==i[e.id]&&(n+=t)})),n}