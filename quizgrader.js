import{isArr,span,input,copyToClipboard,newEl}from"./ui/common.js";import{showQuestion}from"./showQuestions.js";import{popup}from"./ui/popup.js";import{grid}from"./ui/grid.js";import{reindent}from"./indentation.js";import{F}from"./schema.js";function countCommonElements(e,i){const n=new Set(e);let t=0;for(const e of i)n.has(e)&&t++;return t}export function quizGrader(e,i,n,t,o){const s=t.answers,r=checkAnswers(i,n,s),a={},c={...o};var d,l;if(e&&(e.innerHTML="",newEl({innerHTML:"Exam Duration:"+(t.duration/6e4).toFixed(1)+"min",className:"score"},e),newEl({innerHTML:"Auto Score:"+checkScore(i,r),className:"score"},e),d=newEl({innerHTML:"Final Score:"+checkScore(i,r),className:"score"},e),l=grid(["QID","Category","Worth","Prompt","Correct Answer","Submission","AutoGrader","Points"],[],{className:"submission-table"},e)),(i.questions||[]).forEach(((i,t)=>{a[i.id]="check"===r[i.id]?void 0:(i.points||1)*(!0===r[i.id]),o[i.id]=o[i.id]??a[i.id];let p=i.points;const u=span({id:i.id,style:{display:"flex",flexDirection:"column",minHeight:"50px"}}),m=input({type:"number",style:{width:"40px",color:o[i.id]===a[i.id]?"black":"purple",border:void 0===o[i.id]?"3px solid red":""},min:0,value:o[i.id],events:{change:e=>{let n=e.target.value;e.target.style.color=Number(n)>p?"red":n==a[i.id]?"black":"purple",o[i.id]=""==n?void 0:Number(n),d.innerHTML="Final Score:"+Object.values(o).reduce(((e,i)=>e+(i||0)),0),e.target.value!=c[i.id]?m.classList.add("question-changed"):m.classList.remove("question-changed")}}},u);o[i.id]!=c[i.id]&&m.classList.add("question-changed");const f=newEl({style:{alignItems:"center"}},u);newEl({tag:"i",className:"icon-btn fa-solid fa-check grayscale",events:{click:e=>{m.input.value=Number(p),m.input.dispatchEvent(new Event("change"))}}},f),newEl({tag:"i",className:"icon-btn fa-solid fa-xmark grayscale",events:{click:e=>{m.input.value=0,m.input.dispatchEvent(new Event("change"))}}},f),e&&l.addRow([i.id,i.category,(i.points||1).toFixed(1),span({innerHTML:i.prompt,events:{click:e=>{let t=popup("","",null,"Dismiss");showQuestion(t.main,i,i.id,c,n[i.id])}}}),span({innerHTML:null==n[i.id]?"":n[i.id].map((e=>`<div style='border-bottom:solid 1px gray'>${e.A?e.A.join("\n"):!1===e?"<span style='color:red;font-size:10px'>CHECK!</span>":e}</div>`)).join(""),style:{color:"green",whiteSpace:"pre",fontFamily:"monospace"}}),span({innerText:isArr(s[i.id]?.a)?s[i.id].a.join("\n"):s[i.id]?.a||"",style:{color:"blue",whiteSpace:"pre",fontFamily:"monospace"},events:{click:e=>{copyToClipboard(e.target.innerText)}}}),!0===r[i.id]?'<i class="icon-btn fa-solid fa-check"></i>':!1===r[i.id]?'<i class="icon-btn fa-solid fa-xmark"></i>':null===r[i.id]?'<i class="icon-btn fa-solid fa-minus"></i>':'<i class="icon-btn fa-solid fa-circle-exclamation"></i>',u],{id:t})})),e&&l.sort(7,!1),!e)return o}export function checkAnswers(e,i,n){const t={};return(e[F.EXAM_QUESTIONS]||[]).forEach((e=>{if(t[e.id]=null,n&&n[e.id]?.a&&(!isArr(n[e.id].a)||n[e.id].a.length)){if(!i[e.id]||isArr(i[e.id])&&0===i[e.id].length)t[e.id]="check";else if("MCQ"==e.category||"OEQ"==e.category||"CODE"==e.category){let o=n[e.id].a,s=i[e.id];e.case_sensitive||(o=o.toUpperCase(),s=s.map((e=>e?e.toUpperCase():e))),e.space_sensitive||(o=o.trim(),s=s.map((e=>e?e.trim():e))),"CODE"==e.category&&(o=reindent(o),s=s.map((e=>reindent(e)))),t[e.id]=s.includes(o)}else if("MRQ"==e.category){let o=!1;i[e.id].forEach((i=>{o=countCommonElements(i.A,n[e.id].a)==i.A.length})),t[e.id]=o}else if("PARSONS"==e.category){let o=!1;i[e.id].forEach((i=>{i.A&&reindent(i.A.join("\n"))==reindent(n[e.id].a.join("\n"))&&(o=!0)})),t[e.id]=o}!1===t[e.id]&&i[e.id].includes(!1)&&(t[e.id]="check")}})),t}export function checkScore(e,i){let n=0;return(e.questions||[]).forEach((e=>{let t=e?.points||1;1==i[e.id]&&(n+=t)})),n}export function makeGradesheet(e,i,n){const t=checkAnswers(e,i,n[F.SUBMISSION_ANSWERS]),o={};for(let i in t)"check"!==t[i]&&(o[i]=!0===t[i]?e[F.EXAM_QUESTIONS].find((e=>e[F.EXAM_QUESTION_ID]===i)).points||1:0);return o}