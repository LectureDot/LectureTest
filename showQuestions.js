import{marked}from"https://cdn.jsdelivr.net/npm/marked/lib/marked.esm.js";import{showParsons}from"./parsons.js";import{confirmPopup,popup}from"./ui/popup.js";import{importStyleSheet,newEl,button,input,span,isStr,isArr}from"./ui/common.js";import{reset,run}from"./util/pyodide.js";import{toast,toastSuccess}from"./ui/toast.js";import{runUnitTest}from"./util/unitTest.js";import{codeEditor}from"./ui/editor/editor.js";import{F}from"./schema.js";importStyleSheet("./showQuestions.css",import.meta.url);const startTime=Date.now();export function showQuestions(e,t,n,s){var i=e.questions;Array.isArray(i)||(i=Object.values(i)),"RAND"!=e.category&&"category"in e||(i.sort((()=>Math.random()-.5)),e.select&&e.select<i.length&&(i=i.slice(0,e.select)));const a=newEl({className:"question-cards-container"},n);let o;i.forEach(((e,n)=>{showQuestion(a,e,n,t,null,(e=>{document.getElementById(e)?.classList.remove("missing-answer")}))}));const r=i.length>1&&e[F.EXAM_ONE_AT_A_TIME],l=r&&e[F.EXAM_DISABLE_BACKTRACK];if(r){let d,m,p,h=0;const g=document.querySelectorAll(".question-card"),w=newEl({class:"question-pager"},a),x=newEl({class:"question-pager-current-question"},w);let f;function c(){g.forEach(((e,t)=>{e.style.display=t!==h?"none":""})),x.innerText=`Displaying question ${h+1} of ${i.length}.`,p.input.value=h,d&&(d.disabled=0===h),m.disabled=h===i.length-1,m.disabled&&(o&&(o.style.display=""),l&&(m.style.display="none"))}p=input({type:"range",labelClass:"question-pager-slider",min:0,max:i.length-1,disabled:!0},w),l||(d=button({innerText:"Previous",class:"question-pager-prev-btn",disabled:!0,onclick:e=>{h--,c()}},w),p.input.disabled=!1,p.input.oninput=e=>{h=Number(e.target.value),c()}),m=button({innerText:"Next",class:"question-pager-next-btn",onclick:e=>{l&&!f?(f=!0,confirmPopup("",["This exam prohibits backtracking.","<b>You will not be able to come back to a question after you hit Next.</b>","<p>Are you sure you want to continue?</p>",span({innerText:"Note: This popup will not be shown again.",class:"small"})],"Next question",(()=>{h++,c()}),"Cancel")):(h++,c())}},w),c()}function u(){toast("Submitting answers..."),cleanUp(t,e);s(t,startTime)?toastSuccess("Answers submitted."):o&&(o.disabled=!1)}s&&(o=button({innerText:"Submit Exam",onclick:e=>{if(o.disabled=!0,l)return void u();let n=Object.keys(t).filter((e=>!t[e].a.length));const s=n.length?`You are missing answers to ${n.length} question(s)! Are you sure you want to submit an incomplete exam?`:"Are you sure you are ready to submit this exam?";confirmPopup("",s,"Submit",(e=>{e.target.disabled=!0,u()}),"Cancel",(()=>{document.querySelectorAll(".question-card").forEach((e=>{n.includes(e.id)?e.classList.add("missing-answer"):e.classList.remove("missing-answer")})),o.disabled=!1}))}},a),r&&(o.style.display="none"))}export function showQuestion(e,t,n,s,i,a){s[t.id]={a:[],i:n};const o=newEl({id:t.id,className:"question-card"},e),r=newEl({className:"cell"},o),l=newEl({className:"cell"},o);newEl({tag:"h5",className:"question-card-title",innerText:t.title||""},r),t.stimulus&&newEl({innerHTML:t.stimulus?marked.parse(t.stimulus.replace(/\n/g,"  \n")):""},r),newEl({innerHTML:t.prompt?marked.parse(t.prompt.replace(/\n/g,"  \n")):""},r);const c=newEl({className:"choices-container"},l);if(newEl({tag:"p",className:"question-card-points",innerText:`Points: ${(t?.points||1).toFixed(1)}`},r),"PARSONS"==t.category){newEl({className:"question-instructions",innerText:"Drag a line of code from left column to right column to add. Drag from right to left to remove a line of code. "+(t.max_levels?"Use the arrow buttons to indent or de-indent code.":"")},c),t.ordered||t.choices.sort((()=>Math.random()-.5)),l.classList.add("span-2");const e=newEl({style:{display:"grid",gridTemplateColumns:"1fr 1fr"}},c);showParsons(e,e,t.choices,t.choice_reuse,(e=>{s[t.id].a=e,s[t.id].s=Math.round((Date.now()-startTime)/100)/10,a&&a(t.id,s[t.id])}),t.max_levels||0)}else if("OEQ"==t.category)if(newEl({className:"question-instructions",innerText:"Enter your answer below:"},c),i&&!isStr(i)){const e=codeEditor({lang:"reread",lineNumbers:!1},c);e.cm.fromRe(i.re||""),e.on("change",(n=>{a&&a(t.id,{a:e.cm.toRe()})}))}else 1==t.max_lines?newEl({tag:"input",type:"text",size:50,value:i||"",maxLength:t.max_length||1e3,events:{input:e=>{s[t.id].a=e.target.value,s[t.id].s=Math.round((Date.now()-startTime)/100)/10,a&&a(t.id,s[t.id])}}},c):newEl({tag:"textarea",rows:t.max_lines||10,cols:50,maxLength:t.max_length||1e3,value:i||"",events:{input:e=>{s[t.id].a=e.target.value,s[t.id].s=Math.round((Date.now()-startTime)/100)/10,a&&a(t.id,s[t.id])}}},c);else if("NRQ"==t.category)newEl({className:"question-instructions",innerText:"Enter your answer below:"},c),newEl({tag:"input",type:"number",size:50,value:i||"",maxLength:t.max_length||100,events:{input:e=>{s[t.id].a=e.target.value,s[t.id].s=Math.round((Date.now()-startTime)/100)/10,a&&a(t.id,s[t.id])}}},c);else if("MRQ"==t.category)newEl({className:"question-instructions",innerText:"Choose one or more from the choices below:"},c),t.ordered||t.choices.sort((()=>Math.random()-.5)),t.choices.forEach((e=>{const n=newEl({tag:"label"},c);i&&i.forEach(((n,i)=>{n!==e?.id&&n!==e||s[t.id].a.push(n)})),newEl({tag:"input",type:"checkbox",value:e?.id||e,checked:i?.includes(e?.id||e)??!1,events:{change:e=>{e.target.checked?(s[t.id].a.push(e.target.value),s[t.id].s=Math.round((Date.now()-startTime)/100)/10,a&&a(t.id,s[t.id])):(s[t.id].a=s[t.id].a.filter((t=>t!==e.target.value)),s[t.id].s=Math.round((Date.now()-startTime)/100)/10,a&&a(t.id,s[t.id]))}}},n),newEl({tag:"span",innerHTML:marked.parse((e?.content||e).replace(/\n/g,"  \n"))},n),newEl({tag:"br"},c)}));else if("MCQ"==t.category)newEl({className:"question-instructions",innerText:"Choose one from the choices below:"},c),t.ordered||t.choices.sort((()=>Math.random()-.5)),t.choices.forEach((e=>{const o=newEl({tag:"label"},c),r=newEl({tag:"input",type:"radio",value:e?.id||e,name:`question-${n}`,events:{change:e=>{s[t.id].a=e.target.value,s[t.id].s=Math.round((Date.now()-startTime)/100)/10,a&&a(t.id,s[t.id])}}},o);void 0===i||i!==e?.id&&i!==e||(r.checked=!0),newEl({tag:"span",innerHTML:marked.parse((e?.content||e).replace(/\n/g,"  \n"))},o),newEl({tag:"br"},c)}));else if("CODE"==t.category){newEl({className:"question-instructions",innerText:"Type your answer in the editor below:"},c);const e=codeEditor({lineNumbers:!0,lang:t.language||"text",theme:"default",tabSize:2,smartIndent:!0,insertSoftTab:!0,value:i||t.answerTemplate||""},c),n=newEl({class:"editor-controls small flex-row",style:{margin:"3px"}},c);let o,r;if(button({innerText:"?",title:"Show keyboard shortcuts.",class:"small",onclick:async()=>{popup("Keyboard Shortcuts",["Copy - [Ctrl+C]","Cut - [Ctrl+X]","Paste - [Ctrl+V]","Undo - [Ctrl+Z]","Redo - [Ctrl+Shift+Z]","Indent - [Tab]","Dedent - [Shift+Tab]","Comment/Uncomment - [Ctrl+/]"],null,"OK")}},n),button({innerText:"Reset",title:"Reset answer.",class:"small",style:{marginRight:"1em"},onclick:async()=>{confirmPopup(null,"Are you sure you want to reset your answer?","Reset",(()=>{e.value=i||t.answerTemplate||"",o&&(o.innerText=""),r&&(r.innerText="")}),"Cancel")}},n),t.run&&"python"===t.language){o=newEl({class:"small"},c),r=newEl({class:"code-output"},c);let e,i=t.runtime_limit||10;button({innerText:"⌛",title:"Set timeout for code execution.",class:"small",onclick:async()=>{popup("",[input({type:"number",htmlBefore:"Timeout after",htmlAfter:"seconds if there are no interactions.",min:"1",max:"300",value:i,oninput:e=>i=Number(e.target.value)||10})],null,"OK")}},n);const a=button({innerText:"▶ Run",title:"Run code.",class:"small",onclick:async()=>{if(e)o.innerText="Restarting...",reset(),o.innerText="",e=!1,a.innerText="▶ Run";else{a.innerText="■ Stop",o.innerText="Executing code...";const n=((t.codePrefix||"")+"\n"+(s[t.id].a||"")+"\n"+(t.codePostfix||"")).trim();e=run(n,r,{maxOutput:t.max_output||1e3,maxTime:i,addAwaitToEveryInput:t.await_input??!0,filename:"main.py"});const l=await e;!0===l?o.innerText="Code executed. "+(r.innerText?"Output shown below.":"No output."):isStr(l)?o.innerText=l:o.innerText="Code execution failed. Try again.",e=!1,a.innerText="▶ Run"}}},n);isArr(t.unit_tests)&&t.unit_tests.length&&button({innerText:"✔️ Test",class:"small",title:"Unit Tests: Check if code runs as expected...",onclick:async()=>{o.innerText="Testing...";const e=((t.codePrefix||"")+"\n"+(s[t.id].a||"")+"\n"+(t.codePostfix||"")).trim();let n=0;for(let s of t.unit_tests){const{passed:t}=e?await runUnitTest(e,s):{};o.innerText+=t?"✔️":"❌",n+=t}n===t.unit_tests.length?o.innerText+=" passed.":o.innerText+=" failed."}},n)}else span({innerText:`[ ${t.language||"text"} ]`,class:"small"},n);s[t.id].a=e.value,e.on("change",(n=>{s[t.id].a=e.value,s[t.id].s=Math.round((Date.now()-startTime)/100)/10,a&&a(t.id,s[t.id])}))}return o}export function cleanUp(e,t){Object.keys(e).forEach((n=>{e[n]&&"object"==typeof e[n]&&("ORD"==t.category&&delete e[n].i,Array.isArray(e[n].a)&&0===e[n].a.length&&delete e[n].a,0===Object.keys(e[n]).length&&delete e[n])}))}