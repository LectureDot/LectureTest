import{marked}from"https://cdn.jsdelivr.net/npm/marked/lib/marked.esm.js";import{showParsons}from"./parsons.js";import{popup}from"./ui/popup.js";import{newEl,importStyleSheet,button,span}from"./ui/common.js";import loadIDE from"./pyodide.js";import"https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/codemirror.min.js";import"https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/mode/javascript/javascript.min.js";import"https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/mode/python/python.min.js";import"https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/mode/xml/xml.min.js";import"https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/mode/css/css.min.js";import"https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/mode/markdown/markdown.min.js";import styles from"./questions.css"with{type:"css"};document.adoptedStyleSheets.push(styles),importStyleSheet("https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/codemirror.min.css");const startTime=Date.now();export function showQuestions(e,t,a,n){var o=e.questions;Array.isArray(o)||(o=Object.values(o)),"RAND"!=e.category&&"category"in e||(o.sort((()=>Math.random()-.5)),e.select&&e.select<o.length&&(o=o.slice(0,e.select))),a.className="questions-container";const r=newEl({className:"card-container"},a);function s(){cleanUp(t,e),n&&n(t,startTime)}o.forEach(((e,a)=>{showQuestion(r,e,a,t,null)})),newEl({tag:"button",className:"button",innerText:"Submit Answers",events:{click:e=>{let a=Object.keys(t).filter((e=>!t[e].a.length));if(a.length){const e=popup("",`You are missing answers to ${a.length} questions! Are you sure you want to submit an incomplete exam?`,button({textContent:"Submit Anyway",events:{click:()=>{s(),e.close()}}}),"Continue Exam",(()=>{document.querySelectorAll(".card").forEach((e=>{a.includes(e.id)?e.classList.add("missing-answer"):e.classList.remove("missing-answer")}))}))}else s()}}},r)}export function showQuestion(e,t,a,n,o,r){n[t.id]={a:[],i:a};const s=newEl({id:t.id,className:"card"},e),i=newEl({className:"cell"},s),l=newEl({className:"cell"},s);newEl({tag:"h5",className:"card-title",innerText:t.title},i),newEl({innerHTML:t.stimulus?marked.parse(t.stimulus.replace(/\n/g,"  \n")):""},i),newEl({innerHTML:t.prompt?marked.parse(t.prompt.replace(/\n/g,"  \n")):""},i);const c=newEl({className:"choices-container"},l);if(newEl({tag:"p",className:"card-points",innerText:`Points: ${(t?.points||1).toFixed(1)}`},i),"PARSONS"==t.category){newEl({className:"question-instructions",innerText:"Drag a line of code from left column to right column to add. Drag from right to left to remove a line of code. "+(t.max_levels?"Use the arrow buttons to indent or de-indent code.":"")},c),t.ordered||t.choices.sort((()=>Math.random()-.5)),l.classList.add("span-2");const e=newEl({style:{display:"grid",gridTemplateColumns:"1fr 1fr"}},c);showParsons(e,e,t.choices,t.choice_reuse,(e=>{n[t.id].a=e,n[t.id].s=Math.round((Date.now()-startTime)/100)/10,r&&r(t.id,n[t.id])}),t.max_levels||0)}else if("OEQ"==t.category||"SEQ"==t.category)newEl({className:"question-instructions",innerText:"Enter your answer below:"},c),1==t.max_lines?newEl({tag:"input",type:"text",size:50,value:o?.join("\n")||"",maxLength:t.max_length||1e3,events:{input:e=>{n[t.id].a=e.target.value,n[t.id].s=Math.round((Date.now()-startTime)/100)/10,r&&r(t.id,n[t.id])}}},c):newEl({tag:"textarea",rows:t.max_lines||10,cols:50,maxLength:t.max_length||1e3,value:o?.join("\n")||"",events:{input:e=>{n[t.id].a=e.target.value,n[t.id].s=Math.round((Date.now()-startTime)/100)/10,r&&r(t.id,n[t.id])}}},c);else if("NRQ"==t.category)newEl({className:"question-instructions",innerText:"Enter your answer below:"},c),newEl({tag:"input",type:"number",size:50,maxLength:t.max_length||100,events:{input:e=>{n[t.id].a=e.target.value,n[t.id].s=Math.round((Date.now()-startTime)/100)/10,r&&r(t.id,n[t.id])}}},c);else if("MRQ"==t.category)newEl({className:"question-instructions",innerText:"Choose one or more from the choices below:"},c),t.ordered||t.choices.sort((()=>Math.random()-.5)),t.choices.forEach((e=>{const a=newEl({tag:"label"},c);o?.[0]?.A?.forEach(((a,o)=>{a!==e?.id&&a!==e||n[t.id].a.push(a)})),newEl({tag:"input",type:"checkbox",value:e?.id||e,checked:o?.[0]?.A?.includes(e?.id||e)??!1,events:{change:e=>{e.target.checked?(n[t.id].a.push(e.target.value),n[t.id].s=Math.round((Date.now()-startTime)/100)/10,r&&r(t.id,n[t.id])):(n[t.id].a=n[t.id].a.filter((t=>t!==e.target.value)),n[t.id].s=Math.round((Date.now()-startTime)/100)/10,r&&r(t.id,n[t.id]))}}},a),newEl({tag:"span",innerHTML:marked.parse((e?.content||e).replace(/\n/g,"  \n"))},a),newEl({tag:"br"},c)}));else if("MCQ"==t.category)Array.isArray(o)&&(o=o[0]),newEl({className:"question-instructions",innerText:"Choose one from the choices below:"},c),t.ordered||t.choices.sort((()=>Math.random()-.5)),t.choices.forEach((e=>{const s=newEl({tag:"label"},c),i=newEl({tag:"input",type:"radio",value:e?.id||e,name:`question-${a}`,events:{change:e=>{n[t.id].a=e.target.value,n[t.id].s=Math.round((Date.now()-startTime)/100)/10,r&&r(t.id,n[t.id])}}},s);void 0===o||o!==e?.id&&o!==e||(i.checked=!0),newEl({tag:"span",innerHTML:marked.parse((e?.content||e).replace(/\n/g,"  \n"))},s),newEl({tag:"br"},c)}));else if("CODE"==t.category){newEl({className:"question-instructions",innerText:"Type your answer in the editor below:"},c);var d=newEl({tag:"textarea",id:"editor"},c);const e=newEl({class:"small flex-row",style:{margin:"3px"}},c);if(t.run&&"python"===t.language){var u;const a=span({},e),o=newEl({class:"code-output"},c),r=button({innerText:"â–¶ Run Code",class:"small",onclick:async()=>{a.innerText="Running code...",console.log(n[t.id].a),await u.run(n[t.id].a||""),a.innerText="Code executed. "+(u.getOutput()?"Output shown below.":"No output.")}},e);u||(r.disabled=!0,a.innerText="Loading Python kernel...",setTimeout((async()=>{u=await loadIDE(o),n[t.id].a=u.getOutput(),a.innerText="Ready to run code.",r.disabled=!1}),100)),e.appendChild(a)}else span({innerText:`[ ${t.language||"text/plain"} ]`,class:"small"},e);setTimeout((e=>{const a=CodeMirror.fromTextArea(d,{lineNumbers:!0,mode:t.language||"text/plain",theme:"default",tabSize:4,smartIndent:!0,insertSoftTab:!0});o?a.setValue(o.join("\n")):a.setValue(""),a.on("change",(e=>{const o=a.getValue().replaceAll("\t","    ");n[t.id].a=o,n[t.id].s=Math.round((Date.now()-startTime)/100)/10,r&&r(t.id,n[t.id])}))}),100)}return document.querySelectorAll("input, textarea").forEach((e=>{e.setAttribute("autocomplete","off"),e.setAttribute("autocorrect","off"),e.setAttribute("spellcheck","false"),e.setAttribute("autocapitalize","off"),e.setAttribute("data-gramm","false"),e.setAttribute("data-gramm_editor","false"),e.setAttribute("data-enable-grammarly","false"),e.setAttribute("aria-autocomplete","none"),e.setAttribute("aria-multiline","false"),e.setAttribute("data-lpignore","true"),e.setAttribute("data-form-type","other"),e.setAttribute("data-autocompleted","false")})),document.addEventListener("paste",(e=>{e.preventDefault()})),document.querySelectorAll("input[type='text'], textarea").forEach((e=>{e.classList.contains("CodeMirror")||e.closest(".CodeMirror")||(e.setAttribute("readonly",!0),e.addEventListener("focus",(()=>e.removeAttribute("readonly"))),e.addEventListener("input",(e=>{e.isTrusted||(e.target.value="")})))})),window.CodeMirror&&(CodeMirror.defineExtension("blockAIInput",(function(){this.on("beforeChange",((e,t)=>{t.origin&&"paste"===t.origin&&t.cancel()}))})),document.querySelectorAll(".CodeMirror").forEach((e=>{let t=e.CodeMirror;t&&t.blockAIInput()}))),s}export function cleanUp(e,t){Object.keys(e).forEach((a=>{e[a]&&"object"==typeof e[a]&&("ORD"==t.category&&delete e[a].i,Array.isArray(e[a].a)&&0===e[a].a.length&&delete e[a].a,0===Object.keys(e[a]).length&&delete e[a])}))}