import{marked}from"https://cdn.jsdelivr.net/npm/marked/lib/marked.esm.js";import{showParsons}from"./parsons.js";import{popup}from"./ui/popup.js";import{el,addElementTo,show,hide,importStyleSheet,download,button}from"./ui/common.js";import{}from"https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/codemirror.min.js";import{}from"https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/mode/javascript/javascript.min.js";import{}from"https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/mode/python/python.min.js";import{}from"https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/mode/xml/xml.min.js";import{}from"https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/mode/css/css.min.js";import{}from"https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/mode/markdown/markdown.min.js";import styles from"./questions.css"with{type:"css"};document.adoptedStyleSheets.push(styles),importStyleSheet("https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/codemirror.min.css");const startTime=Date.now();export function showQuestions(e,t,o,a){var n=e.questions;Array.isArray(n)||(n=Object.values(n)),"RAND"!=e.category&&"category"in e||(n.sort((()=>Math.random()-.5)),e.select&&e.select<n.length&&(n=n.slice(0,e.select))),o.className="questions-container";const s=addElementTo(o,{className:"card-container"});function r(){cleanUp(t,e),a&&a(t,startTime)}n.forEach(((e,o)=>{showQuestion(s,e,o,t)})),addElementTo(s,{tag:"button",className:"button",innerText:"Submit Answers",events:{click:e=>{let o=Object.keys(t).filter((e=>!t[e].a.length));if(o.length){const e=popup("",`You are missing answers to ${o.length} questions! Are you sure you want to submit an incomplete exam?`,button({textContent:"Submit Anyway",events:{click:()=>{r(),e.close()}}}),"Continue Exam",(()=>{document.querySelectorAll(".card").forEach((e=>{o.includes(e.id)?e.classList.add("missing-answer"):e.classList.remove("missing-answer")}))}))}else r()}}})}export function showQuestion(e,t,o,a){a[t.id]={a:[],i:o};const n=addElementTo(e,{id:t.id,className:"card"}),s=addElementTo(n,{className:"cell"}),r=addElementTo(n,{className:"cell"});addElementTo(s,{tag:"h5",className:"card-title",innerText:t.title}),addElementTo(s,{innerHTML:t.stimulus?marked.parse(t.stimulus.replace(/\n/g,"  \n")):""}),addElementTo(s,{innerHTML:t.prompt?marked.parse(t.prompt.replace(/\n/g,"  \n")):""});const i=addElementTo(r,{className:"choices-container"});if(addElementTo(s,{tag:"p",className:"card-points",innerText:`Points: ${(t?.points||1).toFixed(1)}`}),"PARSONS"==t.category){addElementTo(i,{className:"question-instructions",innerText:"Drag a line of code from left column to right column to add. Drag from right to left to remove a line of code. "+(t.max_levels?"Use the arrow buttons to indent or de-indent code.":"")}),t.ordered||t.choices.sort((()=>Math.random()-.5)),r.classList.add("span-2");const e=addElementTo(i,{style:{display:"grid",gridTemplateColumns:"1fr 1fr"}});showParsons(e,e,t.choices,t.choice_reuse,(e=>{a[t.id].a=e,a[t.id].s=Math.round((Date.now()-startTime)/100)/10}),t.max_levels||0)}else if("OEQ"==t.category||"SEQ"==t.category)addElementTo(i,{className:"question-instructions",innerText:"Enter your answer below:"}),1==t.max_lines?addElementTo(i,{tag:"input",type:"text",size:50,maxLength:t.max_length||1e3,autocomplete:"off",events:{input:e=>{a[t.id].a=e.target.value,a[t.id].s=Math.round((Date.now()-startTime)/100)/10}}}):addElementTo(i,{tag:"textarea",rows:t.max_lines||10,cols:50,maxLength:t.max_length||1e3,autocomplete:"off",events:{input:e=>{a[t.id].a=e.target.value,a[t.id].s=Math.round((Date.now()-startTime)/100)/10}}});else if("NRQ"==t.category)console.log(t),addElementTo(i,{className:"question-instructions",innerText:"Enter your answer below:"}),addElementTo(i,{tag:"input",type:"number",size:50,maxLength:t.max_length||100,events:{input:e=>{a[t.id].a=e.target.value,a[t.id].s=Math.round((Date.now()-startTime)/100)/10}}});else if("MRQ"==t.category)addElementTo(i,{className:"question-instructions",innerText:"Choose one or more from the choices below:"}),t.ordered||t.choices.sort((()=>Math.random()-.5)),t.choices.forEach((e=>{const o=addElementTo(i,{tag:"label"});addElementTo(o,{tag:"input",type:"checkbox",value:e?.id||e,events:{change:e=>{e.target.checked?(a[t.id].a.push(e.target.value),a[t.id].s=Math.round((Date.now()-startTime)/100)/10):(a[t.id].a=a[t.id].a.filter((t=>t!==e.target.value)),a[t.id].s=Math.round((Date.now()-startTime)/100)/10)}}}),addElementTo(o,{tag:"span",innerHTML:marked.parse((e?.content||e).replace(/\n/g,"  \n"))}),addElementTo(i,{tag:"br"})}));else if("MCQ"==t.category)addElementTo(i,{className:"question-instructions",innerText:"Choose one from the choices below:"}),t.ordered||t.choices.sort((()=>Math.random()-.5)),t.choices.forEach((e=>{const n=addElementTo(i,{tag:"label"});addElementTo(n,{tag:"input",type:"radio",value:e?.id||e,name:`question-${o}`,events:{change:e=>{a[t.id].a=e.target.value,a[t.id].s=Math.round((Date.now()-startTime)/100)/10}}}),addElementTo(n,{tag:"span",innerHTML:marked.parse((e?.content||e).replace(/\n/g,"  \n"))}),addElementTo(i,{tag:"br"})}));else if("CODE"==t.category){addElementTo(i,{className:"question-instructions",innerText:"Type your answer in the editor below:"});var d=addElementTo(i,{tag:"select",id:"language"}),l=addElementTo(i,{tag:"textarea",id:"editor",autocomplete:"off"});["python","javascript","java","c_cpp"].forEach((e=>{addElementTo(d,{tag:"option",value:e,textContent:e.charAt(0).toUpperCase()+e.slice(1)})})),d.value=t?.language||"text/plain",setTimeout((e=>{const o=CodeMirror.fromTextArea(l,{lineNumbers:!0,mode:"python",theme:"default",tabSize:4,smartIndent:!0,insertSoftTab:!0});d.addEventListener("change",(()=>{const e=d.value;o.setOption("mode",e)})),o.on("change",(e=>{const n=o.getValue().replaceAll("\t","    ");a[t.id].a=n,a[t.id].s=Math.round((Date.now()-startTime)/100)/10}))}),100)}return n}export function cleanUp(e,t){Object.keys(e).forEach((o=>{e[o]&&"object"==typeof e[o]&&("ORD"==t.category&&delete e[o].i,Array.isArray(e[o].a)&&0===e[o].a.length&&delete e[o].a,0===Object.keys(e[o]).length&&delete e[o])}))}