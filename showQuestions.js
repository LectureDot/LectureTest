import{marked}from"https://cdn.jsdelivr.net/npm/marked/lib/marked.esm.js";import{showParsons}from"./parsons.js";import{popup}from"./ui/popup.js";import{newEl,importStyleSheet,button,span,isStr}from"./ui/common.js";import{reset,run}from"./pyodide.js";import{toast,toastSuccess}from"./ui/toast.js";import"https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/codemirror.min.js";import"https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/mode/javascript/javascript.min.js";import"https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/mode/python/python.min.js";import"https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/mode/xml/xml.min.js";import"https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/mode/css/css.min.js";import"https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/mode/markdown/markdown.min.js";import"https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/mode/clike/clike.min.js";import styles from"./questions.css"with{type:"css"};document.adoptedStyleSheets.push(styles),importStyleSheet("https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/codemirror.min.css");const startTime=Date.now();export function showQuestions(e,t,n,s){var a=e.questions;Array.isArray(a)||(a=Object.values(a)),"RAND"!=e.category&&"category"in e||(a.sort((()=>Math.random()-.5)),e.select&&e.select<a.length&&(a=a.slice(0,e.select))),n.className="questions-container";const o=newEl({className:"card-container"},n);let i;function r(){toast("Submitting answers..."),cleanUp(t,e);s(t,startTime)?toastSuccess("Answers submitted."):i&&(i.disabled=!1)}a.forEach(((e,n)=>{showQuestion(o,e,n,t,null,(e=>{document.getElementById(e)?.classList.remove("missing-answer")}))})),s&&(i=newEl({tag:"button",className:"button",innerText:"Submit Answers",onclick:e=>{i.disabled=!0;let n=Object.keys(t).filter((e=>!t[e].a.length));if(n.length){const e=popup("",`You are missing answers to ${n.length} question(s)! Are you sure you want to submit an incomplete exam?`,button({textContent:"Submit Anyway",onclick:t=>{t.target.disabled=!0,r(),e.close()}}),"Continue Exam",(()=>{i.disabled=!1,document.querySelectorAll(".card").forEach((e=>{n.includes(e.id)?e.classList.add("missing-answer"):e.classList.remove("missing-answer")}))}))}else r()}},o))}export function showQuestion(e,t,n,s,a,o){s[t.id]={a:[],i:n};const i=newEl({id:t.id,className:"card"},e),r=newEl({className:"cell"},i),l=newEl({className:"cell"},i);newEl({tag:"h5",className:"card-title",innerText:t.title},r),newEl({innerHTML:t.stimulus?marked.parse(t.stimulus.replace(/\n/g,"  \n")):""},r),newEl({innerHTML:t.prompt?marked.parse(t.prompt.replace(/\n/g,"  \n")):""},r);const c=newEl({className:"choices-container"},l);if(newEl({tag:"p",className:"card-points",innerText:`Points: ${(t?.points||1).toFixed(1)}`},r),"PARSONS"==t.category){newEl({className:"question-instructions",innerText:"Drag a line of code from left column to right column to add. Drag from right to left to remove a line of code. "+(t.max_levels?"Use the arrow buttons to indent or de-indent code.":"")},c),t.ordered||t.choices.sort((()=>Math.random()-.5)),l.classList.add("span-2");const e=newEl({style:{display:"grid",gridTemplateColumns:"1fr 1fr"}},c);showParsons(e,e,t.choices,t.choice_reuse,(e=>{s[t.id].a=e,s[t.id].s=Math.round((Date.now()-startTime)/100)/10,o&&o(t.id,s[t.id])}),t.max_levels||0)}else if("OEQ"==t.category)newEl({className:"question-instructions",innerText:"Enter your answer below:"},c),1==t.max_lines?newEl({tag:"input",type:"text",size:50,value:a||"",maxLength:t.max_length||1e3,events:{input:e=>{s[t.id].a=e.target.value,s[t.id].s=Math.round((Date.now()-startTime)/100)/10,o&&o(t.id,s[t.id])}}},c):newEl({tag:"textarea",rows:t.max_lines||10,cols:50,maxLength:t.max_length||1e3,value:a||"",events:{input:e=>{s[t.id].a=e.target.value,s[t.id].s=Math.round((Date.now()-startTime)/100)/10,o&&o(t.id,s[t.id])}}},c);else if("NRQ"==t.category)newEl({className:"question-instructions",innerText:"Enter your answer below:"},c),newEl({tag:"input",type:"number",size:50,value:a||"",maxLength:t.max_length||100,events:{input:e=>{s[t.id].a=e.target.value,s[t.id].s=Math.round((Date.now()-startTime)/100)/10,o&&o(t.id,s[t.id])}}},c);else if("MRQ"==t.category)newEl({className:"question-instructions",innerText:"Choose one or more from the choices below:"},c),t.ordered||t.choices.sort((()=>Math.random()-.5)),t.choices.forEach((e=>{const n=newEl({tag:"label"},c);a&&a.forEach(((n,a)=>{n!==e?.id&&n!==e||s[t.id].a.push(n)})),newEl({tag:"input",type:"checkbox",value:e?.id||e,checked:a?.includes(e?.id||e)??!1,events:{change:e=>{e.target.checked?(s[t.id].a.push(e.target.value),s[t.id].s=Math.round((Date.now()-startTime)/100)/10,o&&o(t.id,s[t.id])):(s[t.id].a=s[t.id].a.filter((t=>t!==e.target.value)),s[t.id].s=Math.round((Date.now()-startTime)/100)/10,o&&o(t.id,s[t.id]))}}},n),newEl({tag:"span",innerHTML:marked.parse((e?.content||e).replace(/\n/g,"  \n"))},n),newEl({tag:"br"},c)}));else if("MCQ"==t.category)newEl({className:"question-instructions",innerText:"Choose one from the choices below:"},c),t.ordered||t.choices.sort((()=>Math.random()-.5)),t.choices.forEach((e=>{const i=newEl({tag:"label"},c),r=newEl({tag:"input",type:"radio",value:e?.id||e,name:`question-${n}`,events:{change:e=>{s[t.id].a=e.target.value,s[t.id].s=Math.round((Date.now()-startTime)/100)/10,o&&o(t.id,s[t.id])}}},i);void 0===a||a!==e?.id&&a!==e||(r.checked=!0),newEl({tag:"span",innerHTML:marked.parse((e?.content||e).replace(/\n/g,"  \n"))},i),newEl({tag:"br"},c)}));else if("CODE"==t.category){newEl({className:"question-instructions",innerText:"Type your answer in the editor below:"},c);var d=newEl({tag:"textarea",id:"editor",value:a||""},c);const e=newEl({class:"editor-controls small flex-row",style:{margin:"3px"}},c);if(t.run&&"python"===t.language){const n=span({},e),a=newEl({class:"code-output"},c);let o;const i=button({innerText:"▶ Run Code",class:"small",onclick:async()=>{if(o)n.innerText="Restarting...",reset(),n.innerText="",o=!1,i.innerText="▶ Run Code";else{i.innerText="■ Stop",n.innerText="Executing code...",o=run(s[t.id].a||"",a,{maxOutput:t.max_output||1e3,maxTime:t.runtime_limit||10,addAwaitToEveryInput:t.await_input??!0,filename:"main.py"});const e=await o;!0===e?n.innerText="Code executed. "+(a.innerText?"Output shown below.":"No output."):isStr(e)?n.innerText=e:n.innerText="Code execution failed. Try again.",o=!1,i.innerText="▶ Run Code"}}},e);e.appendChild(n)}else span({innerText:`[ ${t.language||"text/plain"} ]`,class:"small"},e);setTimeout((e=>{const n=CodeMirror.fromTextArea(d,{lineNumbers:!0,mode:t.language||"text/plain",theme:"default",tabSize:4,smartIndent:!0,insertSoftTab:!0});a?n.setValue(a):n.setValue(""),s[t.id].a=n.getValue(),n.on("change",(e=>{const a=n.getValue().replaceAll("\t","    ");s[t.id].a=a,s[t.id].s=Math.round((Date.now()-startTime)/100)/10,o&&o(t.id,s[t.id])}))}),100)}return i}export function cleanUp(e,t){Object.keys(e).forEach((n=>{e[n]&&"object"==typeof e[n]&&("ORD"==t.category&&delete e[n].i,Array.isArray(e[n].a)&&0===e[n].a.length&&delete e[n].a,0===Object.keys(e[n]).length&&delete e[n])}))}